<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†ä¸šå¤§äº¨ V7.0ï¼šè‚¡å¸‚é£äº‘</title>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', sans-serif; padding: 10px; max-width: 600px; margin: 0 auto; line-height: 1.5; }
        .author-tag { text-align: center; font-size: 12px; color: #58a6ff; opacity: 0.7; margin: 10px 0; letter-spacing: 1px; font-weight: bold; }
        
        .header { background: #161b22; padding: 15px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 15px; position: relative;}
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; align-items: center; }
        .company-name { color: #58a6ff; font-weight: bold; font-size: 18px; border-bottom: 1px dashed #30363d; padding-bottom: 5px; display: block; text-align: center; margin-bottom: 10px;}
        
        /* çŠ¶æ€æ é¢œè‰² */
        .money { color: #e3b341; font-weight: bold; font-size: 18px; }
        .hp-bar { color: #ff7b72; font-weight: bold; font-size: 16px; }
        .rank-badge { background: #238636; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;}
        
        .panel { background: #161b22; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #30363d; }
        h3 { margin: 0 0 12px 0; color: #58a6ff; font-size: 16px; border-bottom: 1px solid #30363d; padding-bottom: 8px; display: flex; justify-content: space-between;}
        
        button { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; padding: 6px 12px; margin: 2px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;}
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        .btn-buy { background: #238636; color: white; border: none; }
        .btn-sell { background: #da3633; color: white; border: none; }
        .btn-max { background: #1f6feb; color: white; border: none; font-size: 11px; padding: 6px 8px;}
        .btn-bank { position: absolute; top: 10px; right: 10px; background: #d29922; color: #000; font-weight: bold; border:none; }
        
        /* V7.0 æ–°æŒ‰é’® */
        .btn-stock { width: 100%; background: #1f6feb; color: white; font-weight: bold; margin-bottom: 5px; padding: 10px; border: none; }
        .btn-lotto { width: 100%; background: #8e24aa; color: white; font-weight: bold; margin-bottom: 10px; padding: 10px; border: none; }

        /* è‚¡å¸‚æ³¢å½¢å›¾ SVG */
        .stock-graph { width: 100%; height: 60px; background: #000; border: 1px solid #333; margin: 5px 0; }
        .stock-up { color: #ff5252; } /* æ¶¨æ˜¯çº¢ */
        .stock-down { color: #00e676; } /* è·Œæ˜¯ç»¿ */
        
        .col-profit { color: #00e676; font-weight: bold; } 
        .col-loss { color: #ff5252; font-weight: bold; }   
        .stock-tag { font-size: 11px; background: #333; padding: 1px 4px; border-radius: 4px; color: #aaa; margin-left: 5px;}
        .limit-bar { font-size: 12px; color: #ff7b72; border: 1px solid #ff7b72; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-top: 5px;}
        
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #21262d; }
        .city-btn { width:100%; text-align:left; display:flex; justify-content:space-between; margin:5px 0; padding: 10px; align-items: center;}

        /* å¼¹çª—ç³»ç»Ÿ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: #1c2128; padding: 20px; border-radius: 12px; border: 1px solid #444; width: 85%; max-width: 400px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size:18px; color:#58a6ff; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px; }
        
        /* åˆ®åˆ®ä¹å¡ç‰‡ */
        .scratch-card { background: #333; margin: 5px 0; padding: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #555; display: flex; justify-content: space-between; align-items: center;}
        .scratch-card:hover { background: #444; }

        .log-area { height: 100px; overflow-y: auto; background: #0d1117; border: 1px solid #30363d; padding: 10px; font-size: 12px; color: #8b949e; border-radius: 6px; font-family: monospace; }
    </style>
</head>
<body>

<div class="author-tag">ä½œè€…: ATRI</div>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
        <div id="modalTitle" class="modal-title"></div>
        <div id="modalContent" style="text-align:left;font-size:14px;margin-bottom:20px;"></div>
        <div id="modalActions">
            <button onclick="closeModal()" style="width:100%">å…³é—­</button>
        </div>
    </div>
</div>

<div class="header">
    <button class="btn-bank" onclick="openBank()">ğŸ¦ é“¶è¡Œ</button>
    <span id="companyDisplay" class="company-name">æœªå‘½åä¼ä¸š</span>
    <div class="stat-row">
        <span>ğŸ“… ç¬¬ <span id="dayDisplay">1</span> å¤©</span>
        <span class="money" id="moneyDisplay">Â¥1,000</span>
    </div>
    <div class="stat-row">
        <span>ğŸ“ <span id="locDisplay" style="color:#58a6ff;">æ‘å£</span> <span id="visaDisplay"></span></span>
        <span id="hpDisplay" class="hp-bar">â¤ï¸ HP: 50/50</span>
    </div>
    <div class="stat-row" style="font-size:12px; color:#8b949e;">
        <span>ğŸ’ å®¹é‡: <span id="capDisplay">0/50</span> <span id="titleDisplay" class="rank-badge">æ‘Šè´©</span></span>
        <button onclick="upgradeCapacity()" style="font-size:11px; padding:2px 8px; background:#333;">â• æ‰©å®¹</button>
    </div>
    <div id="limitDisplayWrapper" style="display:none; text-align:center;">
        <span id="limitDisplay" class="limit-bar">ä»Šæ—¥å¤–åœ°å”®å–é¢åº¦: 0/100</span>
    </div>
</div>

<div class="panel">
    <button class="btn-stock" onclick="openStockMarket()">ğŸ“ˆ è‚¡ç¥¨äº¤æ˜“ä¸­å¿ƒ</button>
    <button class="btn-lotto" onclick="openLotto()">ğŸ° å¹¸è¿åˆ®åˆ®ä¹</button>
    
    <h3>ğŸŒ å¸‚åœº <button class="btn-rest" onclick="openRestMenu()" style="width:auto; float:right; padding:4px 10px; margin:0;">ğŸ›Œ ä¼‘æ¯/åƒé¥­</button></h3>
    <div id="marketList"></div>
    <button class="btn-max" style="width:100%; background:#3a0000; color:#ff5252; margin-top:5px;" onclick="openBlackMarket()">ğŸ’€ è¿›å…¥é»‘å¸‚</button>
</div>

<div class="panel">
    <h3>âœˆï¸ ç§»åŠ¨</h3>
    <button style="width:100%; background:#30363d; color:white; margin-bottom:10px;" onclick="goHome()">ğŸ  ç´§æ€¥å›å®¶ (é‡ç½®é¢åº¦)</button>
    <div id="cityList"></div>
</div>

<div class="panel">
    <h3>ğŸ’¾ ç³»ç»Ÿ</h3>
    <button onclick="shareAchievement()" style="background:#6f42c1; width:100%; margin-bottom:5px;">ğŸ† å¤åˆ¶æˆ˜ç»©</button>
    <button onclick="saveGame()">ä¿å­˜</button>
    <button onclick="resetGame()" style="background:#da3633; float:right;">é‡ç½®</button>
</div>

<div class="log-area" id="gameLog"></div>
<div class="author-tag">ä½œè€…: ATRI</div>

<script>
// === 1. é…ç½®æ•°æ® ===
const CITIES = [
    { name: "æ‘å£(è€å®¶)", dist: 0, reqRank: 0, isForeign: false },
    { name: "å¿åŸ", dist: 20, reqRank: 0, isForeign: false },
    { name: "çœä¼š", dist: 300, reqRank: 1, isForeign: false },
    { name: "æ¾³é—¨", dist: 1200, reqRank: 2, isForeign: false },
    { name: "æ·±åœ³", dist: 1200, reqRank: 2, isForeign: false },
    { name: "é¦–éƒ½", dist: 1500, reqRank: 3, isForeign: false },
    { name: "é¦–å°”", dist: 2000, reqRank: 4, isForeign: true },
    { name: "é¦™æ¸¯", dist: 2500, reqRank: 5, isForeign: false },
    { name: "ä¸œäº¬", dist: 3000, reqRank: 6, isForeign: true },
    { name: "è¿ªæ‹œ", dist: 6000, reqRank: 8, isForeign: true },
    { name: "çº½çº¦", dist: 12000, reqRank: 10, isForeign: true }
];

const RANKS = [
    { name: "æµåŠ¨æ‘Šè´©", cost: 0, limit: 100 },
    { name: "å°å–éƒ¨", cost: 3000, limit: 3000 },
    { name: "ä¾¿åˆ©åº—", cost: 10000, limit: 8000 },
    { name: "è¿é”å•†åº—", cost: 30000, limit: 25000 },
    { name: "å°å‹è¶…å¸‚", cost: 80000, limit: 60000 },
    { name: "å¤§å‹è¶…å¸‚", cost: 200000, limit: 150000 },
    { name: "è´¸æ˜“å…¬å¸", cost: 500000, limit: 500000 },
    { name: "è·¨å›½é›†å›¢", cost: 5000000, limit: 5000000 },
    { name: "å•†ä¸šå¸å›½", cost: 20000000, limit: 20000000 },
    { name: "ä¸–ç•Œé¦–å¯Œ", cost: 100000000, limit: 999999999 }
];

// æ­£è§„å•†å“
const GOODS = [
    { name: "åºŸæŠ¥çº¸", base: 1, vol: 0.1, reqRank: 0, stockBase: 2000 },
    { name: "å†œå¤«å±±æ³‰", base: 2, vol: 0.1, reqRank: 0, stockBase: 1000 },
    { name: "åŒæ±‡ç«è…¿", base: 5, vol: 0.2, reqRank: 0, stockBase: 800 },
    { name: "å°ç±³å……ç”µå®", base: 80, vol: 0.2, reqRank: 1, stockBase: 200 },
    { name: "Switch", base: 1800, vol: 0.3, reqRank: 2, stockBase: 50 },
    { name: "é£å¤©èŒ…å°", base: 2800, vol: 0.5, reqRank: 3, stockBase: 30 },
    { name: "RTX5090", base: 15000, vol: 0.6, reqRank: 5, stockBase: 10 },
    { name: "åŠ³åŠ›å£«", base: 80000, vol: 0.3, reqRank: 8, stockBase: 5 },
    { name: "AIèŠ¯ç‰‡", base: 200000, vol: 0.7, reqRank: 10, stockBase: 2 }
];

const BLACK_GOODS = [
    { name: "å‡çƒŸ", base: 200, risk: 5 },
    { name: "å‡é…’", base: 500, risk: 5 },
    { name: "è¿æ³•é•¿åˆ€", base: 1500, risk: 8 },
    { name: "å‡é’", base: 5000, risk: 20 },
    { name: "è¿æ³•æ°”æª", base: 8000, risk: 25 },
    { name: "æ¯’å“", base: 50000, risk: 75 }
];

// V7.0 è‚¡ç¥¨åˆå§‹é…ç½® (min/max é™åˆ¶)
const STOCKS_CONFIG = [
    { id: 0, name: "ä¼¯å…‹å¸Œå°”", base: 3000000, max: 8000000, min: 2000, vol: 0.02 }, // ç¨³å®šé«˜ä»·
    { id: 1, name: "è‹±ä¼Ÿè¾¾", base: 10000, max: 8000000, min: 2000, vol: 0.08 }, // æ³¢åŠ¨å¤§
    { id: 2, name: "è´µå·èŒ…å°", base: 20000, max: 8000000, min: 2000, vol: 0.03 }, // ç¨³å¥
    { id: 3, name: "ç‰¹æ–¯æ‹‰", base: 5000, max: 8000000, min: 2000, vol: 0.10 }, // æåº¦ä¸ç¨³å®š
    { id: 4, name: "å¯å£å¯ä¹", base: 3000, max: 8000000, min: 2000, vol: 0.01 } // å…»è€è‚¡
];

let player = {
    companyName: null, day: 1, money: 1000, cityIdx: 0, homeIdx: 0, 
    inventory: {}, marketData: {}, rankIdx: 0, capacity: 50,
    bank: {deposit:0, loan:0, loanDeadline:0}, 
    visa: {daysLeft:0, active:false},
    dailySales: 0, protection: 0, blackWarned: false, blackMarketData: {},
    // V7.0 æ–°å¢
    hp: 50, // ç”Ÿå‘½å€¼
    stockUnlocked: false, // è‚¡ç¥¨æ˜¯å¦è§£é”
    stocks: {}, // æŒä»“ { "è‹±ä¼Ÿè¾¾": {count: 10, cost: 500} }
    stockMarket: [] // è‚¡ç¥¨å®æ—¶æ•°æ® [{name, price, history[], change%}]
};

window.onload = function() {
    loadGame();
    // å…¼å®¹æ—§å­˜æ¡£
    if(typeof player.hp === 'undefined') player.hp = 50;
    if(typeof player.stockUnlocked === 'undefined') player.stockUnlocked = false;
    if(typeof player.stocks === 'undefined') player.stocks = {};
    if(typeof player.stockMarket === 'undefined') {
        player.stockMarket = STOCKS_CONFIG.map(s => ({
            name: s.name, 
            price: s.base, 
            history: [s.base, s.base, s.base, s.base, s.base, s.base, s.base], // 7å¤©å†å²
            change: 0
        }));
    }

    if (!player.companyName) {
        setTimeout(() => {
            let n = prompt("ğŸ‘‹ æ¬¢è¿è€æ¿ï¼è¯·æ³¨å†Œå…¬å¸åç§°ï¼š", "ATRIè´¸æ˜“");
            player.companyName = n || "æœªå‘½å"; render(); saveGame();
        }, 100);
    }
    if (Object.keys(player.marketData).length === 0) updateMarket(true);
    render();
};

// === æ ¸å¿ƒé€»è¾‘ ===

function updateMarket(init = false) {
    // 1. æ­£è§„å¸‚åœº
    let newM = {};
    GOODS.forEach(g => {
        if (g.reqRank <= player.rankIdx + 1) {
            let p = Math.floor(g.base * (1 + (Math.random()-0.5)*2*g.vol));
            if(p<1) p=1;
            let s = Math.floor(g.stockBase * (0.5+Math.random()));
            newM[g.name] = { price: p, stock: s };
        }
    });
    player.marketData = newM;

    // 2. é»‘å¸‚
    let newB = {};
    BLACK_GOODS.forEach(g => {
        let p = Math.floor(g.base * (1 + (Math.random()-0.5)*1.5));
        let s = Math.floor(Math.random() * 8) + 1;
        newB[g.name] = { price: p, stock: s, risk: g.risk };
    });
    player.blackMarketData = newB;

    // 3. è‚¡ç¥¨æ›´æ–° (æ‹ŸçœŸæ³¢åŠ¨ç®—æ³•)
    player.stockMarket.forEach((s, idx) => {
        let conf = STOCKS_CONFIG[idx];
        let oldPrice = s.price;
        
        // éšæœºæ³¢åŠ¨ + åŠ¨é‡å› å­ (ç®€å•çš„åŠ¨é‡æ¨¡æ‹Ÿ)
        let volatility = conf.vol;
        let changePercent = (Math.random() - 0.5) * 2 * volatility;
        
        // äº‹ä»¶å½±å“ (ç®€å•æ¨¡æ‹Ÿ)
        if (Math.random() < 0.1) changePercent += (Math.random()-0.5) * 0.1; // çªå‘æ–°é—»

        let newPrice = Math.floor(oldPrice * (1 + changePercent));
        
        // é™åˆ¶èŒƒå›´
        if (newPrice < conf.min) newPrice = conf.min;
        if (newPrice > conf.max) newPrice = conf.max;
        
        s.price = newPrice;
        s.change = ((newPrice - oldPrice) / oldPrice * 100).toFixed(2);
        
        // æ›´æ–°å†å²Kçº¿ (ä¿æŒ7å¤©)
        s.history.push(newPrice);
        if(s.history.length > 7) s.history.shift();
    });

    if(!init) triggerRandomEvent();
}

// æ¯æ—¥ç»“ç®—ï¼ˆå«ç”Ÿå‘½å€¼æ£€æŸ¥ï¼‰
function processDaily() {
    player.day++;
    if(player.hp <= 0) { // é˜²æ­¢è´Ÿè¡€æ²¡æ­»
        die(); return false; 
    }
    
    // é“¶è¡Œç»“ç®—
    if (player.bank.deposit > 0) player.bank.deposit += Math.floor(player.bank.deposit * 0.005);
    if (player.bank.loan > 0) {
        player.bank.loan += Math.floor(player.bank.loan * 0.02);
        if (player.day > player.bank.loanDeadline) {
            alert("ğŸš“ é€¾æœŸæœªè¿˜ï¼Œç ´äº§è¢«æ•ï¼");
            resetGame(); return false;
        }
    }
    // ç­¾è¯
    let curCity = CITIES[player.cityIdx];
    if (curCity.isForeign && player.cityIdx !== player.homeIdx) {
        player.visa.daysLeft--;
        if (player.visa.daysLeft <= 0) {
            alert("ğŸ›‚ ç­¾è¯è¿‡æœŸï¼Œå¼ºåˆ¶é£è¿”ï¼");
            goHome(true); return false;
        }
    }
    return true;
}

// === V7.0 ä¼‘æ¯/åƒé¥­ç³»ç»Ÿ ===
function openRestMenu() {
    let html = `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button onclick="commitRest(1)" style="padding:15px; background:#222;">
                ğŸ›µ <b>ç‚¹å¤–å–</b><br>
                <span style="color:#ff7b72">-Â¥30</span> <span style="color:#00e676">+3 HP</span>
            </button>
            <button onclick="commitRest(2)" style="padding:15px; background:#222;">
                ğŸ½ï¸ <b>å»é¤é¦†</b><br>
                <span style="color:#ff7b72">-Â¥150</span> <span style="color:#00e676">+8 HP</span>
            </button>
            <button onclick="commitRest(3)" style="padding:15px; background:#222;">
                ğŸ³ <b>è‡ªå·±åš</b><br>
                <span style="color:#ff7b72">-Â¥50</span> <span style="color:#00e676">+5 HP</span>
            </button>
            <button onclick="commitRest(4)" style="padding:15px; background:#3a0000; border-color:red;">
                ğŸ’€ <b>ç»é£Ÿä¸åƒ</b><br>
                <span style="color:#aaa">å…è´¹</span> <span style="color:#ff5252">-10 HP</span>
            </button>
        </div>
        <div style="margin-top:10px; color:#aaa; font-size:12px; text-align:center;">ç”Ÿå‘½å€¼å½’é›¶æ¸¸æˆç»“æŸ (ä¸Šé™50)</div>
    `;
    showCustomModal("ğŸ›Œ ä¼‘æ¯ä¸è¿›é£Ÿ", html);
}

function commitRest(type) {
    let cost = 0;
    let hpChange = 0;
    let msg = "";

    if (type === 1) { cost = 30; hpChange = 3; msg = "åƒäº†é¡¿é»„ç„–é¸¡ç±³é¥­"; }
    else if (type === 2) { cost = 150; hpChange = 8; msg = "å»æµ·åº•æçˆ½äº†ä¸€é¡¿"; }
    else if (type === 3) { cost = 50; hpChange = 5; msg = "è‡ªå·±ç‚’äº†ä¸¤ä¸ªèœ"; }
    else if (type === 4) { cost = 0; hpChange = -10; msg = "é¥¿ç€è‚šå­ç¡äº†ä¸€è§‰"; }

    if (player.money < cost) {
        alert("æ²¡é’±åƒé¥­äº†ï¼");
        return;
    }

    player.money -= cost;
    player.hp += hpChange;
    if (player.hp > 50) player.hp = 50;
    
    closeModal();
    
    // æ­»äº¡åˆ¤å®š
    if (player.hp <= 0) {
        die();
        return;
    }

    if (!processDaily()) return; // ç»“ç®—æ—¥æœŸ
    
    updateMarket();
    if(player.cityIdx === player.homeIdx) player.dailySales = 0;
    
    log(`ğŸ’¤ ${msg}ã€‚ç”Ÿå‘½ ${hpChange>0?'+':''}${hpChange}`);
    render(); saveGame();
}

function die() {
    alert("ğŸ’€ ä½ é¥¿æ­»äº†ï¼\n\nèº«ä½“æ˜¯é©å‘½çš„æœ¬é’±ï¼Œä¸‹è¾ˆå­è®°å¾—æŒ‰æ—¶åƒé¥­ã€‚\n\n=== GAME OVER ===");
    resetGame();
}

// === V7.0 åˆ®åˆ®ä¹ç³»ç»Ÿ ===
function openLotto() {
    let html = `
        <div class="scratch-card" onclick="playLotto(1)">
            <div>
                <div style="font-weight:bold; color:#e0e0e0">åˆ®åˆ®ä¹ï¼šå‘è´¢æ¢¦</div>
                <div style="font-size:11px; color:#888">å”®ä»·: Â¥50</div>
            </div>
            <div style="color:#e3b341">æœ€é«˜ Â¥20ä¸‡</div>
        </div>
        <div class="scratch-card" onclick="playLotto(2)">
            <div>
                <div style="font-weight:bold; color:#a371f7">åˆ®åˆ®ä¹ï¼šæš´å¯Œæµ</div>
                <div style="font-size:11px; color:#888">å”®ä»·: Â¥150</div>
            </div>
            <div style="color:#e3b341">æœ€é«˜ Â¥80ä¸‡</div>
        </div>
        <div class="scratch-card" onclick="playLotto(3)">
            <div>
                <div style="font-weight:bold; color:#ff7b72">åˆ®åˆ®ä¹ï¼šé€†å¤©æ”¹å‘½</div>
                <div style="font-size:11px; color:#888">å”®ä»·: Â¥1000</div>
            </div>
            <div style="color:#e3b341">æœ€é«˜ Â¥500ä¸‡</div>
        </div>
    `;
    showCustomModal("ğŸ° å¹¸è¿å½©ç¥¨ç«™", html);
}

function playLotto(type) {
    let cost, maxPrize, chance;
    if (type === 1) { cost = 50; maxPrize = 200000; chance = 0.005; }
    if (type === 2) { cost = 150; maxPrize = 800000; chance = 0.005; }
    if (type === 3) { cost = 1000; maxPrize = 5000000; chance = 0.008; }

    if (player.money < cost) { alert("é’±ä¸å¤Ÿï¼"); return; }
    player.money -= cost;

    let roll = Math.random();
    let win = 0;

    // å¥–æ± é€»è¾‘
    if (roll < chance) {
        win = maxPrize; // å¤´å¥–
        alert(`ğŸ‰ğŸ‰ğŸ‰ ä¸­å¤§å¥–äº†ï¼ï¼ï¼\nä½ åˆ®å‡ºäº†æœ€é«˜å¥–é‡‘ Â¥${win.toLocaleString()}ï¼`);
    } else if (roll < chance + 0.1) {
        win = cost * 2; // å°å¥–
        alert(`ğŸ˜€ è¿æ°”ä¸é”™ï¼Œä¸­äº† Â¥${win}`);
    } else if (roll < chance + 0.1 + 0.3) {
        win = cost; // å›æœ¬
        alert(`ğŸ˜ ä¿æœ¬ï¼Œä¸­äº† Â¥${win}`);
    } else {
        alert(`ğŸ’¨ è°¢è°¢æƒ é¡¾ï¼Œå•¥ä¹Ÿæ²¡æœ‰ã€‚`);
    }

    player.money += win;
    render(); saveGame();
}

// === V7.0 è‚¡ç¥¨ç³»ç»Ÿ ===
function openStockMarket() {
    if (!player.stockUnlocked) {
        if (confirm("ğŸ“ˆ å¼€é€šè‚¡ç¥¨è´¦æˆ·éœ€è¦æ”¯ä»˜ Â¥1000 æ‰‹ç»­è´¹ï¼Œæ˜¯å¦å¼€é€šï¼Ÿ")) {
            if (player.money < 1000) return alert("èµ„é‡‘ä¸è¶³");
            player.money -= 1000;
            player.stockUnlocked = true;
            alert("å¼€æˆ·æˆåŠŸï¼");
            render(); saveGame();
            openStockMarket();
        }
        return;
    }

    let html = `<div style="max-height:400px; overflow-y:auto;">`;
    
    player.stockMarket.forEach(s => {
        let hold = player.stocks[s.name] || {count: 0, cost: 0};
        
        // ç”Ÿæˆç®€æ˜“SVGæ³¢å½¢å›¾
        let points = "";
        let minH = Math.min(...s.history);
        let maxH = Math.max(...s.history);
        let diff = maxH - minH;
        if(diff === 0) diff = 1;
        
        s.history.forEach((val, idx) => {
            let x = idx * (100 / 6); // 7ä¸ªç‚¹
            let y = 60 - ((val - minH) / diff * 50 + 5); // ç•™è¾¹è·
            points += `${x},${y} `;
        });
        
        let color = s.change >= 0 ? "#ff5252" : "#00e676"; // çº¢æ¶¨ç»¿è·Œ
        let sign = s.change >= 0 ? "+" : "";

        html += `
        <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #444;">
            <div style="display:flex; justify-content:space-between;">
                <div style="font-weight:bold; font-size:16px;">${s.name}</div>
                <div style="color:${color}; font-weight:bold;">${s.price.toLocaleString()} (${sign}${s.change}%)</div>
            </div>
            
            <svg class="stock-graph">
                <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2"/>
            </svg>
            
            <div style="font-size:12px; color:#888; display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>æŒä»“: ${hold.count}è‚¡</span>
                <span>æˆæœ¬: Â¥${parseInt(hold.cost)}</span>
            </div>
            
            <div style="display:flex; gap:5px;">
                <button onclick="tradeStock('${s.name}', 1)" style="flex:1; background:#00e676; color:black; font-weight:bold;">ä¹°å…¥</button>
                <button onclick="tradeStock('${s.name}', -1)" style="flex:1; background:#ff5252; color:white; font-weight:bold;">å–å‡º</button>
            </div>
        </div>
        `;
    });
    html += `</div>`;
    
    showCustomModal("ğŸ“ˆ è¯åˆ¸äº¤æ˜“æ‰€", html);
}

function tradeStock(name, direction) {
    let stock = player.stockMarket.find(s => s.name === name);
    let hold = player.stocks[name] || {count: 0, cost: 0};
    
    let action = direction > 0 ? "ä¹°å…¥" : "å–å‡º";
    let input = prompt(`${action} ${name} (å½“å‰ä»·: Â¥${stock.price})\nè¯·è¾“å…¥æ•°é‡ï¼š`, "100");
    let amt = parseInt(input);
    if (!amt || amt <= 0) return;

    if (direction > 0) { // ä¹°
        let cost = amt * stock.price;
        if (player.money < cost) return alert("èµ„é‡‘ä¸è¶³");
        
        player.money -= cost;
        hold.cost = (hold.count * hold.cost + cost) / (hold.count + amt);
        hold.count += amt;
    } else { // å–
        if (hold.count < amt) return alert("æŒä»“ä¸è¶³");
        
        player.money += amt * stock.price;
        hold.count -= amt;
        if (hold.count === 0) hold.cost = 0;
    }
    
    player.stocks[name] = hold;
    render(); saveGame();
    openStockMarket(); // åˆ·æ–°ç•Œé¢
}

// === æ¸²æŸ“ä¸é€šç”¨é€»è¾‘ ===
function render() {
    let curCity = CITIES[player.cityIdx];
    let curRank = RANKS[player.rankIdx];
    let isHome = player.cityIdx === player.homeIdx;

    document.getElementById("companyDisplay").innerText = player.companyName || "æœªå‘½å";
    document.getElementById("dayDisplay").innerText = player.day;
    document.getElementById("moneyDisplay").innerText = "Â¥" + player.money.toLocaleString();
    
    // HP é¢œè‰²
    let hpEl = document.getElementById("hpDisplay");
    hpEl.innerText = `â¤ï¸ HP: ${player.hp}/50`;
    hpEl.style.color = player.hp <= 20 ? "#ff5252" : "#ff7b72";

    let visaText = (curCity.isForeign && !isHome) ? ` (ç­¾è¯${player.visa.daysLeft}å¤©)` : (isHome ? " (åŸºåœ°)" : "");
    document.getElementById("locDisplay").innerText = curCity.name + visaText;
    document.getElementById("titleDisplay").innerText = curRank.name;
    document.getElementById("capDisplay").innerText = getInv() + "/" + player.capacity;

    let limitBox = document.getElementById("limitDisplayWrapper");
    if (!isHome) {
        limitBox.style.display = "block";
        document.getElementById("limitDisplay").innerText = `ä»Šæ—¥å¤–åœ°é™é¢: ${player.dailySales} / ${curRank.limit}`;
    } else { limitBox.style.display = "none"; }

    let h = "";
    let visibleGoods = GOODS.filter(g => g.reqRank <= player.rankIdx + 1);
    visibleGoods.forEach(g => {
        let mk = player.marketData[g.name] || {price:g.base, stock:0};
        let inv = player.inventory[g.name] || {c:0, cost:0};
        let pClass = inv.c>0 ? (mk.price > inv.cost ? "col-profit" : "col-loss") : (mk.price > g.base ? "col-profit" : "col-loss");
        let stockHtml = mk.stock>0 ? `<span class="stock-tag">ä½™:${mk.stock}</span>` : `<span style="color:#666">âŒ</span>`;
        
        h += `<div class="item-row">
            <div style="width:35%"><b>${g.name}</b> ${stockHtml}</div>
            <div style="width:25%;text-align:center" class="${pClass}">Â¥${mk.price}</div>
            <div style="width:40%;text-align:right">
                <button class="btn-sell" onclick="trade('${g.name}',-1)">å–</button>
                <button class="btn-max" onclick="trade('${g.name}',-999)">å…¨</button>
                <button class="btn-buy" onclick="trade('${g.name}',1)" ${mk.stock<=0?'disabled':''}>ä¹°</button>
                <button class="btn-max" onclick="trade('${g.name}',999)" ${mk.stock<=0?'disabled':''}>å…¨</button>
            </div>
        </div>`;
    });
    document.getElementById("marketList").innerHTML = h;

    let ch = "";
    CITIES.forEach((c, i) => {
        if (i == player.cityIdx) return;
        if (player.rankIdx >= 5 && i <= 1) return;
        let dist = Math.abs(c.dist - curCity.dist);
        let cost = dist <= 50 ? 20 : Math.floor(dist * 1.5 + 100);
        let lock = c.reqRank > player.rankIdx;
        ch += `<div class="city-btn" style="background:#21262d;border:1px solid #30363d;">
            <div style="flex:1"><div>${c.name} ${c.isForeign?'ğŸŒ':''}</div><div style="font-size:11px;color:#666">${dist}km</div></div>
            <button onclick="travel(${i})" ${lock?'disabled':''}>${lock?'ğŸ”’':`Â¥${cost}`} å‡ºå‘</button>
        </div>`;
    });
    document.getElementById("cityList").innerHTML = ch;
}

function trade(n, amt) {
    let mk = player.marketData[n];
    if (!mk) return;
    if (!player.inventory[n]) player.inventory[n] = { c: 0, cost: 0 };
    let inv = player.inventory[n];

    if (amt === 999) { 
        let maxAfford = Math.floor(player.money / mk.price);
        let maxSpace = player.capacity - getInv();
        amt = Math.min(maxAfford, maxSpace, mk.stock);
    }
    if (amt === -999) amt = -inv.c;
    if (amt === 0) return;

    if (amt > 0) {
        if (mk.stock < amt) return log("âŒ åº“å­˜ä¸è¶³");
        if (getInv() + amt > player.capacity) return log("âŒ ä»“åº“å·²æ»¡");
        if (player.money < amt * mk.price) return log("âŒ èµ„é‡‘ä¸è¶³");
        let cost = amt * mk.price;
        inv.cost = (inv.c * inv.cost + cost) / (inv.c + amt);
        inv.c += amt;
        player.money -= cost;
        player.marketData[n].stock -= amt;
        log(`ğŸ›’ ä¹°å…¥ ${amt} ${n}`);
    } else {
        let sellAmt = Math.abs(amt);
        let totalVal = sellAmt * mk.price;
        if (player.cityIdx !== player.homeIdx) {
            let maxLimit = RANKS[player.rankIdx].limit;
            if (player.dailySales + totalVal > maxLimit) {
                return showCustomModal("ğŸš« è´¸æ˜“é™é¢", "ä»Šæ—¥å¤–åœ°é¢åº¦å·²æ»¡ï¼Œè¯·å›åŸºåœ°é‡ç½®ã€‚");
            }
            player.dailySales += totalVal;
        }
        player.money += totalVal;
        inv.c -= sellAmt;
        if (inv.c === 0) delete player.inventory[n];
        log(`ğŸ’° å–å‡º ${sellAmt} ${n}`);
    }
    render(); saveGame();
}

function travel(i) {
    let target = CITIES[i];
    let dist = Math.abs(target.dist - CITIES[player.cityIdx].dist);
    let cost = dist <= 50 ? 20 : Math.floor(dist * 1.5 + 100);
    if (player.money < cost) return log("âŒ è·¯è´¹ä¸å¤Ÿ");
    
    if(!confirm(`å» ${target.name} (Â¥${cost})?`)) return;

    if(!processDaily()) return;
    player.money -= cost;
    player.cityIdx = i;
    if (i === player.homeIdx) { player.dailySales = 0; log("ğŸ  å›å®¶ï¼Œé¢åº¦é‡ç½®ï¼"); }
    else log(`âœˆï¸ åˆ°è¾¾ ${target.name}`);
    
    updateMarket(); render(); saveGame();
}

// è¾…åŠ©å‡½æ•°
function showCustomModal(t, content) {
    document.getElementById('modalTitle').innerText = t;
    document.getElementById('modalContent').innerHTML = content;
    document.getElementById('modalActions').innerHTML = `<button onclick="closeModal()" style="width:100%">å…³é—­</button>`;
    document.getElementById('modalOverlay').style.display='flex';
}
function closeModal() { document.getElementById('modalOverlay').style.display='none'; }
function moveHome(i) {
    let cost = 3000000;
    if (player.money < cost) return alert("èµ„é‡‘ä¸è¶³");
    if (confirm(`èŠ±è´¹ Â¥${cost} ç§»æ°‘?`)) { player.money -= cost; player.homeIdx = i; player.cityIdx = i; processDaily(); render(); saveGame(); }
}
function goHome(force) {
    let t = player.homeIdx; if(player.rankIdx>=5 && t<=1) t=2;
    if(force) { player.cityIdx=t; player.visa={active:false,daysLeft:0}; player.dailySales=0; render(); saveGame(); return; }
    travel(t);
}
function upgradeCapacity() {
    let c = player.capacity * 100;
    if (player.money >= c) { player.money -= c; player.capacity += 10; render(); saveGame(); } else alert("éœ€ Â¥"+c);
}
function getInv() { 
    let t=0; for(let k in player.inventory) { if(!BLACK_GOODS.find(b=>b.name===k)) t+=player.inventory[k].c; } return t; 
}
function openBank(){
    let s = `ç°é‡‘: Â¥${player.money}\nå­˜æ¬¾: Â¥${player.bank.deposit}\næ¬ æ¬¾: Â¥${player.bank.loan}`;
    let c = prompt(s + "\n1.å­˜ 2.å– 3.è´· 4.è¿˜");
    if(c==1){let v=prompt("å­˜å¤šå°‘?");if(v<=player.money){player.money-=v;player.bank.deposit+=v*1}}
    if(c==2){let v=prompt("å–å¤šå°‘?");if(v<=player.bank.deposit){player.bank.deposit-=v;player.money+=v*1}}
    if(c==3){let v=prompt("è´·å¤šå°‘?");if(v<=player.money*5){player.money+=v*1;player.bank.loan+=v*1;player.bank.loanDeadline=player.day+30}}
    if(c==4){let v=prompt("è¿˜å¤šå°‘?");if(v<=player.money){player.money-=v;player.bank.loan-=v;if(player.bank.loan<=0)player.bank.loanDeadline=0}}
    render(); saveGame();
}
// ä¿æŒé»‘å¸‚ç­‰å‡½æ•°... (é»‘å¸‚é€»è¾‘åœ¨V6.0ä¸­å·²å­˜åœ¨ï¼Œæ­¤å¤„ç•¥å¾®ç®€åŒ–ä»¥èŠ‚çœç¯‡å¹…ï¼Œä½†åŠŸèƒ½éœ€ä¿ç•™)
function openBlackMarket() { 
    if(!player.blackWarned) { 
        if(confirm("âš ï¸ è­¦å‘Šï¼šä¹°å–è¿ç¦å“ä¼šè¢«é€®æ•å¯¼è‡´åˆ æ¡£ï¼\næ˜¯å¦è¿›å…¥ï¼Ÿ")) player.blackWarned=true; else return;
    }
    let h = ``;
    BLACK_GOODS.forEach(g=>{
        let mk=player.blackMarketData[g.name];
        h+=`<div class="item-row"><div>${g.name} <span class="stock-tag">é™©:${g.risk}%</span></div><div>Â¥${mk.price}</div>
        <div><button onclick="tradeBlack('${g.name}',1)" class="btn-buy">ä¹°</button><button onclick="tradeBlack('${g.name}',-1)" class="btn-sell">å–</button></div></div>`
    });
    showCustomModal("ğŸ’€ é»‘å¸‚", h);
}
function tradeBlack(n, amt){
    let g=BLACK_GOODS.find(x=>x.name==n);
    if(Math.random()*100 < g.risk) {
         if(player.protection==1 && Math.random()<0.05) return alert("è¢«ä¿é‡Šäº†ï¼");
         if(player.protection==2 && Math.random()<0.15) return alert("è¢«ä¿é‡Šäº†ï¼");
         alert("ğŸš“ è¢«æ•ï¼GAME OVER"); resetGame(); return;
    }
    // ç®€åŒ–äº¤æ˜“é€»è¾‘
    let mk = player.blackMarketData[n];
    if(amt>0){
         if(player.money<mk.price) return alert("æ²¡é’±");
         player.money-=mk.price; 
         if(!player.inventory[n]) player.inventory[n]={c:0}; player.inventory[n].c++;
    } else {
         if(!player.inventory[n] || player.inventory[n].c<=0) return;
         player.money+=mk.price; player.inventory[n].c--;
    }
    alert("äº¤æ˜“æˆåŠŸ"); saveGame();
}

function shareAchievement(){
    let txt=`ğŸš€ã€${player.companyName}ã€‘V7.0æˆ˜æŠ¥ï¼šèµ„äº§Â¥${(player.money+player.bank.deposit-player.bank.loan)}\nHP:${player.hp}\nä½œè€…: ATRI`;
    let i=document.createElement('textarea');i.value=txt;document.body.appendChild(i);i.select();document.execCommand('copy');document.body.removeChild(i);alert("å·²å¤åˆ¶ï¼");
}
function log(m){ let b=document.getElementById('gameLog'); b.innerHTML=`<div>${m}</div>`+b.innerHTML; }
function saveGame(){ localStorage.setItem("tycoon_v70", JSON.stringify(player)); }
function loadGame(){ let d=localStorage.getItem("tycoon_v70"); if(!d)d=localStorage.getItem("tycoon_v60"); if(d)player=JSON.parse(d); }
function resetGame(){ if(confirm("é‡æ¥?")) { localStorage.removeItem("tycoon_v70"); location.reload(); } }
function exportSave(){ document.getElementById('saveString').value = btoa(encodeURIComponent(JSON.stringify(player))); }
function importSave(){ try{player=JSON.parse(decodeURIComponent(atob(document.getElementById('saveString').value)));saveGame();render();alert("æˆåŠŸ")}catch(e){alert("æ— æ•ˆ")} }
function triggerRandomEvent() {} // ç®€åŒ–ç‰ˆäº‹ä»¶
</script>
</body>
</html>

