<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†ä¸šå¤§äº¨ V7.1ï¼šå¸å›½å´›èµ·</title>
    <style>
        :root {
            --bg: #0f1115;
            --panel: #161b22;
            --border: #30363d;
            --primary: #58a6ff;
            --green: #2ea043;
            --red: #da3633;
            --gold: #e3b341;
            --text: #c9d1d9;
            --text-dim: #8b949e;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 10px; max-width: 550px; margin: 0 auto; line-height: 1.4; padding-bottom: 50px; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .header { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .company-title { text-align: center; font-size: 18px; font-weight: 800; color: var(--primary); margin-bottom: 12px; letter-spacing: 1px; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; }
        .stat-label { color: var(--text-dim); font-size: 11px; margin-bottom: 2px; }
        .stat-val { font-weight: bold; font-size: 14px; }
        .money-val { color: var(--gold); }
        .hp-val { color: var(--red); }
        
        /* è¿›åº¦æ¡ */
        .progress-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }

        /* é¢æ¿é€šç”¨ */
        .panel { background: var(--panel); padding: 12px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; }
        .panel-head { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 8px; font-weight: bold; color: var(--primary); }
        
        /* æŒ‰é’®ç³»ç»Ÿ */
        button { border: none; outline: none; border-radius: 6px; padding: 8px 12px; font-size: 13px; font-weight: 600; cursor: pointer; transition: transform 0.1s, opacity 0.2s; color: #fff; background: #21262d; border: 1px solid var(--border); }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        
        .btn-primary { background: #1f6feb; border-color: #1f6feb; }
        .btn-success { background: var(--green); border-color: var(--green); }
        .btn-danger { background: var(--red); border-color: var(--red); }
        .btn-gold { background: var(--gold); border-color: var(--gold); color: #000; }
        .btn-purple { background: #8e24aa; border-color: #8e24aa; }
        .btn-dark { background: #000; border-color: #333; color: var(--red); }
        
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-block { width: 100%; display: block; margin-bottom: 8px; padding: 10px;}

        /* åˆ—è¡¨é¡¹ */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .list-item:last-child { border-bottom: none; }
        
        /* é¢œè‰²è¾…åŠ© */
        .text-up { color: var(--green); }
        .text-down { color: var(--red); }
        .tag { font-size: 10px; padding: 1px 4px; border-radius: 3px; margin-left: 4px; vertical-align: middle; }
        .tag-gray { background: #333; color: #aaa; }
        .tag-red { background: rgba(218, 54, 51, 0.2); color: var(--red); border: 1px solid var(--red); }

        /* === æ ¸å¿ƒï¼šè‡ªå®šä¹‰å¼¹çª—ç³»ç»Ÿ === */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-body { background: #1c2128; width: 90%; max-width: 400px; max-height: 85vh; border-radius: 16px; border: 1px solid #444; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; background: #222; }
        .modal-content { padding: 20px; overflow-y: auto; font-size: 14px; color: #ddd; }
        .modal-footer { padding: 15px; border-top: 1px solid #333; display: flex; gap: 10px; justify-content: flex-end; background: #222; }
        
        /* å¼¹çª—å†…çš„è¾“å…¥æ¡† */
        .modal-input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #fff; padding: 10px; border-radius: 8px; font-size: 16px; margin: 10px 0; outline: none; text-align: center;}
        .modal-input:focus { border-color: var(--primary); }

        /* ç‰¹æ®Šç»„ä»¶ */
        .stock-card { background: #111; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; }
        .lotto-card { background: linear-gradient(135deg, #2c1e30, #000); padding: 15px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #555; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .log-box { height: 100px; overflow-y: auto; font-size: 11px; color: #666; font-family: monospace; border-top: 1px solid #333; padding-top: 10px; margin-top: 20px; }
        .author { text-align: center; font-size: 12px; color: #333; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="gameModal" class="modal-mask">
    <div class="modal-body">
        <div class="modal-header">
            <span id="mTitle">æ ‡é¢˜</span>
        </div>
        <div class="modal-content" id="mContent"></div>
        <div class="modal-footer" id="mFooter">
            <button class="btn-primary" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>
</div>

<div class="header">
    <div class="company-title" id="uiCompany">æœªå‘½åä¼ä¸š</div>
    <div class="stat-grid">
        <div class="stat-item">
            <span class="stat-label">æ€»èµ„é‡‘</span>
            <span class="stat-val money-val" id="uiMoney">Â¥0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">ç”Ÿå‘½å€¼</span>
            <span class="stat-val hp-val" id="uiHp">50/50</span>
            <div class="progress-bar"><div class="progress-fill" id="uiHpBar" style="width:100%"></div></div>
        </div>
        <div class="stat-item">
            <span class="stat-label">å½“å‰ä½ç½®</span>
            <span class="stat-val" id="uiLoc">æ‘å£</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">ç»è¥å¤´è¡”</span>
            <span class="stat-val" style="color:var(--green)" id="uiRank">æ‘Šè´©</span>
        </div>
    </div>
    
    <button id="btnPromote" class="btn-block btn-gold" style="margin-top:10px; display:none;" onclick="promote()">
        æ™‹å‡å¤´è¡” (éœ€Â¥1000)
    </button>
    
    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:11px; color:#666;">
        <span id="uiCap">èƒŒåŒ…: 0/50</span>
        <span id="uiLimit" style="color:var(--red)"></span>
    </div>
</div>

<div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; margin-bottom:15px;">
    <button onclick="openBankUI()" style="background:#222;">ğŸ¦ é“¶è¡Œ</button>
    <button onclick="openStockUI()" style="background:#222;">ğŸ“ˆ è‚¡ç¥¨</button>
    <button onclick="openLottoUI()" style="background:#222;">ğŸ° å½©ç¥¨</button>
    <button onclick="openBlackUI()" class="btn-dark">ğŸ’€ é»‘å¸‚</button>
</div>

<div class="panel">
    <div class="panel-head">
        <span>ğŸŒ äº¤æ˜“å¸‚åœº</span>
        <div>
            <button class="btn-sm" onclick="expandCap()">â• æ‰©å®¹</button>
            <button class="btn-sm btn-primary" onclick="openRestUI()">ğŸ›Œ ä¼‘æ¯/åƒé¥­</button>
        </div>
    </div>
    <div id="marketList"></div>
</div>

<div class="panel">
    <div class="panel-head">
        <span>âœˆï¸ å·®æ—…ä¸ç§»æ°‘</span>
        <button class="btn-sm btn-danger" onclick="goHome()">ğŸ  ç´§æ€¥å›å®¶</button>
    </div>
    <div id="cityList"></div>
</div>

<div class="panel">
    <div class="panel-head">ğŸ’¾ ç³»ç»Ÿç®¡ç†</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
        <button onclick="saveGame()">ä¿å­˜è¿›åº¦</button>
        <button onclick="share()">ğŸ† ç‚«è€€æˆ˜ç»©</button>
        <button onclick="exportSave()">å¯¼å‡ºå­˜æ¡£</button>
        <button onclick="importSave()">å¯¼å…¥å­˜æ¡£</button>
    </div>
    <button class="btn-block btn-danger" style="margin-top:8px;" onclick="hardReset()">â˜ ï¸ åˆ æ¡£é‡æ¥</button>
</div>

<div class="log-box" id="gameLog"></div>
<div class="author">ä½œè€…: ATRI</div>

<script>
// === 1. æ¸¸æˆé…ç½® ===
const CONFIG = {
    RANKS: [
        { name: "æµåŠ¨æ‘Šè´©", cost: 0, limit: 100 },
        { name: "å°å–éƒ¨", cost: 3000, limit: 3000 },
        { name: "ä¾¿åˆ©åº—", cost: 10000, limit: 8000 },
        { name: "è¿é”å•†åº—", cost: 30000, limit: 25000 },
        { name: "å°å‹è¶…å¸‚", cost: 80000, limit: 60000 },
        { name: "å¤§å‹è¶…å¸‚", cost: 200000, limit: 150000 },
        { name: "è´¸æ˜“å…¬å¸", cost: 500000, limit: 500000 },
        { name: "è·¨å›½é›†å›¢", cost: 5000000, limit: 5000000 },
        { name: "å•†ä¸šå¸å›½", cost: 20000000, limit: 20000000 },
        { name: "ä¸–ç•Œé¦–å¯Œ", cost: 100000000, limit: 999999999 }
    ],
    CITIES: [
        { name: "æ‘å£(è€å®¶)", dist: 0, req: 0, foreign: false },
        { name: "å¿åŸ", dist: 20, req: 0, foreign: false },
        { name: "çœä¼š", dist: 300, req: 1, foreign: false },
        { name: "æ¾³é—¨", dist: 1200, req: 2, foreign: false },
        { name: "æ·±åœ³", dist: 1200, req: 2, foreign: false },
        { name: "é¦–éƒ½", dist: 1500, req: 3, foreign: false },
        { name: "é¦–å°”", dist: 2000, req: 4, foreign: true },
        { name: "é¦™æ¸¯", dist: 2500, req: 5, foreign: false },
        { name: "ä¸œäº¬", dist: 3000, req: 6, foreign: true },
        { name: "è¿ªæ‹œ", dist: 6000, req: 8, foreign: true },
        { name: "çº½çº¦", dist: 12000, req: 10, foreign: true }
    ],
    GOODS: [
        { n: "åºŸæŠ¥çº¸", b: 1, v: 0.1, r: 0, s: 2000 },
        { n: "å†œå¤«å±±æ³‰", b: 2, v: 0.1, r: 0, s: 1000 },
        { n: "åŒæ±‡ç«è…¿", b: 5, v: 0.2, r: 0, s: 800 },
        { n: "å°ç±³å……ç”µå®", b: 80, v: 0.2, r: 1, s: 200 },
        { n: "Switch", b: 1800, v: 0.3, r: 2, s: 50 },
        { n: "é£å¤©èŒ…å°", b: 2800, v: 0.5, r: 3, s: 30 },
        { n: "RTX5090", b: 15000, v: 0.6, r: 5, s: 10 },
        { n: "åŠ³åŠ›å£«", b: 80000, v: 0.3, r: 8, s: 5 },
        { n: "AIèŠ¯ç‰‡", b: 200000, v: 0.7, r: 10, s: 2 }
    ],
    BLACK: [
        { n: "å‡çƒŸ", b: 200, risk: 5 }, { n: "å‡é…’", b: 500, risk: 5 },
        { n: "ç®¡åˆ¶åˆ€å…·", b: 1500, risk: 8 }, { n: "å‡é’", b: 5000, risk: 20 },
        { n: "æ¯’å“", b: 50000, risk: 75 }
    ],
    STOCKS: [
        { n: "ä¼¯å…‹å¸Œå°”", b: 3000000, min: 2000, max: 8000000, v: 0.02 },
        { n: "è‹±ä¼Ÿè¾¾", b: 10000, min: 2000, max: 8000000, v: 0.08 },
        { n: "èŒ…å°è‚¡ä»½", b: 20000, min: 2000, max: 8000000, v: 0.03 },
        { n: "ç‰¹æ–¯æ‹‰", b: 5000, min: 2000, max: 8000000, v: 0.10 },
        { n: "å¯å£å¯ä¹", b: 3000, min: 2000, max: 8000000, v: 0.01 }
    ]
};

// === 2. æ¸¸æˆçŠ¶æ€ ===
let p = {
    name: null, day: 1, money: 1000, hp: 50,
    city: 0, home: 0, rank: 0, cap: 50,
    inv: {}, market: {}, 
    bank: { dep: 0, loan: 0, due: 0 },
    visa: { day: 0, on: false },
    sales: 0, // å¤–åœ°é”€å”®é¢
    black: { warn: false, mkt: {} },
    prot: 0, // ä¿æŠ¤ä¼ç­‰çº§
    stock: { open: false, port: {}, mkt: [] }
};

// === 3. åˆå§‹åŒ– ===
window.onload = () => {
    loadGame();
    if (!p.name) openNameInput();
    else initGameLogic();
};

function initGameLogic() {
    if (!p.market || Object.keys(p.market).length === 0) refreshMarket(true);
    // åˆå§‹åŒ–è‚¡ç¥¨æ•°æ®ç»“æ„
    if (!p.stock.mkt || p.stock.mkt.length === 0) {
        p.stock.mkt = CONFIG.STOCKS.map(s => ({
            n: s.n, p: s.b, hist: [s.b, s.b, s.b, s.b, s.b], chg: 0
        }));
    }
    render();
}

// === 4. æ ¸å¿ƒé€»è¾‘ ===
function refreshMarket(isInit = false) {
    // æ­£è§„å¸‚åœº
    let nm = {};
    CONFIG.GOODS.forEach(g => {
        if (g.r <= p.rank + 1) {
            let pr = Math.floor(g.b * (1 + (Math.random()-0.5)*2*g.v));
            if(pr<1) pr=1;
            let st = Math.floor(g.s * (0.5+Math.random()));
            nm[g.n] = { p: pr, s: st };
        }
    });
    p.market = nm;

    // é»‘å¸‚
    let bm = {};
    CONFIG.BLACK.forEach(g => {
        let pr = Math.floor(g.b * (1 + (Math.random()-0.5)*1.5));
        let st = Math.floor(Math.random() * 8) + 1;
        bm[g.n] = { p: pr, s: st, r: g.risk };
    });
    p.black.mkt = bm;

    // è‚¡ç¥¨
    p.stock.mkt.forEach((s, i) => {
        let conf = CONFIG.STOCKS[i];
        let old = s.p;
        let change = (Math.random()-0.5) * 2 * conf.v;
        let np = Math.floor(old * (1 + change));
        if(np < conf.min) np = conf.min;
        if(np > conf.max) np = conf.max;
        s.p = np;
        s.chg = ((np-old)/old*100).toFixed(2);
        s.hist.push(np);
        if(s.hist.length > 7) s.hist.shift();
    });

    if(!isInit) randomEvent();
}

function nextDay() {
    p.day++;
    // ç”Ÿå‘½æ£€æµ‹
    if (p.hp <= 0) return gameOver("é¥¿æ­»");
    
    // é“¶è¡Œåˆ©æ¯
    if (p.bank.dep > 0) p.bank.dep += Math.floor(p.bank.dep * 0.005);
    if (p.bank.loan > 0) {
        p.bank.loan += Math.floor(p.bank.loan * 0.02);
        if (p.day > p.bank.due) return gameOver("è´·æ¬¾é€¾æœŸè¢«æ•");
    }

    // ç­¾è¯
    let city = CONFIG.CITIES[p.city];
    if (city.foreign && p.city !== p.home) {
        p.visa.day--;
        if (p.visa.day <= 0) {
            alert("ğŸ›‚ ç­¾è¯è¿‡æœŸï¼Œå¼ºåˆ¶é£è¿”ï¼");
            goHome(true);
            return false;
        }
    }
    return true;
}

// === 5. äº¤äº’åŠŸèƒ½ (ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—) ===

// --- é“¶è¡Œ ---
function openBankUI() {
    let t = `
        <div class="stat-grid">
            <div class="stat-item"><span class="stat-label">ç°é‡‘</span><span class="money-val">Â¥${p.money}</span></div>
            <div class="stat-item"><span class="stat-label">å­˜æ¬¾ (æ—¥æ¯0.5%)</span><span style="color:var(--green)">Â¥${p.bank.dep}</span></div>
            <div class="stat-item"><span class="stat-label">è´·æ¬¾ (æ—¥æ¯2%)</span><span style="color:var(--red)">Â¥${p.bank.loan}</span></div>
            <div class="stat-item"><span class="stat-label">è¿˜æ¬¾æ—¥</span><span>${p.bank.loan>0 ? 'ç¬¬'+p.bank.due+'å¤©' : '--'}</span></div>
        </div>
        <div style="margin-top:15px; display:grid; gap:10px;">
            <input type="number" id="bankInput" class="modal-input" placeholder="è¾“å…¥é‡‘é¢">
            <div style="display:flex; gap:10px;">
                <button class="btn-block btn-success" onclick="bankOp('dep')">å­˜å…¥</button>
                <button class="btn-block btn-gold" onclick="bankOp('with')">å–å‡º</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-block btn-danger" onclick="bankOp('loan')">è´·æ¬¾</button>
                <button class="btn-block btn-primary" onclick="bankOp('pay')">è¿˜æ¬¾</button>
            </div>
        </div>
    `;
    showModal("ğŸ¦ ç‘å£«é“¶è¡Œ", t);
}

function bankOp(type) {
    let val = parseInt(document.getElementById('bankInput').value);
    if (!val || val <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
    
    if (type === 'dep') {
        if (p.money >= val) { p.money -= val; p.bank.dep += val; showToast("å­˜æ¬¾æˆåŠŸ"); }
        else showToast("ç°é‡‘ä¸è¶³");
    } else if (type === 'with') {
        if (p.bank.dep >= val) { p.bank.dep -= val; p.money += val; showToast("å–æ¬¾æˆåŠŸ"); }
        else showToast("å­˜æ¬¾ä¸è¶³");
    } else if (type === 'loan') {
        let max = p.money * 5;
        if (val > max) return showToast("ä¿¡ç”¨ä¸è¶³ï¼Œæœ€å¤šè´· Â¥" + max);
        p.money += val; p.bank.loan += val; p.bank.due = p.day + 30;
        showToast("è´·æ¬¾æˆåŠŸï¼Œ30å¤©å†…è¿˜æ¸…");
    } else if (type === 'pay') {
        if (p.money >= val) {
            let act = Math.min(val, p.bank.loan);
            p.money -= act; p.bank.loan -= act;
            if (p.bank.loan <= 0) p.bank.due = 0;
            showToast("è¿˜æ¬¾æˆåŠŸ");
        } else showToast("ç°é‡‘ä¸è¶³");
    }
    openBankUI(); render(); saveGame();
}

// --- ä¼‘æ¯/åƒé¥­ ---
function openRestUI() {
    let t = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button onclick="doRest(1)" style="padding:15px; background:#222;">
                ğŸ›µ <b>ç‚¹å¤–å–</b><br><span class="text-down">-Â¥30</span> <span class="text-up">+3 HP</span>
            </button>
            <button onclick="doRest(2)" style="padding:15px; background:#222;">
                ğŸ½ï¸ <b>å»é¤é¦†</b><br><span class="text-down">-Â¥150</span> <span class="text-up">+8 HP</span>
            </button>
            <button onclick="doRest(3)" style="padding:15px; background:#222;">
                ğŸ³ <b>è‡ªå·±åš</b><br><span class="text-down">-Â¥50</span> <span class="text-up">+5 HP</span>
            </button>
            <button onclick="doRest(4)" style="padding:15px; border-color:var(--red);">
                ğŸ’€ <b>ç»é£Ÿ</b><br><span>å…è´¹</span> <span class="text-down">-10 HP</span>
            </button>
        </div>
    `;
    showModal("ğŸ›Œ ä¼‘æ¯ä¸è¿›é£Ÿ", t);
}

function doRest(type) {
    let c = 0, h = 0;
    if(type==1){c=30;h=3} if(type==2){c=150;h=8} if(type==3){c=50;h=5} if(type==4){c=0;h=-10}
    
    if(p.money < c) return showToast("æ²¡é’±åƒé¥­ï¼");
    p.money -= c;
    p.hp = Math.min(50, p.hp + h);
    closeModal();
    
    if(!nextDay()) return;
    refreshMarket();
    if(p.city === p.home) p.sales = 0;
    
    showToast(`ä¼‘æ¯å®Œæ¯•ï¼Œç”Ÿå‘½ ${h>0?'+':''}${h}`);
    render(); saveGame();
}

// --- äº¤æ˜“ ---
function trade(n, amt) {
    let mk = p.market[n];
    if(!mk) return;
    if(!p.inv[n]) p.inv[n] = {c:0, cost:0};
    let inv = p.inv[n];

    if(amt === 999) { // å…¨ä¹°
        let maxCan = Math.floor(p.money / mk.p);
        let space = p.cap - getInvCount();
        amt = Math.min(maxCan, space, mk.s);
    }
    if(amt === -999) amt = -inv.c;
    
    if(amt === 0) return showToast("æ— æ³•äº¤æ˜“");

    if(amt > 0) { // ä¹°
        if(mk.s < amt) return showToast("åº“å­˜ä¸è¶³");
        if(getInvCount()+amt > p.cap) return showToast("èƒŒåŒ…æ»¡äº†");
        if(p.money < amt*mk.p) return showToast("é’±ä¸å¤Ÿ");
        
        let cost = amt * mk.p;
        inv.cost = (inv.c*inv.cost + cost)/(inv.c+amt);
        inv.c += amt;
        p.money -= cost;
        p.market[n].s -= amt;
        showToast(`ä¹°å…¥ ${n} x${amt}`);
    } else { // å–
        let sell = Math.abs(amt);
        if(inv.c < sell) return;
        
        let val = sell * mk.p;
        // è´¸æ˜“å£å’
        if(p.city !== p.home) {
            let limit = CONFIG.RANKS[p.rank].limit;
            if(p.sales + val > limit) {
                let left = limit - p.sales;
                return showModal("ğŸš« è´¸æ˜“é™é¢", `å¤–åœ°é™é¢å‰©ä½™ï¼š<b class="text-down">Â¥${left}</b><br>æœ¬æ¬¡äº¤æ˜“è¶…é¢ï¼<br>è¯·å›è€å®¶é‡ç½®é¢åº¦ã€‚`);
            }
            p.sales += val;
        }
        
        p.money += val;
        inv.c -= sell;
        if(inv.c === 0) delete p.inv[n];
        let prof = (mk.p - inv.cost) * sell;
        showToast(`å–å‡ºèµš Â¥${parseInt(prof)}`);
    }
    render(); saveGame();
}

// --- ç§»åŠ¨ ---
function tryTravel(idx) {
    let target = CONFIG.CITIES[idx];
    let dist = Math.abs(target.dist - CONFIG.CITIES[p.city].dist);
    let cost = dist <= 50 ? 20 : Math.floor(dist * 1.5 + 100);
    
    let html = `
        <p>ç›®çš„åœ°ï¼š<b>${target.name}</b></p>
        <p>è·ç¦»ï¼š${dist}km</p>
        <p>ç¥¨ä»·ï¼š<span class="text-down">Â¥${cost}</span></p>
    `;
    
    let vDays = 0;
    if (target.foreign && idx !== p.home) {
        vDays = Math.min(8, Math.floor(p.money/10000));
        html += `<p class="tag-red">éœ€åŠç†ç­¾è¯</p><p>èµ„äº§å¯ç­¾ï¼š${vDays}å¤© (éœ€1ä¸‡/å¤©)</p>`;
        if (vDays < 1) {
            html += `<p class="text-down"><b>èµ„äº§ä¸è¶³1ä¸‡ï¼Œæ— æ³•ç­¾è¯ï¼</b></p>`;
            showModal("âœˆï¸ å‡ºè¡Œå—é˜»", html);
            return;
        }
    }

    // å¼¹çª—ç¡®è®¤
    document.getElementById('mTitle').innerText = "âœˆï¸ å·®æ—…ç¡®è®¤";
    document.getElementById('mContent').innerHTML = html;
    document.getElementById('mFooter').innerHTML = `
        <button class="btn-dark" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="commitTravel(${idx}, ${cost}, ${vDays})">å‡ºå‘</button>
    `;
    document.getElementById('gameModal').style.display = 'flex';
}

function commitTravel(idx, cost, vDays) {
    if (p.money < cost) return showToast("è·¯è´¹ä¸å¤Ÿ");
    if (!nextDay()) return;
    
    p.money -= cost;
    p.city = idx;
    p.visa = vDays > 0 ? { day: vDays, on: true } : { day:0, on:false };
    
    if (idx === p.home) {
        p.sales = 0;
        showToast("å›åˆ°åŸºåœ°ï¼Œé¢åº¦é‡ç½®");
    } else {
        showToast("åˆ°è¾¾ç›®çš„åœ°");
    }
    
    refreshMarket();
    closeModal();
    render(); saveGame();
}

// --- è‚¡ç¥¨ ---
function openStockUI() {
    if(!p.stock.open) {
        return showModal("ğŸ“ˆ å¼€æˆ·", "å¼€é€šè¯åˆ¸è´¦æˆ·éœ€ Â¥1000 æ‰‹ç»­è´¹ã€‚", 
            `<button class="btn-success" onclick="unlockStock()">æ”¯ä»˜å¼€é€š</button>`);
    }
    
    let h = `<div style="max-height:300px; overflow-y:auto;">`;
    p.stock.mkt.forEach(s => {
        let hold = p.stock.port[s.n] || {c:0, cost:0};
        let color = s.chg >= 0 ? "var(--red)" : "var(--green)";
        let sign = s.chg >= 0 ? "+" : "";
        
        // ç®€æ˜“æ³¢å½¢å›¾
        let min = Math.min(...s.hist); let max = Math.max(...s.hist);
        let pts = s.hist.map((v,i) => `${i*20},${50 - ((v-min)/(max-min+1)*40)}`).join(" ");
        
        h += `
        <div class="stock-card">
            <div style="display:flex; justify-content:space-between;">
                <b>${s.n}</b>
                <span style="color:${color}">${s.p} (${sign}${s.chg}%)</span>
            </div>
            <svg width="100%" height="50" style="margin:5px 0">
                <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="2"/>
            </svg>
            <div style="font-size:11px; color:#888; margin-bottom:5px;">æŒä»“: ${hold.c} | æœ¬: ${parseInt(hold.cost)}</div>
            <div style="display:flex; gap:5px;">
                <button class="btn-sm btn-success" style="flex:1" onclick="tradeStock('${s.n}', 1)">ä¹°å…¥</button>
                <button class="btn-sm btn-danger" style="flex:1" onclick="tradeStock('${s.n}', -1)">å–å‡º</button>
            </div>
        </div>`;
    });
    h += `</div>`;
    showModal("ğŸ“ˆ è¯åˆ¸äº¤æ˜“æ‰€", h);
}

function unlockStock() {
    if(p.money < 1000) return showToast("é’±ä¸å¤Ÿ");
    p.money -= 1000; p.stock.open = true;
    closeModal(); openStockUI();
}

function tradeStock(n, dir) {
    let s = p.stock.mkt.find(x=>x.n===n);
    let hold = p.stock.port[n] || {c:0, cost:0};
    
    // ç®€åŒ–ä¸ºæ¯æ¬¡äº¤æ˜“100è‚¡
    let amt = 100; 
    
    if(dir > 0) {
        let cost = amt * s.p;
        if(p.money < cost) return showToast("èµ„é‡‘ä¸è¶³ä¹°100è‚¡");
        p.money -= cost;
        hold.cost = (hold.c*hold.cost + cost)/(hold.c+amt);
        hold.c += amt;
        showToast("ä¹°å…¥æˆåŠŸ");
    } else {
        if(hold.c < amt) return showToast("æŒä»“ä¸è¶³100è‚¡");
        p.money += amt * s.p;
        hold.c -= amt;
        showToast("å–å‡ºæˆåŠŸ");
    }
    p.stock.port[n] = hold;
    openStockUI(); render(); saveGame();
}

// --- é»‘å¸‚ (æ–°UI) ---
function openBlackUI() {
    if(!p.black.warn) {
        return showModal("âš ï¸ æ³•å¾‹è­¦å‘Š", 
            "<p class='text-down'>è­¦å‘Šï¼šæ¶‰åŠè¿ç¦å“äº¤æ˜“ï¼<br>è¢«æ•å°†ç›´æ¥å¯¼è‡´æ¸¸æˆç»“æŸï¼ˆåˆ æ¡£ï¼‰ï¼<br>æ˜¯å¦ç»§ç»­ï¼Ÿ</p>", 
            `<button class="btn-danger" onclick="p.black.warn=true; closeModal(); openBlackUI()">æˆ‘å·²çŸ¥æ™“é£é™©</button>`);
    }
    
    let h = `<p style="font-size:11px; color:#888; margin-bottom:10px;">ä¿æŠ¤ä¼ç­‰çº§: ${p.prot==1?'åˆçº§(5%)':p.prot==2?'é«˜çº§(15%)':'æ— '}</p>`;
    h += `<div style="display:flex; gap:5px; margin-bottom:10px;">
        <button class="btn-sm btn-purple" onclick="buyProt(1)" style="flex:1">10ä¸‡è´¿èµ‚</button>
        <button class="btn-sm btn-purple" onclick="buyProt(2)" style="flex:1">100ä¸‡è´¿èµ‚</button>
    </div>`;
    
    CONFIG.BLACK.forEach(g => {
        let mk = p.black.mkt[g.n];
        let inv = p.inv[g.n] || {c:0};
        h += `<div class="list-item">
            <div>
                <div style="color:#ffb0b0">${g.n} <span class="tag tag-red">é™©${g.risk}%</span></div>
                <div style="font-size:11px; color:#666">æŒ:${inv.c} ä½™:${mk.s}</div>
            </div>
            <div style="text-align:right">
                <div style="color:var(--gold)">Â¥${mk.p}</div>
                <button class="btn-sm btn-dark" onclick="tradeBlack('${g.n}', 1)">ä¹°</button>
                <button class="btn-sm btn-dark" onclick="tradeBlack('${g.n}', -1)">å–</button>
            </div>
        </div>`;
    });
    showModal("ğŸ’€ åœ°ä¸‹é»‘å¸‚", h);
}

function tradeBlack(n, dir) {
    let g = CONFIG.BLACK.find(x=>x.n===n);
    // é£é™©åˆ¤å®š
    if(Math.random()*100 < g.risk) {
        let save = (p.prot==1 && Math.random()<0.05) || (p.prot==2 && Math.random()<0.15);
        if(save) { alert("ğŸš“ è­¦å¯Ÿçªè¢­ï¼ä½†ä¿æŠ¤ä¼æ•‘äº†ä½ ã€‚"); }
        else { return gameOver("äº¤æ˜“è¿ç¦å“è¢«å½“åœºå‡»æ¯™"); }
    }
    
    let mk = p.black.mkt[n];
    if(!p.inv[n]) p.inv[n]={c:0, cost:0};
    
    if(dir > 0) {
        if(getIllegalCount()+1 > 10) return showToast("è¿ç¦å“æœ€å¤šå¸¦10ä¸ª");
        if(p.money < mk.p) return showToast("æ²¡é’±");
        if(mk.s < 1) return showToast("æ²¡è´§");
        p.money -= mk.p; p.inv[n].c++; mk.s--;
        showToast("è´­å…¥è¿ç¦å“");
    } else {
        if(p.inv[n].c < 1) return;
        p.money += mk.p; p.inv[n].c--;
        showToast("å‡ºæ‰‹è¿ç¦å“");
    }
    openBlackUI(); render(); saveGame();
}

function buyProt(lvl) {
    let cost = lvl==1 ? 100000 : 1000000;
    if(p.money < cost) return showToast("èµ„é‡‘ä¸è¶³");
    p.money -= cost; p.prot = lvl;
    showToast("æ‰“ç‚¹æˆåŠŸ");
    openBlackUI(); render(); saveGame();
}

// === 6. è¾…åŠ©ä¸æ¸²æŸ“ ===
function render() {
    let city = CONFIG.CITIES[p.city];
    let rank = CONFIG.RANKS[p.rank];
    
    // Header
    document.getElementById('uiCompany').innerText = p.name;
    document.getElementById('uiMoney').innerText = "Â¥" + p.money.toLocaleString();
    document.getElementById('uiHp').innerText = `${p.hp}/50`;
    document.getElementById('uiHpBar').style.width = (p.hp/50*100) + "%";
    document.getElementById('uiLoc').innerText = city.name + (p.visa.on ? ` (ç­¾${p.visa.day})` : "");
    document.getElementById('uiRank').innerText = rank.name;
    document.getElementById('uiCap').innerText = `ğŸ’ ${getInvCount()}/${p.cap}`;
    
    // æ™‹å‡æŒ‰é’®é€»è¾‘
    let nextRank = CONFIG.RANKS[p.rank + 1];
    let btnPromote = document.getElementById('btnPromote');
    if (nextRank) {
        btnPromote.style.display = "block";
        btnPromote.innerText = `æ™‹å‡: ${nextRank.name} (Â¥${nextRank.cost})`;
        btnPromote.disabled = p.money < nextRank.cost;
        // é™é¢æç¤º
        if(p.city !== p.home) {
            document.getElementById('uiLimit').innerText = `å¤–åœ°é™é¢: ${p.sales}/${rank.limit}`;
        } else {
            document.getElementById('uiLimit').innerText = "";
        }
    } else {
        btnPromote.style.display = "none"; // æ»¡çº§éšè—
        document.getElementById('uiLimit').innerText = "å·²è¾¾å·…å³°";
    }

    // Market List
    let h = "";
    CONFIG.GOODS.forEach(g => {
        if (g.r <= p.rank + 1) {
            let mk = p.market[g.n] || {p: g.b, s: 0};
            let inv = p.inv[g.n] || {c:0, cost:0};
            let color = inv.c>0 ? (mk.p > inv.cost ? "text-up" : "text-down") : "";
            
            h += `<div class="list-item">
                <div style="flex:1">
                    <div><b>${g.n}</b> <span class="tag tag-gray">ä½™${mk.s}</span></div>
                    <div style="font-size:11px; color:#666">æŒ:${inv.c} ${inv.c>0 ? 'æœ¬:'+parseInt(inv.cost) : ''}</div>
                </div>
                <div style="flex:1; text-align:center;" class="${color}">Â¥${mk.p}</div>
                <div>
                    <button class="btn-sm btn-danger" onclick="trade('${g.n}', -1)">å–</button>
                    <button class="btn-sm btn-primary" onclick="trade('${g.n}', 999)">å…¨</button>
                    <button class="btn-sm btn-success" onclick="trade('${g.n}', 1)" ${mk.s<=0?'disabled':''}>ä¹°</button>
                </div>
            </div>`;
        }
    });
    document.getElementById('marketList').innerHTML = h;

    // City List
    let ch = "";
    CONFIG.CITIES.forEach((c, i) => {
        if (i === p.city) return;
        if (p.rank >= 5 && i <= 1) return; // åæœŸå±è”½æ–°æ‰‹æ‘
        
        let lock = c.req > p.rank;
        let dist = Math.abs(c.dist - city.dist);
        let btnStr = lock ? `<span class="tag-gray">ğŸ”’ éœ€${CONFIG.RANKS[c.req].name}</span>` : `<button class="btn-sm" onclick="tryTravel(${i})">å‡ºå‘</button>`;
        
        let moveBtn = (!lock && i !== p.home) ? `<button class="btn-sm btn-purple" onclick="moveHome(${i})">ç§»æ°‘</button>` : "";
        
        ch += `<div class="list-item">
            <div>
                <div>${c.name} ${c.foreign?'ğŸŒ':''}</div>
                <div style="font-size:11px; color:#666">${dist}km</div>
            </div>
            <div>${moveBtn} ${btnStr}</div>
        </div>`;
    });
    document.getElementById('cityList').innerHTML = ch;
}

// è¾…åŠ©é€»è¾‘
function promote() {
    let next = CONFIG.RANKS[p.rank + 1];
    if (p.money >= next.cost) {
        p.money -= next.cost;
        p.rank++;
        showToast("ğŸ‰ æ™‹å‡æˆåŠŸï¼");
        render(); saveGame();
    }
}
function expandCap() {
    let cost = p.cap * 100;
    if (p.money >= cost) { p.money -= cost; p.cap += 10; render(); saveGame(); }
    else showToast("æ‰©å®¹éœ€ Â¥"+cost);
}
function goHome(force) {
    if(force) { p.city=p.home; p.sales=0; p.visa={day:0,on:false}; render(); saveGame(); return; }
    tryTravel(p.home);
}
function moveHome(i) {
    if(confirm("èŠ±è´¹300ä¸‡ç§»æ°‘?")) {
        if(p.money<3000000) return showToast("é’±ä¸å¤Ÿ");
        p.money-=3000000; p.home=i; p.city=i; p.sales=0;
        showToast("ç§»æ°‘æˆåŠŸ"); render(); saveGame();
    }
}
function getInvCount() {
    let t = 0;
    for(let k in p.inv) {
        // è¿ç¦å“ä¸å æ™®é€šå®¹é‡ï¼Œä½†é™åˆ¶æºå¸¦10ä¸ª
        if(!CONFIG.BLACK.find(b=>b.n===k)) t += p.inv[k].c;
    }
    return t;
}
function getIllegalCount() {
    let t=0; for(let k in p.inv) if(CONFIG.BLACK.find(b=>b.n===k)) t+=p.inv[k].c; return t;
}
function log(msg) {
    let b = document.getElementById('gameLog');
    b.innerHTML = `<div>> ${msg}</div>` + b.innerHTML;
}
function showToast(msg) { log(msg); } // ç®€å•ç”¨æ—¥å¿—ä»£æ›¿Toast

// å¼¹çª—ç³»ç»Ÿæ ¸å¿ƒ
function showModal(title, content, footerHtml) {
    document.getElementById('mTitle').innerText = title;
    document.getElementById('mContent').innerHTML = content;
    document.getElementById('mFooter').innerHTML = footerHtml || `<button class="btn-primary" onclick="closeModal()">å…³é—­</button>`;
    document.getElementById('gameModal').style.display = 'flex';
}
function closeModal() { document.getElementById('gameModal').style.display = 'none'; }
function openNameInput() {
    showModal("ğŸ‘‹ æ¬¢è¿åˆ›ä¸š", 
        `<p>è¯·è¾“å…¥ä½ çš„å…¬å¸åç§°ï¼š</p><input id="startName" class="modal-input" placeholder="ATRIè´¸æ˜“">`,
        `<button class="btn-success" onclick="startGame()">å¼€å§‹åˆ›ä¸š</button>`
    );
}
function startGame() {
    let n = document.getElementById('startName').value;
    p.name = n || "æœªå‘½å";
    closeModal(); initGameLogic();
}

// å­˜æ¡£ç³»ç»Ÿ
function saveGame() { localStorage.setItem("tycoon_v71", JSON.stringify(p)); showToast("å·²å­˜æ¡£"); }
function loadGame() { let d = localStorage.getItem("tycoon_v71"); if(d) p = JSON.parse(d); }
function hardReset() { if(confirm("ç¡®å®šåˆ æ¡£ï¼Ÿ")) { localStorage.removeItem("tycoon_v71"); location.reload(); } }
function gameOver(reason) {
    alert("ğŸ’€ æ¸¸æˆç»“æŸï¼š"+reason);
    localStorage.removeItem("tycoon_v71"); location.reload();
}
// åˆ®åˆ®ä¹ (ç®€åŒ–ç‰ˆ)
function openLottoUI() {
    showModal("ğŸ° åˆ®åˆ®ä¹", 
        `<div class="lotto-card" onclick="lotto(1)"><div>å‘è´¢æ¢¦</div><div style="color:gold">Â¥50</div></div>
         <div class="lotto-card" onclick="lotto(2)"><div>æš´å¯Œæµ</div><div style="color:gold">Â¥150</div></div>
         <div class="lotto-card" onclick="lotto(3)"><div>é€†å¤©æ”¹å‘½</div><div style="color:gold">Â¥1000</div></div>`
    );
}
function lotto(t) {
    let cost = t==1?50:t==2?150:1000;
    let max = t==1?200000:t==2?800000:5000000;
    if(p.money<cost) return showToast("é’±ä¸å¤Ÿ");
    p.money-=cost;
    let r = Math.random();
    let win = 0;
    if(r<0.008) win=max; else if(r<0.1) win=cost*2; else if(r<0.3) win=cost;
    p.money+=win;
    showToast(win>0 ? `ä¸­äº† Â¥${win}` : "è°¢è°¢æƒ é¡¾");
    render(); saveGame();
}
function randomEvent() {
    if(Math.random()>0.1) return;
    let e = Math.random();
    if(e<0.3) { p.money+=2000; showToast("æ¡åˆ°é’±åŒ… +Â¥2000"); }
    else if(e<0.6) { p.money=Math.max(0,p.money-1000); showToast("é­é‡å¼ºç›— -Â¥1000"); }
    else {
        for(let k in p.market) p.market[k].p = Math.floor(p.market[k].p * 1.5);
        showToast("é€šè´§è†¨èƒ€ï¼ç‰©ä»·é£æ¶¨ï¼");
    }
}
function exportSave(){ 
    let s = btoa(encodeURIComponent(JSON.stringify(p)));
    showModal("ğŸ“¤ å¯¼å‡ºå­˜æ¡£", `<textarea class="modal-input" style="height:100px">${s}</textarea>`);
}
function importSave(){
    showModal("ğŸ“¥ å¯¼å…¥å­˜æ¡£", `<textarea id="impStr" class="modal-input" style="height:100px" placeholder="ç²˜è´´å­˜æ¡£ç "></textarea>`, 
    `<button class="btn-success" onclick="doImport()">å¯¼å…¥</button>`);
}
function doImport(){
    try {
        let s = document.getElementById('impStr').value;
        p = JSON.parse(decodeURIComponent(atob(s)));
        saveGame(); location.reload();
    } catch(e) { showToast("å­˜æ¡£æ— æ•ˆ"); }
}
function share(){
    let txt = `ğŸš€ã€${p.name}ã€‘æˆ˜ç»©ï¼šèµ„äº§Â¥${p.money} å¤´è¡”:${CONFIG.RANKS[p.rank].name}`;
    navigator.clipboard.writeText(txt); showToast("æˆ˜ç»©å·²å¤åˆ¶");
}
</script>
</body>
</html>

