<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†ä¸šå¤§äº¨ V8.5ï¼šä¿¡è´·å±æœº</title>
    <style>
        :root { --bg: #0f1115; --panel: #161b22; --border: #30363d; --primary: #58a6ff; --green: #2ea043; --red: #da3633; --gold: #e3b341; --text: #c9d1d9; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; padding: 10px; max-width: 550px; margin: 0 auto; line-height: 1.4; padding-bottom: 60px; }
        
        .header { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .company-title { text-align: center; font-size: 18px; font-weight: 800; color: var(--primary); margin-bottom: 12px; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-weight: bold; font-size: 14px; }
        .money-val { color: var(--gold); }
        .hp-val { color: var(--red); }
        .progress-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }

        .panel { background: var(--panel); padding: 12px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        button { border: none; outline: none; border-radius: 6px; padding: 8px 12px; font-size: 13px; font-weight: 600; cursor: pointer; color: #fff; background: #21262d; border: 1px solid var(--border); transition: all 0.1s;}
        button:active { transform: scale(0.96); opacity: 0.8; }
        button:disabled { opacity: 0.5; filter: grayscale(1); }
        
        .btn-success { background: var(--green); border-color: var(--green); }
        .btn-danger { background: var(--red); border-color: var(--red); }
        .btn-primary { background: #1f6feb; border-color: #1f6feb; }
        .btn-gold { background: var(--gold); border-color: var(--gold); color: #000; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-block { width: 100%; display: block; margin-bottom: 8px; padding: 10px;}

        /* å¼¹çª—ç³»ç»Ÿ */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-body { background: #1c2128; width: 92%; max-width: 420px; max-height: 85vh; border-radius: 16px; border: 1px solid #444; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; background: #222; display: flex; justify-content: space-between; align-items: center; }
        .modal-content { padding: 20px; overflow-y: auto; font-size: 14px; }
        .modal-input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; margin: 10px 0; text-align: center; }
        
        .stock-card { background: #111; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .lotto-card { background: linear-gradient(135deg, #332244, #111); padding: 15px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #555; display: flex; justify-content: space-between; align-items: center; }
        .text-up { color: var(--green); } .text-down { color: var(--red); } .text-gold { color: var(--gold); }
        .tag { font-size: 10px; padding: 1px 4px; border-radius: 3px; margin-left: 4px; background: #333; color: #aaa; }
        
        .log-box { height: 100px; overflow-y: auto; font-size: 11px; color: #666; font-family: monospace; border-top: 1px solid #333; padding-top: 10px; margin-top: 20px; }
        .author { text-align: center; font-size: 12px; color: #333; margin: 20px 0; font-weight: bold; }
    </style>
</head>
<body>

<div id="gameModal" class="modal-mask">
    <div class="modal-body">
        <div class="modal-header"><span id="mTitle">æé†’</span><button class="btn-sm" onclick="closeModal()">Ã—</button></div>
        <div class="modal-content" id="mContent"></div>
        <div id="mFooter" style="padding:15px; border-top:1px solid #333; display:flex; justify-content:flex-end; gap:10px; background:#222;"></div>
    </div>
</div>

<div class="header">
    <div class="company-title" id="uiCompany">è½½å…¥ä¸­...</div>
    <div class="stat-grid">
        <div class="stat-item"><span class="stat-label">æ€»èµ„äº§</span><span class="stat-val money-val" id="uiMoney">Â¥0</span></div>
        <div class="stat-item">
            <span class="stat-label">ç”Ÿå‘½å€¼</span>
            <span class="stat-val hp-val" id="uiHp">50/50</span>
            <div class="progress-bar"><div class="progress-fill" id="uiHpBar"></div></div>
        </div>
        <div class="stat-item"><span class="stat-label">æ‰€åœ¨åœ°</span><span class="stat-val" id="uiLoc">--</span></div>
        <div class="stat-item"><span class="stat-label">ä»Šæ—¥å·²åƒ</span><span class="stat-val" style="color:var(--primary)" id="uiMeal">0/3</span></div>
    </div>
    <button id="btnPromote" class="btn-block btn-gold" style="margin-top:12px; display:none;" onclick="promote()">æ™‹å‡å¤´è¡”</button>
    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:11px; color:#555;">
        <span id="uiCap">ğŸ’ 0/50</span><span id="uiLimit" style="color:var(--red)"></span>
    </div>
</div>

<div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:5px; margin-bottom:15px;">
    <button onclick="openBankUI()">ğŸ¦ é“¶è¡Œ</button>
    <button onclick="openStockUI()">ğŸ“ˆ è‚¡å¸‚</button>
    <button onclick="openHouseUI()" style="color:var(--gold)">ğŸ  æˆ¿äº§</button>
    <button onclick="openLottoUI()">ğŸ° å½©ç¥¨</button>
    <button onclick="openBlackUI()" class="btn-danger" style="background:#300;">ğŸ’€ é»‘å¸‚</button>
</div>

<div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <b style="color:var(--primary)">ğŸŒ æ‰¹å‘å¸‚åœº</b>
        <div>
            <button class="btn-sm" onclick="expandCap()">â• æ‰©å®¹</button>
            <button class="btn-sm btn-primary" onclick="openRestUI()">ğŸ›Œ ä¼‘æ¯/åƒé¥­</button>
        </div>
    </div>
    <div id="marketList"></div>
    <div id="casinoEntry" style="margin-top:10px; display:none;">
        <button class="btn-block" style="background:linear-gradient(45deg, #300, #600); border:1px solid red;" onclick="openCasinoUI()">ğŸ² çš‡å®¶èµŒåœº</button>
    </div>
</div>

<div class="panel">
    <b style="color:var(--primary); display:block; margin-bottom:10px;">âœˆï¸ å•†åŠ¡å·®æ—…</b>
    <button class="btn-block" style="background:#222; margin-bottom:10px;" onclick="goHome()">ğŸ  å›åˆ°åŸºåœ° (é‡ç½®é¢åº¦)</button>
    <div id="cityList"></div>
</div>

<div class="panel">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
        <button onclick="share()">ğŸ† ç‚«è€€æˆ˜ç»©</button>
        <button onclick="saveGame()">ä¿å­˜å­˜æ¡£</button>
        <button onclick="exportSave()">å¯¼å‡ºä»£ç </button>
        <button onclick="importSave()">å¯¼å…¥ä»£ç </button>
    </div>
    <button class="btn-block btn-danger" style="margin-top:10px; opacity:0.6" onclick="hardReset()">â˜ ï¸ ç ´äº§æ¸…ç®—</button>
</div>

<div class="log-box" id="gameLog"></div>
<div class="author">ä½œè€…: ATRI</div>

<script>
// === æ•°æ®é…ç½® ===
const CONFIG = {
    RANKS: [
        { name: "æµåŠ¨æ‘Šè´©", cost: 0, limit: 100 }, { name: "å°å–éƒ¨", cost: 3000, limit: 3000 },
        { name: "ä¾¿åˆ©åº—", cost: 10000, limit: 8000 }, { name: "è¿é”å•†åº—", cost: 30000, limit: 25000 },
        { name: "å°å‹è¶…å¸‚", cost: 80000, limit: 60000 }, { name: "å¤§å‹è¶…å¸‚", cost: 200000, limit: 150000 },
        { name: "è´¸æ˜“å…¬å¸", cost: 500000, limit: 500000 }, { name: "è·¨å›½é›†å›¢", cost: 5000000, limit: 5000000 },
        { name: "å•†ä¸šå¸å›½", cost: 20000000, limit: 20000000 }, { name: "ä¸–ç•Œé¦–å¯Œ", cost: 100000000, limit: 999999999 }
    ],
    CITIES: [
        { name: "æ‘å£(è€å®¶)", dist: 0, req: 0, foreign: false }, { name: "å¿åŸ", dist: 20, req: 0, foreign: false },
        { name: "çœä¼š", dist: 300, req: 1, foreign: false }, { name: "æ·±åœ³", dist: 1200, req: 2, foreign: false },
        { name: "æ¾³é—¨", dist: 1200, req: 2, foreign: false, casino: true },
        { name: "é¦–å°”", dist: 2000, req: 4, foreign: true }, { name: "ä¸œäº¬", dist: 3000, req: 6, foreign: true },
        { name: "è¿ªæ‹œ", dist: 6000, req: 8, foreign: true }, { name: "æ‹‰æ–¯ç»´åŠ æ–¯", dist: 11000, req: 9, foreign: true, casino: true },
        { name: "çº½çº¦", dist: 12000, req: 10, foreign: true }
    ],
    GOODS: [
        { n: "åºŸæŠ¥çº¸", b: 1, v: 0.1, r: 0, s: 2000 }, { n: "å†œå¤«å±±æ³‰", b: 2, v: 0.1, r: 0, s: 1000 },
        { n: "å°ç±³æ‰‹ç¯", b: 150, v: 0.2, r: 1, s: 200 }, { n: "Switch", b: 2000, v: 0.3, r: 2, s: 50 },
        { n: "é£å¤©èŒ…å°", b: 3000, v: 0.5, r: 3, s: 30 }, { n: "iPhone 17", b: 8000, v: 0.4, r: 5, s: 15 },
        { n: "åŠ³åŠ›å£«", b: 90000, v: 0.3, r: 8, s: 5 }, { n: "è‹±ä¼Ÿè¾¾H100", b: 250000, v: 0.7, r: 10, s: 2 },
        { n: "SpaceXç»„ä»¶", b: 5000000, v: 0.2, r: 10, s: 1 }
    ],
    BLACK: [
        { n: "å‡é’", b: 10000, risk: 20 }, { n: "ç®¡åˆ¶åˆ€å…·", b: 2000, risk: 8 }, { n: "æ¯’å“", b: 60000, risk: 75 }
    ],
    STOCKS: [
        { n: "ä¼¯å…‹å¸Œå°”", b: 4000000, min: 2000, max: 8000000, v: 0.02 },
        { n: "è‹±ä¼Ÿè¾¾", b: 15000, min: 2000, max: 8000000, v: 0.08 },
        { n: "è´µå·èŒ…å°", b: 18000, min: 2000, max: 8000000, v: 0.03 },
        { n: "ç‰¹æ–¯æ‹‰", b: 6000, min: 2000, max: 8000000, v: 0.10 },
        { n: "å¯å£å¯ä¹", b: 3000, min: 2000, max: 8000000, v: 0.01 }
    ],
    ESTATES: [
        { id: 1, name: "è€å®¶åœŸå¯æˆ¿", cost: 5000, rent: 50 }, { id: 2, name: "å¿åŸè€ç ´å°", cost: 50000, rent: 300 },
        { id: 3, name: "çœä¼šå­¦åŒºæˆ¿", cost: 800000, rent: 2000 }, { id: 4, name: "æ·±åœ³äººæ‰å…¬å¯“", cost: 2000000, rent: 5000 },
        { id: 5, name: "é¦–å°”æ±Ÿå—å¤§å¹³å±‚", cost: 5000000, rent: 12000 }, { id: 6, name: "ä¸œäº¬é“¶åº§å•†é“º", cost: 15000000, rent: 35000 },
        { id: 7, name: "æ¾³é—¨æµ·æ™¯åˆ«å¢…", cost: 30000000, rent: 70000 }, { id: 8, name: "åŒ—äº¬å››åˆé™¢", cost: 80000000, rent: 150000 },
        { id: 9, name: "è¿ªæ‹œå“ˆåˆ©æ³•å¡”é¡¶å±‚", cost: 120000000, rent: 300000 }, { id: 10, name: "çº½çº¦æ›¼å“ˆé¡¿å¤§æ¥¼", cost: 500000000, rent: 1200000 },
        { id: 11, name: "æ‹‰æ–¯ç»´åŠ æ–¯èµŒåœº", cost: 888888888, rent: 2500000 }, { id: 12, name: "å¤ªå¹³æ´‹ç§äººå²›å±¿", cost: 2000000000, rent: 6000000 }
    ]
};

let p = {
    name: null, day: 1, money: 1000, hp: 50, city: 0, home: 0, rank: 0, cap: 50,
    inv: {}, market: {}, bank: { dep: 0, loan: 0, due: 0 }, visa: { day: 0, on: false },
    sales: 0, black: { warn: false, mkt: {} }, prot: 0, stock: { open: false, port: {}, mkt: [] },
    estate: {}, totalRent: 0,
    // V8.5 æ–°å¢
    mealCount: 0, hasEaten: false
};

window.onload = () => { loadGame(); if (!p.name) openNameInput(); else initGame(); };

function initGame() {
    if (!p.market || Object.keys(p.market).length === 0) refreshMarket(true);
    if (!p.stock.mkt || p.stock.mkt.length === 0) {
        p.stock.mkt = CONFIG.STOCKS.map(s => ({ n: s.n, p: s.b, hist: [s.b, s.b, s.b, s.b, s.b], chg: 0 }));
    }
    calcTotalRent();
    render();
}

function calcTotalRent() { p.totalRent = 0; CONFIG.ESTATES.forEach(e => { if(p.estate[e.id]) p.totalRent += e.rent; }); }

function refreshMarket(init = false) {
    let nm = {};
    CONFIG.GOODS.forEach(g => {
        if (g.r <= p.rank + 1) {
            let pr = Math.floor(g.b * (1 + (Math.random()-0.5)*2*g.v));
            nm[g.n] = { p: Math.max(1, pr), s: Math.floor(g.s * (0.5+Math.random())) };
        }
    });
    p.market = nm;

    let bm = {};
    CONFIG.BLACK.forEach(g => {
        bm[g.n] = { p: Math.floor(g.b*(0.5+Math.random()*1.5)), s: Math.floor(Math.random()*8)+1, r: g.risk };
    });
    p.black.mkt = bm;

    p.stock.mkt.forEach((s, i) => {
        let conf = CONFIG.STOCKS[i];
        let old = s.p;
        let np = Math.floor(old * (1 + (Math.random()-0.5)*2*conf.v));
        s.p = Math.min(conf.max, Math.max(conf.min, np));
        s.chg = ((s.p-old)/old*100).toFixed(2);
        s.hist.push(s.p); if(s.hist.length>7) s.hist.shift();
    });
}

function nextDay() {
    // V8.5: è´Ÿå€ºæ£€æŸ¥ - å¦‚æœåœ¨ç»“ç®—æ—¶é’±æ˜¯è´Ÿçš„ï¼Œç›´æ¥ç»“æŸ
    if (p.money < 0) {
        gameOver("èµ„ä¸æŠµå€ºï¼Œè¢«æ•å…¥ç‹±ï¼\nä½ æœªèƒ½åœ¨å½“å¤©è¿˜æ¸…å€ºåŠ¡ã€‚");
        return false;
    }

    // V8.5: é¥¥é¥¿æ£€æŸ¥
    if (!p.hasEaten) {
        p.hp -= 10;
        showToast("âš ï¸ æ˜¨å¤©æ²¡åƒé¥­ï¼Œç”Ÿå‘½ -10");
        if (p.hp <= 0) {
            let cost = Math.floor(Math.max(0, p.money) * 0.75); // é˜²æ­¢è´Ÿæ•°bug
            p.money -= cost; p.hp = 20;
            showModal("ğŸ¥ é¥¿æ™•æŠ¢æ•‘", `<p>ä½ é¥¿æ™•åœ¨è¡—å¤´ï¼</p><p>æŠ¢æ•‘è´¹(75%): <b class='text-down'>Â¥${cost.toLocaleString()}</b></p>`);
            return false;
        }
    }

    p.day++;
    // é‡ç½®æ¯æ—¥çŠ¶æ€
    p.mealCount = 0;
    p.hasEaten = false;

    // é“¶è¡Œåˆ©æ¯
    if (p.bank.dep > 0) p.bank.dep += Math.floor(p.bank.dep * 0.005);
    if (p.bank.loan > 0) {
        p.bank.loan += Math.floor(p.bank.loan * 0.02);
        if (p.day > p.bank.due) { gameOver("è´·æ¬¾é€¾æœŸè¢«æ•"); return false; }
    }
    
    // ç­¾è¯
    if (CONFIG.CITIES[p.city].foreign && p.city !== p.home) {
        p.visa.day--;
        if (p.visa.day <= 0) { alert("ç­¾è¯åˆ°æœŸï¼Œå¼ºåˆ¶é£è¿”ï¼"); goHome(true); return false; }
    }
    
    // æˆ¿äº§
    if(p.totalRent > 0) {
        p.money += p.totalRent;
        showToast(`æ”¶ç§Ÿ +Â¥${p.totalRent.toLocaleString()}`);
    }
    
    return true;
}

// === ä¼‘æ¯é€»è¾‘ (V8.5 é‡å†™) ===
function openRestUI() {
    let nextBtnText = p.hasEaten ? "ğŸ“… ä¸‹ä¸€å¤© (å·²åƒ)" : "ğŸ“… ä¸‹ä¸€å¤© (æœªåƒ -10HP)";
    let nextBtnColor = p.hasEaten ? "btn-success" : "btn-danger";
    
    showModal("ğŸ›Œ ä¼‘æ¯è¿›é£Ÿ", `
        <p style="text-align:center; color:#888;">ä»Šæ—¥å·²åƒ: ${p.mealCount}/3</p>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button onclick="doEat(1)" style="padding:15px; background:#222;">ğŸ›µ <b>å¤–å–</b><br><span class='text-down'>5%</span><span class='text-up'>+3HP</span></button>
            <button onclick="doEat(2)" style="padding:15px; background:#222;">ğŸ³ <b>è‡ªç‚Š</b><br><span class='text-down'>10%</span><span class='text-up'>+5HP</span></button>
            <button onclick="doEat(3)" style="padding:15px; background:#222;">ğŸ½ï¸ <b>é¤é¦†</b><br><span class='text-down'>15%</span><span class='text-up'>+8HP</span></button>
            <button onclick="doNextDay()" style="padding:15px;" class="${nextBtnColor}">${nextBtnText}</button>
        </div>
        <p style='font-size:10px;color:#666;text-align:center;margin-top:10px;'>æ²¡é’±åƒé¥­ä¼šå¼ºåˆ¶æ‰£æˆè´Ÿæ•° (éœ¸ç‹é¤)</p>
    `);
}

function doEat(type) {
    if (p.mealCount >= 3) return alert("ä»Šå¤©åƒæ’‘äº†ï¼Œä¸èƒ½å†åƒäº†ï¼");

    let rate = [0.05, 0.10, 0.15][type-1];
    let maxCost = [2000, 5000, 10000][type-1];
    let hpAdd = [3, 5, 8][type-1];
    
    // è®¡ç®—é¤è´¹
    let cost = Math.floor(Math.max(0, p.money) * rate); // åŸºäºæ­£èµ„äº§è®¡ç®—ï¼Œå¦‚æœæ˜¯è´Ÿå€ºçŠ¶æ€ï¼Œæˆæœ¬ä¸º0ä½†æœ‰ç½šæ¬¾
    if(cost > maxCost) cost = maxCost;

    if(p.money < cost || p.money <= 0) {
        // V8.5: æ²¡é’±éœ¸ç‹é¤æƒ©ç½š
        if(!confirm("âš ï¸ ä½™é¢ä¸è¶³/è´Ÿå€ºï¼\nå¼ºè¡Œåƒé¥­å°†æ‰£é™¤ Â¥1,000 (å˜æˆè´Ÿæ•°)ï¼\nè­¦å‘Šï¼šä»Šå¤©å¿…é¡»è¿˜æ¸…ï¼Œå¦åˆ™æ¸¸æˆç»“æŸï¼\nç¡®å®šè¦åƒéœ¸ç‹é¤å—ï¼Ÿ")) return;
        p.money -= 1000;
        showToast("åƒäº†éœ¸ç‹é¤ï¼ŒèƒŒè´Ÿå€ºåŠ¡ Â¥1000");
    } else {
        p.money -= cost;
    }
    
    p.hp = Math.min(50, p.hp + hpAdd);
    p.mealCount++;
    p.hasEaten = true;
    
    closeModal();
    openRestUI(); // é‡æ–°æ‰“å¼€åˆ·æ–°çŠ¶æ€
    render(); saveGame();
}

function doNextDay() {
    closeModal();
    if (nextDay()) {
        refreshMarket();
        if(p.city === p.home) p.sales = 0;
        showToast("è¿›å…¥æ–°çš„ä¸€å¤©");
        render(); saveGame();
    }
}

// === è‚¡ç¥¨é€»è¾‘ (ä¿®å¤) ===
function openStockUI() {
    if(!p.stock.open) return showModal("ğŸ“ˆ å¼€é€šè‚¡å¸‚", "éœ€æ”¯ä»˜ Â¥1000 å¼€æˆ·è´¹", `<button class='btn-success' onclick='if(p.money>=1000){p.money-=1000;p.stock.open=true;closeModal();openStockUI();render();}'>ç¡®è®¤æ”¯ä»˜</button>`);
    
    let h = "<div style='max-height:350px; overflow:auto;'>";
    p.stock.mkt.forEach((s, i) => {
        let hold = p.stock.port[s.n] || {c:0, cost:0};
        let color = s.chg >= 0 ? "var(--red)" : "var(--green)";
        h += `<div class='stock-card'>
            <b>${s.n}</b> <span style='color:${color}; float:right;'>Â¥${s.p} (${s.chg}%)</span><br>
            <small>æŒä»“: ${hold.c} | å‡ä»·: ${parseInt(hold.cost)}</small>
            <div style='margin-top:10px; display:flex; gap:5px;'>
                <button class='btn-sm btn-success' onclick='tradeStock("${s.n}", 100)' style='flex:1'>ä¹°100</button>
                <button class='btn-sm btn-danger' onclick='tradeStock("${s.n}", -100)' style='flex:1'>å–100</button>
            </div>
        </div>`;
    });
    h += "</div>";
    showModal("ğŸ“ˆ è¯åˆ¸äº¤æ˜“æ‰€", h);
}

function tradeStock(n, amt) {
    let s = p.stock.mkt.find(x => x.n === n);
    // V8.5: ç¡®ä¿ portfolio å¯¹è±¡åˆå§‹åŒ–
    if (!p.stock.port[n]) p.stock.port[n] = {c:0, cost:0};
    let h = p.stock.port[n];

    if (amt > 0) { // ä¹°å…¥
        let cost = amt * s.p;
        if (p.money < cost) return alert("èµ„é‡‘ä¸è¶³");
        p.money -= cost;
        h.cost = (h.c * h.cost + cost) / (h.c + amt);
        h.c += amt;
        showToast("ä¹°å…¥æˆåŠŸ");
    } else { // å–å‡º
        let sellAmt = Math.abs(amt);
        if (h.c < sellAmt) return alert("æŒä»“ä¸è¶³");
        p.money += sellAmt * s.p;
        h.c -= sellAmt;
        if (h.c === 0) h.cost = 0;
        showToast("å–å‡ºæˆåŠŸ");
    }
    openStockUI(); render(); saveGame();
}

// === æ¸²æŸ“ ===
function render() {
    document.getElementById('uiCompany').innerText = p.name;
    document.getElementById('uiMoney').innerText = "Â¥" + p.money.toLocaleString();
    document.getElementById('uiMoney').style.color = p.money < 0 ? 'var(--red)' : 'var(--gold)';
    
    document.getElementById('uiHp').innerText = `${p.hp}/50`;
    document.getElementById('uiHpBar').style.width = (p.hp/50*100) + "%";
    document.getElementById('uiLoc').innerText = CONFIG.CITIES[p.city].name;
    document.getElementById('uiRank').innerText = CONFIG.RANKS[p.rank].name;
    document.getElementById('uiCap').innerText = `ğŸ’ ${getInvCount()}/${p.cap}`;
    document.getElementById('uiMeal').innerText = `${p.mealCount}/3`; // æ˜¾ç¤ºåƒé¥­æ¬¡æ•°

    // æ™‹å‡
    let next = CONFIG.RANKS[p.rank + 1];
    let btnP = document.getElementById('btnPromote');
    if(next) {
        btnP.style.display = "block";
        btnP.innerText = `æ™‹å‡: ${next.name} (Â¥${next.cost.toLocaleString()})`;
        btnP.disabled = p.money < next.cost;
        if(p.city !== p.home) document.getElementById('uiLimit').innerText = `é™é¢: ${parseInt(p.sales)}/${CONFIG.RANKS[p.rank].limit}`;
        else document.getElementById('uiLimit').innerText = "";
    } else { btnP.style.display = "none"; }

    // å¸‚åœº
    let h = "";
    CONFIG.GOODS.forEach(g => {
        if (g.r <= p.rank + 1) {
            let mk = p.market[g.n] || {p:0, s:0};
            let inv = p.inv[g.n] || {c:0, cost:0};
            let col = inv.c > 0 ? (mk.p > inv.cost ? "text-up" : "text-down") : "";
            h += `<div class="list-item">
                <div style="flex:1"><b>${g.n}</b> <span class="tag">ä½™${mk.s}</span><br><small>æŒ:${inv.c} ${inv.c>0?'æœ¬:'+parseInt(inv.cost):''}</small></div>
                <div style="flex:1; text-align:center" class="${col}">Â¥${mk.p}</div>
                <div><button class="btn-sm btn-danger" onclick="trade('${g.n}', -999)">å–</button><button class="btn-sm" style="background:#555" onclick="trade('${g.n}', 'custom')">è‡ª</button><button class="btn-sm btn-success" onclick="trade('${g.n}', 1)" ${mk.s<=0?'disabled':''}>ä¹°</button></div>
            </div>`;
        }
    });
    document.getElementById('marketList').innerHTML = h;

    // åŸå¸‚
    let ch = "";
    CONFIG.CITIES.forEach((c, i) => {
        if (i === p.city) return;
        if (p.rank >= 5 && i <= 1) return;
        let lock = c.req > p.rank;
        let dist = Math.abs(c.dist - CONFIG.CITIES[p.city].dist);
        ch += `<div class="list-item"><div>${c.name}${c.foreign?'ğŸŒ':''}${c.casino?'ğŸ²':''}<br><small>${dist}km</small></div><div>${lock?'<span class="tag">ğŸ”’</span>':`<button class='btn-sm' onclick='tryTravel(${i})'>å‡ºå‘</button>`}</div></div>`;
    });
    document.getElementById('cityList').innerHTML = ch;
    
    // èµŒåœºå…¥å£
    let city = CONFIG.CITIES[p.city];
    document.getElementById('casinoEntry').style.display = city.casino ? 'block' : 'none';
}

// === äº¤æ˜“ä¸é€šç”¨ ===
function trade(n, amt) {
    let mk = p.market[n]; if(!mk) return;
    if(!p.inv[n]) p.inv[n] = {c:0, cost:0};
    let inv = p.inv[n];

    if(amt === 'custom') {
        showModal(`äº¤æ˜“: ${n}`, `<input type='number' id='customAmt' class='modal-input' placeholder='æ•°é‡'>`, `<button class='btn-success' onclick="commitCustomTrade('${n}')">ç¡®å®š</button>`);
        return;
    }
    if(amt === 999) amt = Math.min(Math.floor(p.money/mk.p), p.cap - getInvCount(), mk.s);
    if(amt === -999) amt = -inv.c;
    if(!amt || amt === 0) return;

    if(amt > 0) {
        if(mk.s < amt) return alert("ç¼ºè´§");
        if(getInvCount() + amt > p.cap) return alert("åŒ…æ»¡");
        if(p.money < amt*mk.p) return alert("é’±ä¸å¤Ÿ");
        inv.cost = (inv.c*inv.cost + amt*mk.p)/(inv.c+amt);
        inv.c += amt; p.money -= amt*mk.p; mk.s -= amt;
        showToast(`ä¹°å…¥ ${n} x${amt}`);
    } else {
        let sell = Math.abs(amt);
        if(inv.c < sell) return alert("ç¼ºè´§");
        let val = sell * mk.p;
        if(p.city !== p.home) {
            let limit = CONFIG.RANKS[p.rank].limit;
            if(p.sales + val > limit) return alert("å¤–åœ°é™é¢å·²æ»¡");
            p.sales += val;
        }
        p.money += val; inv.c -= sell;
        if(inv.c === 0) delete p.inv[n];
        showToast(`å–å‡º ${n} èµšÂ¥${parseInt((mk.p-inv.cost)*sell)}`);
    }
    render(); saveGame();
}
function commitCustomTrade(n) { let a = parseInt(document.getElementById('customAmt').value); closeModal(); trade(n, a); }

// === å…¶ä»–ç³»ç»Ÿ (æˆ¿äº§/é»‘å¸‚/å½©ç¥¨/å·®æ—…) ä¿æŒé€»è¾‘ä¸€è‡´ ===
function openHouseUI() {
    let h = "<div style='max-height:350px; overflow:auto;'>";
    CONFIG.ESTATES.forEach(e => {
        let btn = p.estate[e.id] ? `<button class='btn-sm' disabled>å·²æ‹¥æœ‰</button>` : `<button class='btn-sm btn-gold' onclick='buyEstate(${e.id})'>è´­ä¹°</button>`;
        h += `<div class='stock-card'><b>${e.name}</b> (${e.loc})<br><small>ä»·:Â¥${e.cost.toLocaleString()} ç§Ÿ:Â¥${e.rent}</small><div style='text-align:right'>${btn}</div></div>`;
    });
    h += "</div>"; showModal("æˆ¿äº§", h);
}
function buyEstate(id) {
    let e = CONFIG.ESTATES.find(x => x.id == id);
    if (p.money < e.cost) return alert("æ²¡é’±");
    p.money -= e.cost; p.estate[id] = true; calcTotalRent(); showToast("è´­æˆ¿æˆåŠŸ"); closeModal(); openHouseUI(); render(); saveGame();
}
function openLottoUI() { showModal("å½©ç¥¨", `<div class='lotto-card' onclick='lotto(50,200000)'>å°å¥– Â¥50</div><div class='lotto-card' onclick='lotto(1000,5000000)'>å¤§å¥– Â¥1000</div><p style='text-align:center;font-size:10px;'>ä¸­å¥–ç‡0.005%</p>`); }
function lotto(c,m){ if(p.money<c)return; p.money-=c; if(Math.random()<0.00005){let w=m*0.8; alert("ä¸­å¤´å¥–Â¥"+w); p.money+=w;} else if(Math.random()<0.1){p.money+=c*2;showToast("ä¸­Â¥"+c*2)} else showToast("æ²¡ä¸­"); render(); saveGame(); }
function openBlackUI() { if(!p.black.warn) return showModal("è­¦å‘Š", "è¿ç¦å“é£é™©ï¼", `<button class='btn-danger' onclick='p.black.warn=true;closeModal();openBlackUI()'>ç»§ç»­</button>`); let h=""; CONFIG.BLACK.forEach(g=>{h+=`<div class='list-item'>${g.n} <small>é™©${g.risk}%</small> Â¥${p.black.mkt[g.n].p} <button class='btn-sm' onclick='tb("${g.n}",1)'>ä¹°</button><button class='btn-sm' onclick='tb("${g.n}",-1)'>å–</button></div>`}); showModal("é»‘å¸‚",h); }
function tb(n,d){ if(Math.random()*100<CONFIG.BLACK.find(x=>x.n==n).risk) return gameOver("è¢«æ•"); let mk=p.black.mkt[n]; if(!p.inv[n]) p.inv[n]={c:0}; if(d>0){if(p.money>=mk.p){p.money-=mk.p;p.inv[n].c++}}else{if(p.inv[n].c>0){p.money+=mk.p;p.inv[n].c--}} openBlackUI(); render(); saveGame(); }
function openBankUI() { showModal("é“¶è¡Œ", `ç°é‡‘:Â¥${p.money}<br>å­˜:Â¥${p.bank.dep}<br>è´·:Â¥${p.bank.loan}<br><input id='bi' class='modal-input'>`, `<button onclick='bk("d")'>å­˜</button><button onclick='bk("w")'>å–</button><button onclick='bk("l")'>è´·</button><button onclick='bk("p")'>è¿˜</button>`); }
function bk(t){ let v=parseInt(document.getElementById('bi').value); if(!v)return; if(t=='d'&&p.money>=v){p.money-=v;p.bank.dep+=v} if(t=='w'&&p.bank.dep>=v){p.bank.dep-=v;p.money+=v} if(t=='l'&&v<=p.money*5){p.money+=v;p.bank.loan+=v;p.bank.due=p.day+30} if(t=='p'&&p.money>=v){let a=Math.min(v,p.bank.loan);p.money-=a;p.bank.loan-=a} closeModal();render();saveGame(); }
function openCasinoUI() { showModal("èµŒåœº", `<button class='btn-block' style='background:#500' onclick='dice(10000)'>æŠ¼Â¥1ä¸‡</button><button class='btn-block' style='background:#500' onclick='dice(100000)'>æŠ¼Â¥10ä¸‡</button>`, `<button class='btn-primary' onclick='closeModal()'>ç¦»å¼€</button>`); }
function dice(b){ if(p.money<b)return alert("æ²¡é’±"); if(Math.random()>0.5){p.money+=b;alert("èµ¢äº†Â¥"+b)}else{p.money-=b;alert("è¾“äº†")} render();saveGame(); }

// åŸºç¡€è¾…åŠ©
function openNameInput() { showModal("ğŸ‘‹ æ¬¢è¿", `<input id="sn" class="modal-input" placeholder="å…¬å¸å">`, `<button class="btn-success" onclick="p.name=document.getElementById('sn').value||'ATRI';closeModal();initGame()">å¼€å§‹</button>`); }
function showModal(t, c, f) { document.getElementById('mTitle').innerText=t; document.getElementById('mContent').innerHTML=c; document.getElementById('mFooter').innerHTML=f||`<button class="btn-primary" onclick="closeModal()">å…³é—­</button>`; document.getElementById('gameModal').style.display='flex'; }
function closeModal() { document.getElementById('gameModal').style.display='none'; }
function showToast(m) { let b=document.getElementById('gameLog'); b.innerHTML=`<div>> ${m}</div>`+b.innerHTML; }
function saveGame() { localStorage.setItem("tycoon_v85", JSON.stringify(p)); showToast("å·²å­˜æ¡£"); }
function loadGame() { let d=localStorage.getItem("tycoon_v85"); if(!d)d=localStorage.getItem("tycoon_v80"); if(d)p=JSON.parse(d); if(!p.mealCount)p.mealCount=0;}
function hardReset() { if(confirm("é‡ç½®æ‰€æœ‰è¿›åº¦ï¼Ÿ")) { localStorage.removeItem("tycoon_v85"); location.reload(); } }
function gameOver(r) { alert("ğŸ’€ " + r); hardReset(); }
function promote() { let next=CONFIG.RANKS[p.rank+1]; if(p.money>=next.cost){p.money-=next.cost; p.rank++; render(); saveGame();} }
function expandCap() { let c=p.cap*100; if(p.money>=c){p.money-=c; p.cap+=10; render(); saveGame();} }
function goHome(f) { if(f){ p.city=p.home; p.sales=0; p.visa={day:0,on:false}; render(); saveGame(); return; } tryTravel(p.home); }
function getInvCount() { let t=0; for(let k in p.inv) if(!CONFIG.BLACK.find(b=>b.n===k)) t+=p.inv[k].c; return t; }
function tryTravel(i) { let t=CONFIG.CITIES[i]; let dist=Math.abs(t.dist - CONFIG.CITIES[p.city].dist); let cost=dist<=50?20:Math.floor(dist*1.5+100); showModal("å·®æ—…", `å» ${t.name} Â¥${cost}`, `<button class='btn-dark' onclick='closeModal()'>å–æ¶ˆ</button><button class='btn-primary' onclick='commitTravel(${i},${cost})'>å‡ºå‘</button>`); }
function commitTravel(i, c) { if(p.money<c)return; p.money-=c; p.city=i; if(i==p.home) p.sales=0; if(CONFIG.CITIES[i].foreign && i!=p.home) p.visa={day:Math.min(8, Math.floor(p.money/10000)), on:true}; if(nextDay()){ refreshMarket(); closeModal(); render(); saveGame(); } }
function exportSave() { showModal("å¯¼å‡º", `<textarea class='modal-input'>${btoa(encodeURIComponent(JSON.stringify(p)))}</textarea>`); }
function importSave() { showModal("å¯¼å…¥", `<textarea id='is' class='modal-input'></textarea>`, `<button onclick='doImp()'>ç¡®å®š</button>`); }
function doImp(){ try{p=JSON.parse(decodeURIComponent(atob(document.getElementById('is').value))); saveGame(); location.reload();}catch(e){alert("æ— æ•ˆ");} }
function share() { navigator.clipboard.writeText(`ã€${p.name}ã€‘èµ„äº§Â¥${p.money}`); alert("å·²å¤åˆ¶"); }
</script>
</body>
</html>

