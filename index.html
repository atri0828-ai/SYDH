<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†ä¸šå¤§äº¨ V6.0ï¼šé»‘å¸‚é£äº‘</title>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', sans-serif; padding: 10px; max-width: 600px; margin: 0 auto; line-height: 1.5; }
        .author-tag { text-align: center; font-size: 12px; color: #58a6ff; opacity: 0.7; margin: 10px 0; letter-spacing: 1px; font-weight: bold; }
        
        .header { background: #161b22; padding: 15px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 15px; position: relative;}
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; align-items: center; }
        .company-name { color: #58a6ff; font-weight: bold; font-size: 18px; border-bottom: 1px dashed #30363d; padding-bottom: 5px; display: block; text-align: center; margin-bottom: 10px;}
        .money { color: #e3b341; font-weight: bold; font-size: 18px; }
        .rank-badge { background: #238636; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;}
        
        .panel { background: #161b22; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #30363d; }
        h3 { margin: 0 0 12px 0; color: #58a6ff; font-size: 16px; border-bottom: 1px solid #30363d; padding-bottom: 8px; display: flex; justify-content: space-between;}
        
        /* æŒ‰é’®ä¸é¢œè‰² */
        button { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; padding: 6px 12px; margin: 2px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;}
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .btn-buy { background: #238636; color: white; border: none; }
        .btn-sell { background: #da3633; color: white; border: none; }
        .btn-max { background: #1f6feb; color: white; border: none; font-size: 11px; padding: 6px 8px;}
        .btn-bank { position: absolute; top: 10px; right: 10px; background: #d29922; color: #000; font-weight: bold; border:none; }
        
        /* V6.0 é»‘å¸‚æ ·å¼ */
        .btn-black-market { width: 100%; background: #3a0000; color: #ff5252; border: 1px solid #ff5252; font-weight: bold; margin-bottom: 10px; padding: 12px; }
        .risk-tag { font-size: 10px; background: #5a0000; color: #ff5252; padding: 2px 5px; border-radius: 4px; border: 1px solid #ff5252; margin-left: 5px; }
        .umbrella-tag { font-size: 11px; color: #a371f7; border: 1px solid #a371f7; padding: 1px 4px; border-radius: 4px; margin-left: 5px; }
        
        .col-profit { color: #00e676; font-weight: bold; } 
        .col-loss { color: #ff5252; font-weight: bold; }   
        
        .stock-tag { font-size: 11px; background: #333; padding: 1px 4px; border-radius: 4px; color: #aaa; margin-left: 5px;}
        .limit-bar { font-size: 12px; color: #ff7b72; border: 1px solid #ff7b72; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-top: 5px;}
        
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #21262d; }
        .city-btn { width:100%; text-align:left; display:flex; justify-content:space-between; margin:5px 0; padding: 10px; align-items: center;}

        /* å¼¹çª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: #1c2128; padding: 20px; border-radius: 12px; border: 1px solid #444; width: 85%; max-width: 400px; text-align: center; }
        .log-area { height: 100px; overflow-y: auto; background: #0d1117; border: 1px solid #30363d; padding: 10px; font-size: 12px; color: #8b949e; border-radius: 6px; font-family: monospace; }
    </style>
</head>
<body>

<div class="author-tag">ä½œè€…: ATRI</div>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
        <div id="modalTitle" style="font-size:18px;color:#58a6ff;margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:5px;"></div>
        <div id="modalContent" style="text-align:left;font-size:14px;margin-bottom:20px;"></div>
        <div id="modalActions">
            <button onclick="closeModal()" style="width:100%">ç¡®è®¤</button>
        </div>
    </div>
</div>

<div class="header">
    <button class="btn-bank" onclick="openBank()">ğŸ¦ é“¶è¡Œ</button>
    <span id="companyDisplay" class="company-name">æœªå‘½åä¼ä¸š</span>
    <div class="stat-row">
        <span>ğŸ“… ç¬¬ <span id="dayDisplay">1</span> å¤©</span>
        <span class="money" id="moneyDisplay">Â¥1,000</span>
    </div>
    <div class="stat-row">
        <span>ğŸ“ <span id="locDisplay" style="color:#58a6ff;">æ‘å£</span> <span id="visaDisplay"></span></span>
        <span id="titleDisplay" class="rank-badge">æµåŠ¨æ‘Šè´©</span>
    </div>
    <div class="stat-row" style="font-size:12px; color:#8b949e;">
        <span>ğŸ’ å®¹é‡: <span id="capDisplay">0/50</span></span>
        <button onclick="upgradeCapacity()" style="font-size:11px; padding:2px 8px; background:#333;">â• æ‰©å®¹</button>
    </div>
    <div id="limitDisplayWrapper" style="display:none; text-align:center;">
        <span id="limitDisplay" class="limit-bar">ä»Šæ—¥å¤–åœ°å”®å–é¢åº¦: 0/100</span>
    </div>
</div>

<div class="panel">
    <button class="btn-black-market" onclick="openBlackMarket()">ğŸ’€ è¿›å…¥é»‘å¸‚ (é«˜é£é™©)</button>
    
    <h3>ğŸŒ æ­£è§„å¸‚åœº <button class="btn-rest" onclick="restDay()" style="width:auto; float:right; padding:4px 10px; margin:0;">ğŸ›Œ ä¼‘æ¯</button></h3>
    <div id="marketList"></div>
</div>

<div class="panel">
    <h3>âœˆï¸ ç§»åŠ¨ä¸ç§»æ°‘</h3>
    <button style="width:100%; background:#30363d; color:white; margin-bottom:10px;" onclick="goHome()">ğŸ  ç´§æ€¥å›å®¶ (é‡ç½®é¢åº¦)</button>
    <div id="cityList"></div>
</div>

<div class="panel">
    <h3>ğŸ’¾ ç³»ç»Ÿ</h3>
    <button onclick="shareAchievement()" style="background:#6f42c1; width:100%; margin-bottom:5px;">ğŸ† å¤åˆ¶æˆ˜ç»©</button>
    <button onclick="saveGame()">ä¿å­˜</button>
    <button onclick="exportSave()">å¯¼å‡º</button>
    <button onclick="importSave()">å¯¼å…¥</button>
    <button onclick="resetGame()" style="background:#da3633; float:right;">é‡ç½®</button>
    <textarea id="saveString" placeholder="å­˜æ¡£ç ..." style="width:100%;height:30px;margin-top:5px;background:#222;color:#fff;border:none;"></textarea>
</div>

<div class="log-area" id="gameLog"></div>
<div class="author-tag">ä½œè€…: ATRI</div>

<script>
// === 1. æ•°æ®é…ç½® (V6.0 å“ç‰ŒåŒ– + é»‘å¸‚) ===
const CITIES = [
    { name: "æ‘å£(è€å®¶)", dist: 0, reqRank: 0, isForeign: false },
    { name: "å¿åŸ", dist: 20, reqRank: 0, isForeign: false },
    { name: "çœä¼š", dist: 300, reqRank: 1, isForeign: false },
    { name: "æ¾³é—¨", dist: 1200, reqRank: 2, isForeign: false }, // æ–°å¢
    { name: "æ·±åœ³", dist: 1200, reqRank: 2, isForeign: false },
    { name: "é¦–éƒ½", dist: 1500, reqRank: 3, isForeign: false },
    { name: "é¦–å°”", dist: 2000, reqRank: 4, isForeign: true },
    { name: "é¦™æ¸¯", dist: 2500, reqRank: 5, isForeign: false },
    { name: "ä¸œäº¬", dist: 3000, reqRank: 6, isForeign: true },
    { name: "æ–°åŠ å¡", dist: 4000, reqRank: 6, isForeign: true },
    { name: "è¿ªæ‹œ", dist: 6000, reqRank: 8, isForeign: true },
    { name: "é˜¿å§†æ–¯ç‰¹ä¸¹", dist: 8500, reqRank: 8, isForeign: true }, // æ–°å¢
    { name: "ä¼¦æ•¦", dist: 9500, reqRank: 9, isForeign: true },
    { name: "æ´›æ‰çŸ¶", dist: 11000, reqRank: 9, isForeign: true }, // æ–°å¢
    { name: "æ‹‰æ–¯ç»´åŠ æ–¯", dist: 11500, reqRank: 10, isForeign: true }, // æ–°å¢
    { name: "çº½çº¦", dist: 12000, reqRank: 10, isForeign: true }
];

const RANKS = [
    { name: "æµåŠ¨æ‘Šè´©", cost: 0, limit: 100 },
    { name: "å°å–éƒ¨", cost: 3000, limit: 3000 },
    { name: "ä¾¿åˆ©åº—", cost: 10000, limit: 8000 },
    { name: "è¿é”å•†åº—", cost: 30000, limit: 25000 },
    { name: "å°å‹è¶…å¸‚", cost: 80000, limit: 60000 },
    { name: "å¤§å‹è¶…å¸‚", cost: 200000, limit: 150000 },
    { name: "è´¸æ˜“å…¬å¸", cost: 500000, limit: 500000 },
    { name: "è¿›å‡ºå£å…¬å¸", cost: 1500000, limit: 1500000 },
    { name: "è·¨å›½é›†å›¢", cost: 5000000, limit: 5000000 },
    { name: "å•†ä¸šå¸å›½", cost: 20000000, limit: 20000000 },
    { name: "ä¸–ç•Œé¦–å¯Œ", cost: 100000000, limit: 999999999 }
];

// æ­£è§„å•†å“ (å“ç‰ŒåŒ–)
const GOODS = [
    { name: "åºŸæŠ¥çº¸", base: 1, vol: 0.1, reqRank: 0, stockBase: 2000 },
    { name: "å†œå¤«å±±æ³‰", base: 2, vol: 0.1, reqRank: 0, stockBase: 1000 },
    { name: "åŒæ±‡ç«è…¿", base: 5, vol: 0.2, reqRank: 0, stockBase: 800 },
    { name: "çº¢å¡”å±±çƒŸ", base: 15, vol: 0.1, reqRank: 0, stockBase: 500 }, // æ–°å¢
    { name: "å°ç±³å……ç”µå®", base: 80, vol: 0.2, reqRank: 1, stockBase: 200 },
    { name: "å¡è¥¿æ¬§æ‰‹è¡¨", base: 300, vol: 0.3, reqRank: 1, stockBase: 100 }, // æ›¿æ¢ç”µå­è¡¨
    { name: "è€å…‹çƒé‹", base: 500, vol: 0.3, reqRank: 2, stockBase: 60 },
    { name: "Switchæ¸¸æˆæœº", base: 1800, vol: 0.3, reqRank: 2, stockBase: 50 }, // æ–°å¢
    { name: "é£å¤©èŒ…å°", base: 2800, vol: 0.5, reqRank: 3, stockBase: 30 },
    { name: "iPad Air", base: 4000, vol: 0.4, reqRank: 3, stockBase: 40 },
    { name: "é›…è¯—å…°é»›", base: 1500, vol: 0.4, reqRank: 4, stockBase: 50 },
    { name: "å¤§ç–†æ— äººæœº", base: 6000, vol: 0.5, reqRank: 4, stockBase: 20 },
    { name: "ç´¢å°¼ç”µè§†", base: 8000, vol: 0.3, reqRank: 5, stockBase: 15 },
    { name: "RTX5090æ˜¾å¡", base: 15000, vol: 0.6, reqRank: 5, stockBase: 10 },
    { name: "ä½³èƒ½å•å", base: 18000, vol: 0.4, reqRank: 6, stockBase: 10 },
    { name: "æˆ´æ£®å…¨å¥—", base: 5000, vol: 0.3, reqRank: 6, stockBase: 20 }, // æ–°å¢
    { name: "ç»å¯¹ä¼ç‰¹åŠ ", base: 800, vol: 0.5, reqRank: 7, stockBase: 120 },
    { name: "åŠ³åŠ›å£«ç»¿æ°´é¬¼", base: 80000, vol: 0.3, reqRank: 8, stockBase: 5 },
    { name: "é˜¿ç›å°¼è¥¿è£…", base: 30000, vol: 0.4, reqRank: 9, stockBase: 15 },
    { name: "ç‰¹æ–¯æ‹‰Model Y", base: 250000, vol: 0.2, reqRank: 9, stockBase: 3 }, // æ–°å¢
    { name: "çˆ±é©¬ä»•é“‚é‡‘åŒ…", base: 150000, vol: 0.5, reqRank: 10, stockBase: 5 },
    { name: "è‹±ä¼Ÿè¾¾AIèŠ¯ç‰‡", base: 300000, vol: 0.7, reqRank: 10, stockBase: 2 },
    { name: "SpaceXç»„ä»¶", base: 5000000, vol: 0.2, reqRank: 10, stockBase: 1 }
];

// é»‘å¸‚å•†å“ (ç‹¬ç«‹æ•°ç»„)
const BLACK_GOODS = [
    { name: "å‡çƒŸ", base: 200, risk: 5 },
    { name: "å‡é…’", base: 500, risk: 5 },
    { name: "è¿æ³•é•¿åˆ€", base: 1500, risk: 8 },
    { name: "å‡é’", base: 5000, risk: 20 },
    { name: "è¿æ³•æ°”æª", base: 8000, risk: 25 },
    { name: "æ¯’å“", base: 50000, risk: 75 }
];

let player = {
    companyName: null, day: 1, money: 1000, cityIdx: 0, homeIdx: 0, 
    inventory: {}, marketData: {}, rankIdx: 0, capacity: 50,
    bank: {deposit:0, loan:0, loanDeadline:0}, 
    visa: {daysLeft:0, active:false},
    dailySales: 0,
    // V6.0 æ–°å¢
    protection: 0, // ä¿æŠ¤ä¼ç­‰çº§ (0, 1=5%, 2=15%)
    blackWarned: false, // æ˜¯å¦çœ‹è¿‡é»‘å¸‚è­¦å‘Š
    blackMarketData: {} // é»‘å¸‚è¡Œæƒ…
};

window.onload = function() {
    loadGame();
    if(typeof player.dailySales === 'undefined') player.dailySales = 0;
    if(typeof player.protection === 'undefined') player.protection = 0;
    
    if (!player.companyName) {
        setTimeout(() => {
            let n = prompt("ğŸ‘‹ æ¬¢è¿è€æ¿ï¼è¯·æ³¨å†Œå…¬å¸åç§°ï¼š", "ATRIè´¸æ˜“");
            player.companyName = n || "æœªå‘½å"; render(); saveGame();
        }, 100);
    }
    if (Object.keys(player.marketData).length === 0) updateMarket(true);
    render();
};

function updateMarket(init = false) {
    // æ­£è§„å¸‚åœº
    let newM = {};
    GOODS.forEach(g => {
        if (g.reqRank <= player.rankIdx + 1) {
            let p = Math.floor(g.base * (1 + (Math.random()-0.5)*2*g.vol));
            if(p<1) p=1;
            let s = Math.floor(g.stockBase * (0.5+Math.random()));
            if(g.reqRank>=5 && Math.random()<0.25) s=0;
            newM[g.name] = { price: p, stock: s };
        }
    });
    player.marketData = newM;

    // é»‘å¸‚è¡Œæƒ… (V6.0)
    let newB = {};
    BLACK_GOODS.forEach(g => {
        let p = Math.floor(g.base * (1 + (Math.random()-0.5)*1.5)); // æ³¢åŠ¨æå¤§
        let s = Math.floor(Math.random() * 8) + 1; // åº“å­˜ä¸è¶…è¿‡8
        newB[g.name] = { price: p, stock: s, risk: g.risk };
    });
    player.blackMarketData = newB;

    if(!init) triggerRandomEvent();
}

function processDaily() {
    player.day++;
    if (player.bank.deposit > 0) player.bank.deposit += Math.floor(player.bank.deposit * 0.005);
    if (player.bank.loan > 0) {
        player.bank.loan += Math.floor(player.bank.loan * 0.02);
        if (player.day > player.bank.loanDeadline) {
            alert("ğŸš“ é€¾æœŸæœªè¿˜ï¼Œç ´äº§è¢«æ•ï¼");
            resetGame(); return false;
        }
    }
    let curCity = CITIES[player.cityIdx];
    if (curCity.isForeign && player.cityIdx !== player.homeIdx) {
        player.visa.daysLeft--;
        if (player.visa.daysLeft <= 0) {
            alert("ğŸ›‚ ç­¾è¯è¿‡æœŸï¼Œå¼ºåˆ¶é£è¿”ï¼");
            goHome(true); return false;
        }
    }
    return true;
}

function restDay() {
    if(!processDaily()) return;
    updateMarket();
    if(player.cityIdx === player.homeIdx) player.dailySales = 0;
    log("ğŸ’¤ ä¼‘æ¯äº†ä¸€å¤©ã€‚");
    render(); saveGame();
}

// === V6.0 é»‘å¸‚é€»è¾‘ ===
function openBlackMarket() {
    if (!player.blackWarned) {
        let content = `
            <div style="color:#ff5252; font-weight:bold; text-align:center; margin-bottom:10px;">âš ï¸ ä¸¥é‡è­¦å‘Š</div>
            <p>ä½ å³å°†è¿›å…¥åœ°ä¸‹é»‘å¸‚ã€‚è¿™é‡Œå‡ºå”®çš„å•†å“ï¼ˆå‡é’ã€æ¯’å“ç­‰ï¼‰å‡ä¸ºä¸¥é‡è¿æ³•ç‰©å“ã€‚</p>
            <p>1. ä»»ä½•ä¹°å–è¡Œä¸ºéƒ½æœ‰å‡ ç‡å¯¼è‡´è¢«è­¦å¯Ÿå½“åœºé€®æ•ã€‚</p>
            <p>2. ä¸€æ—¦è¢«é€®æ•ï¼Œ<b>æ¸¸æˆç›´æ¥ç»“æŸ</b>ï¼ˆåˆ æ¡£ï¼‰ã€‚</p>
            <p>3. è¿ç¦å“æ€»æºå¸¦æ•°é‡ä¸èƒ½è¶…è¿‡ 10 ä¸ªã€‚</p>
            <p style="color:#aaa; font-size:12px; margin-top:10px;">è­¦å‘Šï¼šæœ¬æ¸¸æˆå†…å®¹çº¯å±è™šæ„ï¼Œç°å®ç”Ÿæ´»ä¸­è¯·å‹¿æ¨¡ä»¿ï¼è¿œç¦»æ¯’å“ï¼Œççˆ±ç”Ÿå‘½ï¼</p>
        `;
        document.getElementById('modalTitle').innerText = "âš–ï¸ æ³•å¾‹é£é™©æç¤º";
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modalActions').innerHTML = `<button onclick="confirmBlackMarket()" style="background:#da3633; color:white;">æˆ‘å·²çŸ¥æ™“åæœï¼Œè¿›å…¥</button>`;
        document.getElementById('modalOverlay').style.display = 'flex';
    } else {
        showBlackMarketModal();
    }
}

function confirmBlackMarket() {
    player.blackWarned = true;
    closeModal();
    setTimeout(showBlackMarketModal, 200);
}

function showBlackMarketModal() {
    let umbrellaText = "æ— ";
    if (player.protection == 1) umbrellaText = "åˆçº§ (5%å…ç½ª)";
    if (player.protection == 2) umbrellaText = "é«˜çº§ (15%å…ç½ª)";

    let html = `
        <div style="background:#2d0000; padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid #5a0000;">
            <div style="font-size:12px; color:#aaa;">å½“å‰ä¿æŠ¤ä¼: <span style="color:#a371f7; font-weight:bold;">${umbrellaText}</span></div>
            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <button onclick="buyProtection(1)" style="font-size:10px; flex:1; margin-right:5px;">ğŸ’´ 10ä¸‡è´¿èµ‚ (5%)</button>
                <button onclick="buyProtection(2)" style="font-size:10px; flex:1;">ğŸ’´ 100ä¸‡è´¿èµ‚ (15%)</button>
            </div>
        </div>
        <div style="font-size:12px; color:#ff5252; margin-bottom:10px;">âš ï¸ è¿ç¦å“åªèƒ½å­˜10ä¸ªï¼Œäº¤æ˜“æœ‰è¢«æ•é£é™©ï¼</div>
    `;

    BLACK_GOODS.forEach(g => {
        let mk = player.blackMarketData[g.name];
        let inv = player.inventory[g.name] || {c:0, cost:0};
        
        // é€®æ•å‡ ç‡é¢œè‰²
        let riskColor = g.risk > 20 ? "#ff0000" : "#ff7b72";
        
        html += `
        <div class="item-row" style="border-bottom:1px solid #5a0000;">
            <div style="width:40%">
                <div style="color:#ffb0b0; font-weight:bold;">${g.name} <span class="risk-tag">è¢«æ•ç‡ ${g.risk}%</span></div>
                <div style="font-size:11px; color:#888">æŒ: ${inv.c} | ä½™: ${mk.stock}</div>
            </div>
            <div style="width:20%; color:#fff; font-weight:bold;">Â¥${mk.price}</div>
            <div style="width:40%; text-align:right;">
                <button onclick="tradeBlack('${g.name}', -1)" style="background:#5a0000; border-color:#ff5252; color:#fff; padding:2px 8px;">å–</button>
                <button onclick="tradeBlack('${g.name}', 1)" style="background:#3a0000; border-color:#ff5252; color:#fff; padding:2px 8px;" ${mk.stock<=0?'disabled':''}>ä¹°</button>
            </div>
        </div>`;
    });

    document.getElementById('modalTitle').innerText = "ğŸ’€ åœ°ä¸‹é»‘å¸‚";
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('modalActions').innerHTML = `<button onclick="closeModal()">ç¦»å¼€</button>`;
    document.getElementById('modalOverlay').style.display = 'flex';
}

function buyProtection(level) {
    let cost = level === 1 ? 100000 : 1000000;
    if (player.money < cost) { alert("èµ„é‡‘ä¸è¶³ï¼"); return; }
    if (player.protection >= level) { alert("ä½ å·²ç»æ‹¥æœ‰åŒçº§æˆ–æ›´é«˜çº§çš„ä¿æŠ¤ä¼äº†ï¼"); return; }
    
    if (confirm(`èŠ±è´¹ Â¥${cost} ç–é€šå…³ç³»ï¼Ÿ`)) {
        player.money -= cost;
        player.protection = level;
        alert("æ‰“ç‚¹æˆåŠŸï¼ç°åœ¨ä½ æœ‰ " + (level==1?"5%":"15%") + " çš„å‡ ç‡åœ¨è¢«æ•åè·æ•‘ã€‚");
        showBlackMarketModal(); // åˆ·æ–°ç•Œé¢
        render(); saveGame();
    }
}

function getIllegalCount() {
    let count = 0;
    BLACK_GOODS.forEach(g => {
        if (player.inventory[g.name]) count += player.inventory[g.name].c;
    });
    return count;
}

function tradeBlack(n, amt) {
    // 1. é£é™©åˆ¤å®š (ä¹°å–éƒ½è¦åˆ¤)
    let goodInfo = BLACK_GOODS.find(g => g.name === n);
    let risk = goodInfo.risk;
    
    // éšæœºæ•° 0-99
    let roll = Math.floor(Math.random() * 100);
    if (roll < risk) {
        // è§¦å‘è¢«æ•ï¼æ£€æŸ¥ä¿æŠ¤ä¼
        let saveRoll = Math.floor(Math.random() * 100);
        let saveChance = player.protection === 1 ? 5 : (player.protection === 2 ? 15 : 0);
        
        if (saveRoll < saveChance) {
            alert(`ğŸš“ è­¦å¯Ÿçªå‡»æ£€æŸ¥ï¼ä½ è¢«æŠ“äº†ï¼\n\n...ä½†æ˜¯ä½ çš„â€œä¿æŠ¤ä¼â€èµ·ä½œç”¨äº†ï¼Œä»–ä»¬æŠŠä½ æ”¾äº†ã€‚\n(å¤±å»æœ¬æ¬¡äº¤æ˜“æœºä¼š)`);
            return; 
        } else {
            alert(`ğŸš“ äº¤æ˜“ç°åœºè¢«è­¦å¯ŸåŒ…å›´ï¼\nä½ å› å€’å–ã€${n}ã€‘è¢«å½“åœºé€®æ•ï¼\n\nä¿æŠ¤ä¼æœªèƒ½ç”Ÿæ•ˆã€‚\n\n=== GAME OVER ===`);
            resetGame();
            return;
        }
    }

    // 2. æ­£å¸¸äº¤æ˜“é€»è¾‘
    let mk = player.blackMarketData[n];
    if (!player.inventory[n]) player.inventory[n] = { c: 0, cost: 0 };
    let inv = player.inventory[n];

    if (amt > 0) { // ä¹°
        if (getIllegalCount() + amt > 10) { alert("è¿ç¦å“æºå¸¦æ€»æ•°ä¸èƒ½è¶…è¿‡ 10 ä¸ªï¼"); return; }
        if (mk.stock < amt) { alert("åº“å­˜ä¸è¶³"); return; }
        if (player.money < mk.price) { alert("æ²¡é’±"); return; }
        
        player.money -= mk.price;
        inv.c += amt;
        inv.cost = mk.price; // ç®€å•å‡ä»·
        player.blackMarketData[n].stock -= amt;
        log(`ğŸ’€ è´­å…¥ ${n} (é£é™©é‰´å®šé€šè¿‡)`);
    } else { // å–
        if (inv.c <= 0) return;
        player.money += mk.price;
        inv.c -= 1;
        if(inv.c === 0) delete player.inventory[n];
        log(`ğŸ’€ å”®å‡º ${n} (è·å¾— Â¥${mk.price})`);
    }
    showBlackMarketModal();
    render(); saveGame();
}

// === é€šç”¨äº¤æ˜“ ===
function trade(n, amt) {
    let mk = player.marketData[n];
    if (!mk) return;
    if (!player.inventory[n]) player.inventory[n] = { c: 0, cost: 0 };
    let inv = player.inventory[n];

    if (amt === 999) { 
        let maxAfford = Math.floor(player.money / mk.price);
        let maxSpace = player.capacity - getInv();
        amt = Math.min(maxAfford, maxSpace, mk.stock);
        if (amt <= 0) return log("âŒ æ— æ³•è´­ä¹°");
    }
    if (amt === -999) { amt = -inv.c; if (amt === 0) return; }

    if (amt > 0) {
        if (mk.stock < amt) return log("âŒ åº“å­˜ä¸è¶³");
        if (getInv() + amt > player.capacity) return log("âŒ ä»“åº“å·²æ»¡");
        if (player.money < amt * mk.price) return log("âŒ èµ„é‡‘ä¸è¶³");
        let cost = amt * mk.price;
        inv.cost = (inv.c * inv.cost + cost) / (inv.c + amt);
        inv.c += amt;
        player.money -= cost;
        player.marketData[n].stock -= amt;
        log(`ğŸ›’ ä¹°å…¥ ${amt} ${n}`);
    } else {
        let sellAmt = Math.abs(amt);
        if (inv.c < sellAmt) return;
        let totalVal = sellAmt * mk.price;

        if (player.cityIdx !== player.homeIdx) {
            let maxLimit = RANKS[player.rankIdx].limit;
            if (player.dailySales + totalVal > maxLimit) {
                let left = maxLimit - player.dailySales;
                showModal("ğŸš« è´¸æ˜“é™é¢è­¦å‘Š", `å¤–åœ°é™é¢å‰©ä½™ï¼š<b>Â¥${left}</b><br>æœ¬æ¬¡äº¤æ˜“è¶…é¢ï¼è¯·å›è€å®¶é‡ç½®ã€‚`);
                return;
            }
            player.dailySales += totalVal;
        }

        player.money += totalVal;
        inv.c -= sellAmt;
        if (inv.c === 0) delete player.inventory[n];
        let profit = (mk.price - inv.cost) * sellAmt;
        log(`ğŸ’° å–å‡º ${sellAmt} ${n} (èµš${profit>=0?'+':''}${parseInt(profit)})`);
    }
    render(); saveGame();
}

function travel(i) {
    let target = CITIES[i];
    let dist = Math.abs(target.dist - CITIES[player.cityIdx].dist);
    let cost = dist <= 50 ? 20 : Math.floor(dist * 1.5 + 100);
    if (player.money < cost) return log("âŒ è·¯è´¹ä¸å¤Ÿ");
    
    let vDays = 0;
    if (target.isForeign && i !== player.homeIdx) {
        vDays = Math.min(8, Math.floor(player.money / 10000));
        if (vDays < 1) return alert("èµ„äº§ä¸è¶³1ä¸‡ï¼Œæ‹’ç­¾ï¼");
        if (!confirm(`å» ${target.name} è·¯è´¹ Â¥${cost}ï¼Œç­¾è¯ ${vDays} å¤©ï¼Ÿ`)) return;
    } else {
        if (!confirm(`å» ${target.name} è·¯è´¹ Â¥${cost}ï¼Ÿ`)) return;
    }

    if(!processDaily()) return;
    player.money -= cost;
    player.cityIdx = i;
    player.visa = (vDays > 0) ? { active: true, daysLeft: vDays } : { active: false, daysLeft: 0 };
    if (i === player.homeIdx) { player.dailySales = 0; log("ğŸ  å›å®¶ï¼Œé¢åº¦é‡ç½®ï¼"); }
    else log(`âœˆï¸ åˆ°è¾¾ ${target.name}`);
    updateMarket(); render(); saveGame();
}

// è¾…åŠ©å‡½æ•°
function closeModal() { document.getElementById('modalOverlay').style.display='none'; }
function moveHome(i, cost) {
    if (player.money < cost) return alert("æ²¡é’±ç§»æ°‘");
    if (confirm(`èŠ±è´¹ Â¥${cost} ç§»æ°‘åˆ° ${CITIES[i].name}ï¼Ÿ`)) {
        player.money -= cost; player.homeIdx = i; player.cityIdx = i;
        player.visa = { active: false, daysLeft: 0 };
        processDaily(); player.dailySales = 0; updateMarket(); render(); saveGame();
    }
}
function goHome(force) {
    let t = player.homeIdx;
    if(player.rankIdx>=5 && t<=1) t=2;
    if(player.cityIdx==t) return;
    let cost = Math.abs(CITIES[t].dist - CITIES[player.cityIdx].dist) * 1.5 + 100;
    if(force) { player.money -= cost; player.cityIdx = t; player.visa={active:false,daysLeft:0}; player.dailySales=0; render(); saveGame(); return; }
    travel(t);
}
function upgradeCapacity() {
    let c = player.capacity * 100;
    if (player.money >= c) { player.money -= c; player.capacity += 10; render(); saveGame(); } else alert("æ‰©å®¹éœ€ Â¥" + c);
}
function upgradeTitle() {
    let n = player.rankIdx + 1;
    if (player.money >= RANKS[n].cost) { player.money -= RANKS[n].cost; player.rankIdx = n; render(); saveGame(); }
}
function getInv() { 
    let t=0; 
    // åªè®¡ç®—æ­£è§„å•†å“å ç”¨å®¹é‡ (è¿ç¦å“ç‹¬ç«‹è®¡æ•°ï¼Œä¸å æ™®é€šèƒŒåŒ…ï¼Œä½†é™åˆ¶10ä¸ª)
    for(let k in player.inventory) {
        if(!BLACK_GOODS.find(b=>b.name===k)) t+=player.inventory[k].c;
    }
    return t; 
}
function renderUp() {
    let n = player.rankIdx + 1;
    if (n < RANKS.length) {
        document.getElementById("upgradeInfo").innerText = `ä¸‹çº§:${RANKS[n].name} (é™é¢:Â¥${RANKS[n].limit})`;
        document.getElementById("btnUpgrade").innerText = `æ™‹å‡ Â¥${RANKS[n].cost}`;
        document.getElementById("btnUpgrade").disabled = player.money < RANKS[n].cost;
        document.getElementById("upgradePanel").style.display = "block";
    } else { document.getElementById("upgradePanel").style.display = "none"; }
}
function triggerRandomEvent() {
    if(Math.random()>0.1) return;
    let evs = [
        {t:"é‡‘èå±æœº",b:"ç‰©ä»·æš´æ¶¨åº“å­˜å‡åŠ",f:()=>{for(let k in player.marketData){player.marketData[k].price=Math.floor(player.marketData[k].price*1.5);player.marketData[k].stock=Math.floor(player.marketData[k].stock*0.5)}}},
        {t:"å¼ºç›—",b:"è¢«æŠ¢Â¥1000",f:()=>{player.money=Math.max(0,player.money-1000)}},
        {t:"å½©ç¥¨",b:"ä¸­å¥–Â¥5000",f:()=>{player.money+=5000}}
    ];
    let e = evs[Math.floor(Math.random()*evs.length)];
    e.f(); showModal(e.t, e.b);
}
function openBank(){
    let s = `ç°é‡‘: Â¥${player.money}\nå­˜æ¬¾: Â¥${player.bank.deposit}\næ¬ æ¬¾: Â¥${player.bank.loan}`;
    let c = prompt(s + "\n1.å­˜ 2.å– 3.è´· 4.è¿˜");
    if(c==1){let v=prompt("å­˜å¤šå°‘?");if(v<=player.money){player.money-=v;player.bank.deposit+=v*1}}
    if(c==2){let v=prompt("å–å¤šå°‘?");if(v<=player.bank.deposit){player.bank.deposit-=v;player.money+=v*1}}
    if(c==3){let v=prompt("è´·å¤šå°‘?");if(v<=player.money*5){player.money+=v*1;player.bank.loan+=v*1;player.bank.loanDeadline=player.day+30}}
    if(c==4){let v=prompt("è¿˜å¤šå°‘?");if(v<=player.money){player.money-=v;player.bank.loan-=v;if(player.bank.loan<=0)player.bank.loanDeadline=0}}
    render(); saveGame();
}
function shareAchievement(){
    let txt=`ğŸš€ã€${player.companyName}ã€‘V6.0æˆ˜æŠ¥ï¼š\nèµ„äº§Â¥${(player.money+player.bank.deposit-player.bank.loan)}\nå¤´è¡”:${RANKS[player.rankIdx].name}\nä½œè€…: ATRI`;
    let i=document.createElement('textarea');i.value=txt;document.body.appendChild(i);i.select();document.execCommand('copy');document.body.removeChild(i);
    alert("å·²å¤åˆ¶ï¼");
}
function showModal(t,b){ document.getElementById('modalTitle').innerText=t; document.getElementById('modalContent').innerHTML=b; document.getElementById('modalActions').innerHTML='<button onclick="closeModal()" style="width:100%">ç¡®è®¤</button>'; document.getElementById('modalOverlay').style.display='flex'; }
function log(m){ let b=document.getElementById('gameLog'); b.innerHTML=`<div>${m}</div>`+b.innerHTML; }
function saveGame(){ localStorage.setItem("tycoon_v60", JSON.stringify(player)); }
function loadGame(){ let d=localStorage.getItem("tycoon_v60"); if(!d)d=localStorage.getItem("tycoon_v53"); if(d)player=JSON.parse(d); }
function resetGame(){ if(confirm("é‡æ¥?")) { localStorage.removeItem("tycoon_v60"); location.reload(); } }
function exportSave(){ document.getElementById('saveString').value = btoa(encodeURIComponent(JSON.stringify(player))); }
function importSave(){ try{player=JSON.parse(decodeURIComponent(atob(document.getElementById('saveString').value)));saveGame();render();alert("æˆåŠŸ")}catch(e){alert("æ— æ•ˆ")} }

function render() {
    let curCity = CITIES[player.cityIdx];
    let curRank = RANKS[player.rankIdx];
    let isHome = player.cityIdx === player.homeIdx;

    document.getElementById("companyDisplay").innerText = player.companyName || "æœªå‘½å";
    document.getElementById("dayDisplay").innerText = player.day;
    document.getElementById("moneyDisplay").innerText = "Â¥" + player.money.toLocaleString();
    let visaText = (curCity.isForeign && !isHome) ? ` (ç­¾è¯${player.visa.daysLeft}å¤©)` : (isHome ? " (åŸºåœ°)" : "");
    document.getElementById("locDisplay").innerText = curCity.name + visaText;
    document.getElementById("titleDisplay").innerText = curRank.name;
    document.getElementById("capDisplay").innerText = getInv() + "/" + player.capacity;

    let limitBox = document.getElementById("limitDisplayWrapper");
    let limitText = document.getElementById("limitDisplay");
    if (!isHome) {
        limitBox.style.display = "block";
        limitText.innerText = `ä»Šæ—¥å¤–åœ°é™é¢: ${player.dailySales} / ${curRank.limit}`;
        limitText.style.color = player.dailySales >= curRank.limit ? "#da3633" : "#ff7b72";
    } else { limitBox.style.display = "none"; }

    let h = "";
    let visibleGoods = GOODS.filter(g => g.reqRank <= player.rankIdx + 1);
    visibleGoods.forEach(g => {
        let mk = player.marketData[g.name] || {price:g.base, stock:0};
        let inv = player.inventory[g.name] || {c:0, cost:0};
        let pClass = inv.c>0 ? (mk.price > inv.cost ? "col-profit" : "col-loss") : (mk.price > g.base ? "col-profit" : "col-loss");
        let stockHtml = mk.stock>0 ? `<span class="stock-tag">ä½™:${mk.stock}</span>` : `<span style="color:#666">âŒ</span>`;
        let profitInfo = inv.c>0 ? `<br><small style="color:#888">æœ¬:Â¥${parseInt(inv.cost)}</small>` : "";

        h += `<div class="item-row">
            <div style="width:35%"><b>${g.name}</b> ${stockHtml}${profitInfo}</div>
            <div style="width:25%;text-align:center" class="${pClass}">Â¥${mk.price}</div>
            <div style="width:40%;text-align:right">
                <button class="btn-sell" onclick="trade('${g.name}',-1)">å–</button>
                <button class="btn-max" onclick="trade('${g.name}',-999)">å…¨</button>
                <button class="btn-buy" onclick="trade('${g.name}',1)" ${mk.stock<=0?'disabled':''}>ä¹°</button>
                <button class="btn-max" onclick="trade('${g.name}',999)" ${mk.stock<=0?'disabled':''}>å…¨</button>
            </div>
        </div>`;
    });
    document.getElementById("marketList").innerHTML = h;

    let ch = "";
    CITIES.forEach((c, i) => {
        if (i == player.cityIdx) return;
        if (player.rankIdx >= 5 && i <= 1) return;
        let dist = Math.abs(c.dist - curCity.dist);
        let cost = dist <= 50 ? 20 : Math.floor(dist * 1.5 + 100);
        let lock = c.reqRank > player.rankIdx;
        let moveBtn = (!lock && i !== player.homeIdx) ? `<button style="background:#58a6ff;color:#000;font-size:10px;margin-left:5px" onclick="moveHome(${i},${Math.min(3000000, cost * 100)})">ç§»æ°‘</button>` : "";
        ch += `<div class="city-btn" style="background:#21262d;border:1px solid #30363d;">
            <div style="flex:1"><div>${c.name} ${c.isForeign?'ğŸŒ':''}</div><div style="font-size:11px;color:#666">${dist}km ${moveBtn}</div></div>
            <button onclick="travel(${i})" ${lock?'disabled':''}>${lock?'ğŸ”’':`Â¥${cost}`} å‡ºå‘</button>
        </div>`;
    });
    document.getElementById("cityList").innerHTML = ch;
    renderUp();
}
</script>
</body>
</html>

