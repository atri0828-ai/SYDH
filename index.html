<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†ä¸šå¤§äº¨ V7.2ï¼šå®Œæ•´é‡åˆ¶ç‰ˆ</title>
    <style>
        :root {
            --bg: #0f1115;
            --panel: #161b22;
            --border: #30363d;
            --primary: #58a6ff;
            --green: #2ea043;
            --red: #da3633;
            --gold: #e3b341;
            --text: #c9d1d9;
            --text-dim: #8b949e;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; padding: 10px; max-width: 550px; margin: 0 auto; line-height: 1.4; padding-bottom: 50px; }
        
        /* é¡¶éƒ¨é¢æ¿ */
        .header { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .company-title { text-align: center; font-size: 18px; font-weight: 800; color: var(--primary); margin-bottom: 12px; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; }
        .stat-label { color: var(--text-dim); font-size: 11px; margin-bottom: 2px; }
        .stat-val { font-weight: bold; font-size: 14px; }
        .money-val { color: var(--gold); }
        .hp-val { color: var(--red); }
        
        .progress-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }

        /* é€šç”¨æŒ‰é’® */
        button { border: none; outline: none; border-radius: 6px; padding: 8px 12px; font-size: 13px; font-weight: 600; cursor: pointer; color: #fff; background: #21262d; border: 1px solid var(--border); transition: all 0.1s;}
        button:active { transform: scale(0.96); opacity: 0.8; }
        button:disabled { opacity: 0.5; filter: grayscale(1); }
        
        .btn-success { background: var(--green); border-color: var(--green); }
        .btn-danger { background: var(--red); border-color: var(--red); }
        .btn-primary { background: #1f6feb; border-color: #1f6feb; }
        .btn-gold { background: var(--gold); border-color: var(--gold); color: #000; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-block { width: 100%; display: block; margin-bottom: 8px; padding: 10px;}

        /* åˆ—è¡¨é¡¹ */
        .panel { background: var(--panel); padding: 12px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* å¼¹çª—ç³»ç»Ÿ */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-body { background: #1c2128; width: 92%; max-width: 420px; max-height: 85vh; border-radius: 16px; border: 1px solid #444; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; background: #222; display: flex; justify-content: space-between; align-items: center; }
        .modal-content { padding: 20px; overflow-y: auto; font-size: 14px; }
        .modal-input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; margin: 10px 0; text-align: center; }
        
        /* è‚¡ç¥¨ä¸å½©ç¥¨ */
        .stock-card { background: #111; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .stock-up { color: #ff5252; } /* æ¶¨çº¢ */
        .stock-down { color: #00e676; } /* è·Œç»¿ */
        .lotto-card { background: linear-gradient(135deg, #332244, #111); padding: 15px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #555; display: flex; justify-content: space-between; align-items: center; }

        .log-box { height: 100px; overflow-y: auto; font-size: 11px; color: #666; font-family: monospace; border-top: 1px solid #333; padding-top: 10px; margin-top: 20px; }
        .author { text-align: center; font-size: 12px; color: #333; margin: 20px 0; font-weight: bold; }
    </style>
</head>
<body>

<div id="gameModal" class="modal-mask">
    <div class="modal-body">
        <div class="modal-header"><span id="mTitle">æé†’</span><button class="btn-sm" onclick="closeModal()">Ã—</button></div>
        <div class="modal-content" id="mContent"></div>
        <div id="mFooter" style="padding:15px; border-top:1px solid #333; display:flex; justify-content:flex-end; gap:10px; background:#222;">
            <button class="btn-primary" onclick="closeModal()">ç¡®è®¤</button>
        </div>
    </div>
</div>

<div class="header">
    <div class="company-title" id="uiCompany">åˆ›ä¸šè½½å…¥ä¸­...</div>
    <div class="stat-grid">
        <div class="stat-item"><span class="stat-label">æ€»èµ„äº§</span><span class="stat-val money-val" id="uiMoney">Â¥0</span></div>
        <div class="stat-item">
            <span class="stat-label">ç”Ÿå‘½å€¼</span>
            <span class="stat-val hp-val" id="uiHp">50/50</span>
            <div class="progress-bar"><div class="progress-fill" id="uiHpBar"></div></div>
        </div>
        <div class="stat-item"><span class="stat-label">æ‰€åœ¨åœ°</span><span class="stat-val" id="uiLoc">--</span></div>
        <div class="stat-item"><span class="stat-label">å¤´è¡”</span><span class="stat-val" style="color:var(--green)" id="uiRank">--</span></div>
    </div>
    <button id="btnPromote" class="btn-block btn-gold" style="margin-top:12px; display:none;" onclick="promote()">æ™‹å‡å¤´è¡”</button>
    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:11px; color:#555;">
        <span id="uiCap">ğŸ’ 0/50</span><span id="uiLimit" style="color:var(--red)"></span>
    </div>
</div>

<div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:15px;">
    <button onclick="openBankUI()">ğŸ¦ é“¶è¡Œ</button>
    <button onclick="openStockUI()">ğŸ“ˆ è‚¡å¸‚</button>
    <button onclick="openLottoUI()">ğŸ° å½©ç¥¨</button>
    <button onclick="openBlackUI()" class="btn-danger" style="background:#300;">ğŸ’€ é»‘å¸‚</button>
</div>

<div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <b style="color:var(--primary)">ğŸŒ æ‰¹å‘å¸‚åœº</b>
        <div>
            <button class="btn-sm" onclick="expandCap()">â• æ‰©å®¹</button>
            <button class="btn-sm btn-primary" onclick="openRestUI()">ğŸ›Œ ä¼‘æ¯è¿›é£Ÿ</button>
        </div>
    </div>
    <div id="marketList"></div>
</div>

<div class="panel">
    <b style="color:var(--primary); display:block; margin-bottom:10px;">âœˆï¸ å•†åŠ¡å·®æ—…</b>
    <button class="btn-block" style="background:#222; margin-bottom:10px;" onclick="goHome()">ğŸ  å›åˆ°åŸºåœ° (é‡ç½®é¢åº¦)</button>
    <div id="cityList"></div>
</div>

<div class="panel">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
        <button onclick="share()">ğŸ† ç‚«è€€æˆ˜ç»©</button>
        <button onclick="saveGame()">ä¿å­˜å­˜æ¡£</button>
        <button onclick="exportSave()">å¯¼å‡ºä»£ç </button>
        <button onclick="importSave()">å¯¼å…¥ä»£ç </button>
    </div>
    <button class="btn-block btn-danger" style="margin-top:10px; opacity:0.6" onclick="hardReset()">â˜ ï¸ ç ´äº§æ¸…ç®—</button>
</div>

<div class="log-box" id="gameLog"></div>
<div class="author">ä½œè€…: ATRI</div>

<script>
// === æ•°æ®é…ç½® ===
const CONFIG = {
    RANKS: [
        { name: "æµåŠ¨æ‘Šè´©", cost: 0, limit: 100 }, { name: "å°å–éƒ¨", cost: 3000, limit: 3000 },
        { name: "ä¾¿åˆ©åº—", cost: 10000, limit: 8000 }, { name: "è¿é”å•†åº—", cost: 30000, limit: 25000 },
        { name: "å°å‹è¶…å¸‚", cost: 80000, limit: 60000 }, { name: "å¤§å‹è¶…å¸‚", cost: 200000, limit: 150000 },
        { name: "è´¸æ˜“å…¬å¸", cost: 500000, limit: 500000 }, { name: "è·¨å›½é›†å›¢", cost: 5000000, limit: 5000000 },
        { name: "å•†ä¸šå¸å›½", cost: 20000000, limit: 20000000 }, { name: "ä¸–ç•Œé¦–å¯Œ", cost: 100000000, limit: 999999999 }
    ],
    CITIES: [
        { name: "æ‘å£(è€å®¶)", dist: 0, req: 0, foreign: false }, { name: "å¿åŸ", dist: 20, req: 0, foreign: false },
        { name: "çœä¼š", dist: 300, req: 1, foreign: false }, { name: "æ·±åœ³", dist: 1200, req: 2, foreign: false },
        { name: "é¦–å°”", dist: 2000, req: 4, foreign: true }, { name: "ä¸œäº¬", dist: 3000, req: 6, foreign: true },
        { name: "è¿ªæ‹œ", dist: 6000, req: 8, foreign: true }, { name: "çº½çº¦", dist: 12000, req: 10, foreign: true }
    ],
    GOODS: [
        { n: "åºŸæŠ¥çº¸", b: 1, v: 0.1, r: 0, s: 2000 }, { n: "å†œå¤«å±±æ³‰", b: 2, v: 0.1, r: 0, s: 1000 },
        { n: "å°ç±³æ‰‹ç¯", b: 150, v: 0.2, r: 1, s: 200 }, { n: "Switch", b: 2000, v: 0.3, r: 2, s: 50 },
        { n: "é£å¤©èŒ…å°", b: 3000, v: 0.5, r: 3, s: 30 }, { n: "iPhone 17", b: 8000, v: 0.4, r: 5, s: 15 },
        { n: "åŠ³åŠ›å£«", b: 90000, v: 0.3, r: 8, s: 5 }, { n: "è‹±ä¼Ÿè¾¾H100", b: 250000, v: 0.7, r: 10, s: 2 }
    ],
    BLACK: [
        { n: "å‡é’", b: 10000, risk: 20 }, { n: "ç®¡åˆ¶åˆ€å…·", b: 2000, risk: 8 }, { n: "æ¯’å“", b: 60000, risk: 75 }
    ],
    STOCKS: [
        { n: "ä¼¯å…‹å¸Œå°”", b: 4000000, min: 2000, max: 8000000, v: 0.02 },
        { n: "è‹±ä¼Ÿè¾¾", b: 15000, min: 2000, max: 8000000, v: 0.08 },
        { n: "è´µå·èŒ…å°", b: 18000, min: 2000, max: 8000000, v: 0.03 },
        { n: "ç‰¹æ–¯æ‹‰", b: 6000, min: 2000, max: 8000000, v: 0.10 },
        { n: "å¯å£å¯ä¹", b: 3000, min: 2000, max: 8000000, v: 0.01 }
    ]
};

// === ç©å®¶çŠ¶æ€ ===
let p = {
    name: null, day: 1, money: 1000, hp: 50, city: 0, home: 0, rank: 0, cap: 50,
    inv: {}, market: {}, bank: { dep: 0, loan: 0, due: 0 }, visa: { day: 0, on: false },
    sales: 0, black: { warn: false, mkt: {} }, prot: 0, stock: { open: false, port: {}, mkt: [] }
};

// === æ ¸å¿ƒé€»è¾‘ ===

window.onload = () => {
    loadGame();
    if (!p.name) {
        showModal("ğŸ‘‹ æ¬¢è¿åˆ›ä¸š", `<p>è¯·è¾“å…¥ä½ çš„å…¬å¸åï¼š</p><input id="sn" class="modal-input" placeholder="ATRIè´¸æ˜“">`, 
        `<button class="btn-primary" onclick="startGame()">å¼€å§‹æˆ‘çš„ä¼ å¥‡</button>`);
    } else { initGame(); }
};

function startGame() {
    p.name = document.getElementById('sn').value || "æœªå‘½åä¼ä¸š";
    closeModal(); initGame();
}

function initGame() {
    if (!p.market || Object.keys(p.market).length === 0) refreshMarket(true);
    if (!p.stock.mkt || p.stock.mkt.length === 0) {
        p.stock.mkt = CONFIG.STOCKS.map(s => ({ n: s.n, p: s.b, hist: [s.b, s.b, s.b, s.b, s.b], chg: 0 }));
    }
    render();
}

function refreshMarket(init = false) {
    let nm = {};
    CONFIG.GOODS.forEach(g => {
        if (g.r <= p.rank + 1) {
            let pr = Math.floor(g.b * (1 + (Math.random()-0.5)*2*g.v));
            nm[g.n] = { p: Math.max(1, pr), s: Math.floor(g.s * (0.5+Math.random())) };
        }
    });
    p.market = nm;

    let bm = {};
    CONFIG.BLACK.forEach(g => {
        bm[g.n] = { p: Math.floor(g.b*(0.5+Math.random()*1.5)), s: Math.floor(Math.random()*8)+1, r: g.risk };
    });
    p.black.mkt = bm;

    p.stock.mkt.forEach((s, i) => {
        let conf = CONFIG.STOCKS[i];
        let old = s.p;
        let np = Math.floor(old * (1 + (Math.random()-0.5)*2*conf.v));
        s.p = Math.min(conf.max, Math.max(conf.min, np));
        s.chg = ((s.p-old)/old*100).toFixed(2);
        s.hist.push(s.p); if(s.hist.length>7) s.hist.shift();
    });
}

function nextDay() {
    p.day++;
    // V7.2 æ ¸å¿ƒæœºåˆ¶ï¼šç”Ÿå‘½å€¼ä¸º0åä¸ç»“æŸï¼Œæ‰£75%èµ„äº§
    if (p.hp <= 0) {
        let cost = Math.floor(p.money * 0.75);
        p.money -= cost;
        p.hp = 20;
        showModal("ğŸ¥ ç´§æ€¥æŠ¢æ•‘", `<p>ä½ å› ä¸ºä½“åŠ›è€—å°½æ™•å€’äº†ï¼</p><p>æŠ¢æ•‘è´¹ç”¨(èµ„äº§çš„75%)ï¼š<b class='text-down'>Â¥${cost.toLocaleString()}</b></p><p>ç”Ÿå‘½æ¢å¤è‡³ 20ã€‚</p>`);
        return false;
    }
    // é“¶è¡Œä¸åˆ©æ¯
    if (p.bank.dep > 0) p.bank.dep += Math.floor(p.bank.dep * 0.005);
    if (p.bank.loan > 0) {
        p.bank.loan += Math.floor(p.bank.loan * 0.02);
        if (p.day > p.bank.due) { gameOver("æ¬ å€ºä¸è¿˜ï¼Œè¢«æ•å…¥ç‹±ï¼"); return false; }
    }
    // ç­¾è¯
    if (CONFIG.CITIES[p.city].foreign && p.city !== p.home) {
        p.visa.day--;
        if (p.visa.day <= 0) { alert("ç­¾è¯åˆ°æœŸï¼Œå¼ºåˆ¶é£è¿”ï¼"); goHome(true); return false; }
    }
    return true;
}

// === èœå•åŠŸèƒ½ ===

function openRestUI() {
    let html = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button onclick="doRest(1)" style="padding:15px; background:#222;">ğŸ›µ <b>ç‚¹å¤–å–</b><br><span class='text-down'>-5%èµ„</span><span class='text-up'>+3HP</span></button>
            <button onclick="doRest(2)" style="padding:15px; background:#222;">ğŸ³ <b>è‡ªå·±åš</b><br><span class='text-down'>-10%èµ„</span><span class='text-up'>+5HP</span></button>
            <button onclick="doRest(3)" style="padding:15px; background:#222;">ğŸ½ï¸ <b>é¤é¦†åƒ</b><br><span class='text-down'>-15%èµ„</span><span class='text-up'>+8HP</span></button>
            <button onclick="doRest(4)" style="padding:15px; border-color:var(--red);">ğŸ’€ <b>ä¸åƒ</b><br><span>å…è´¹</span><span class='text-down'>-10HP</span></button>
        </div>
    `;
    showModal("ğŸ›Œ ä¼‘æ¯è¿›é£Ÿ", html);
}

function doRest(type) {
    let costPerc = [0.05, 0.10, 0.15, 0][type-1];
    let hpAdd = [3, 5, 8, -10][type-1];
    let cost = Math.floor(p.money * costPerc);
    
    if(p.money < cost) return alert("é’±ä¸å¤Ÿåƒè¿™ä¸€é¡¿ï¼");
    
    p.money -= cost;
    p.hp = Math.min(50, p.hp + hpAdd);
    closeModal();
    
    if(nextDay()) {
        refreshMarket();
        if(p.city === p.home) p.sales = 0;
        log(`ä¼‘æ¯äº†ï¼ŒèŠ±è´¹ Â¥${cost}ï¼Œç”Ÿå‘½${hpAdd>=0?'+':''}${hpAdd}`);
    }
    render(); saveGame();
}

function trade(n, amt) {
    let mk = p.market[n];
    if(!mk) return;
    if(!p.inv[n]) p.inv[n] = {c:0, cost:0};
    let inv = p.inv[n];

    // V7.2 è‡ªå®šä¹‰æ•°é‡é€»è¾‘
    if(amt === 'custom') {
        showModal(`äº¤æ˜“: ${n}`, `<p>å•ä»·: Â¥${mk.p}</p><p>æ­£æ•°ä¹°å…¥ï¼Œè´Ÿæ•°å–å‡ºï¼š</p><input type='number' id='customAmt' class='modal-input' placeholder='æ•°é‡'>`, 
        `<button class='btn-success' onclick="commitCustomTrade('${n}')">ç¡®å®š</button>`);
        return;
    }

    if(amt === 999) amt = Math.min(Math.floor(p.money/mk.p), p.cap - getInvCount(), mk.s);
    if(amt === -999) amt = -inv.c;
    if(!amt || amt === 0) return;

    if(amt > 0) { // ä¹°
        if(mk.s < amt) return alert("å¸‚åœºè´§æºä¸è¶³");
        if(getInvCount() + amt > p.cap) return alert("èƒŒåŒ…æ²¡ç©ºä½");
        let cost = amt * mk.p;
        if(p.money < cost) return alert("é’±ä¸å¤Ÿ");
        
        inv.cost = (inv.c*inv.cost + cost)/(inv.c+amt);
        inv.c += amt; p.money -= cost; mk.s -= amt;
        log(`è¿›è´§ ${n} x${amt}`);
    } else { // å–
        let sell = Math.abs(amt);
        if(inv.c < sell) return alert("ä½ æ²¡é‚£ä¹ˆå¤šè´§");
        let val = sell * mk.p;
        
        if(p.city !== p.home) {
            let limit = CONFIG.RANKS[p.rank].limit;
            if(p.sales + val > limit) return alert("å¤–åœ°è´¸æ˜“é™é¢å·²æ»¡ï¼è¯·å›åŸºåœ°ã€‚");
            p.sales += val;
        }
        
        p.money += val; inv.c -= sell;
        if(inv.c === 0) delete p.inv[n];
        log(`å‡ºè´§ ${n} x${sell} èµšÂ¥${parseInt((mk.p-inv.cost)*sell)}`);
    }
    render(); saveGame();
}

function commitCustomTrade(n) {
    let a = parseInt(document.getElementById('customAmt').value);
    closeModal(); trade(n, a);
}

// --- å½©ç¥¨ä¸ç¨ ---
function openLottoUI() {
    showModal("ğŸ° å¹¸è¿åˆ®åˆ®ä¹", `
        <div class="lotto-card" onclick="lotto(50, 200000)"><div>å‘è´¢æ¢¦</div><b style='color:gold'>Â¥50</b></div>
        <div class="lotto-card" onclick="lotto(150, 800000)"><div>æš´å¯Œæµ</div><b style='color:gold'>Â¥150</b></div>
        <div class="lotto-card" onclick="lotto(1000, 5000000)"><div>é€†å¤©æ”¹å‘½</div><b style='color:gold'>Â¥1000</b></div>
        <center><small style='color:#444'>ä¸­å¥–ç‡ 0.005%</small></center>
    `);
}
function lotto(cost, max) {
    if(p.money < cost) return alert("é’±ä¸å¤Ÿä¹°è¿™å¼ å½©ç¥¨");
    p.money -= cost;
    
    // V7.2 æä½ä¸­å¥–ç‡
    if(Math.random() < 0.00005) {
        let tax = Math.floor(max * 0.2);
        let final = max - tax;
        showModal("ğŸ‰ å¤©é™æ¨ªè´¢ï¼ï¼", `<p>ä½ åˆ®ä¸­äº†å¤´å¥– Â¥${max.toLocaleString()}ï¼</p><p>æ ¹æ®æ³•å¾‹æ‰£é™¤å¶ç„¶æ‰€å¾—ç¨ï¼šÂ¥${tax.toLocaleString()}</p><p>å®é™…åˆ°æ‰‹ï¼š<b class='text-up'>Â¥${final.toLocaleString()}</b></p>`);
        p.money += final;
    } else if(Math.random() < 0.1) {
        let win = cost * 2; p.money += win; log(`ä¸­äº†å°å¥– Â¥${win}`);
    } else { log("æ²¡ä¸­å¥–ï¼Œå†æ¥å†å‰ã€‚"); }
    render(); saveGame();
}

// === æ¸²æŸ“æ ¸å¿ƒ ===
function render() {
    document.getElementById('uiCompany').innerText = p.name;
    document.getElementById('uiMoney').innerText = "Â¥" + p.money.toLocaleString();
    document.getElementById('uiHp').innerText = `${p.hp}/50`;
    document.getElementById('uiHpBar').style.width = (p.hp/50*100) + "%";
    document.getElementById('uiLoc').innerText = CONFIG.CITIES[p.city].name;
    document.getElementById('uiRank').innerText = CONFIG.RANKS[p.rank].name;
    document.getElementById('uiCap').innerText = `ğŸ’ ${getInvCount()}/${p.cap}`;
    
    // æ™‹å‡
    let next = CONFIG.RANKS[p.rank + 1];
    let btnP = document.getElementById('btnPromote');
    if(next) {
        btnP.style.display = "block";
        btnP.innerText = `æ™‹å‡: ${next.name} (éœ€Â¥${next.cost.toLocaleString()})`;
        btnP.disabled = p.money < next.cost;
    } else { btnP.style.display = "none"; }
    
    if(p.city !== p.home) document.getElementById('uiLimit').innerText = `é™é¢: Â¥${parseInt(p.sales)}/Â¥${CONFIG.RANKS[p.rank].limit}`;
    else document.getElementById('uiLimit').innerText = "";

    // å¸‚åœº
    let h = "";
    CONFIG.GOODS.forEach(g => {
        if (g.r <= p.rank + 1) {
            let mk = p.market[g.n] || {p:0, s:0};
            let inv = p.inv[g.n] || {c:0, cost:0};
            let col = inv.c > 0 ? (mk.p > inv.cost ? "text-up" : "text-down") : "";
            h += `<div class="list-item">
                <div style="flex:1"><b>${g.n}</b> <span class="tag">ä½™${mk.s}</span><br><small>æŒ:${inv.c} ${inv.c>0?'æœ¬:'+parseInt(inv.cost):''}</small></div>
                <div style="flex:1; text-align:center" class="${col}">Â¥${mk.p}</div>
                <div>
                    <button class="btn-sm btn-danger" onclick="trade('${g.n}', -999)">å…¨å–</button>
                    <button class="btn-sm" style="background:#555" onclick="trade('${g.n}', 'custom')">è‡ª</button>
                    <button class="btn-sm btn-success" onclick="trade('${g.n}', 1)" ${mk.s<=0?'disabled':''}>ä¹°</button>
                </div>
            </div>`;
        }
    });
    document.getElementById('marketList').innerHTML = h;

    // åŸå¸‚
    let ch = "";
    CONFIG.CITIES.forEach((c, i) => {
        if (i === p.city) return;
        if (p.rank >= 5 && i <= 1) return;
        let lock = c.req > p.rank;
        let dist = Math.abs(c.dist - CONFIG.CITIES[p.city].dist);
        ch += `<div class="list-item"><div>${c.name}${c.foreign?'ğŸŒ':''}<br><small>${dist}km</small></div>
        <div>${lock?'<span class="tag">ğŸ”’</span>':`<button class='btn-sm' onclick='tryTravel(${i})'>å‡ºå‘</button>`}</div></div>`;
    });
    document.getElementById('cityList').innerHTML = ch;
}

// --- é“¶è¡Œ/è‚¡ç¥¨/é»‘å¸‚ UI (ç”±äºåŠŸèƒ½æˆç†Ÿï¼Œä¿æŒV7.1é€»è¾‘ä½†ä¼˜åŒ–å¤–è§‚) ---
function openBankUI() {
    showModal("ğŸ¦ ç‘å£«é“¶è¡Œ", `ç°é‡‘: Â¥${p.money.toLocaleString()}<br>å­˜æ¬¾: Â¥${p.bank.dep.toLocaleString()}<br>è´·æ¬¾: Â¥${p.bank.loan.toLocaleString()}<hr><input id='bi' class='modal-input' placeholder='é‡‘é¢'>`, `
        <button class='btn-success' onclick='bk("d")'>å­˜é’±</button><button class='btn-gold' onclick='bk("w")'>å–é’±</button><br>
        <button class='btn-danger' onclick='bk("l")'>è´·æ¬¾</button><button class='btn-primary' onclick='bk("p")'>è¿˜æ¬¾</button>
    `);
}
function bk(t){
    let v = parseInt(document.getElementById('bi').value); if(!v || v<=0) return;
    if(t=='d' && p.money>=v){ p.money-=v; p.bank.dep+=v; }
    if(t=='w' && p.bank.dep>=v){ p.bank.dep-=v; p.money+=v; }
    if(t=='l' && v<=p.money*5){ p.money+=v; p.bank.loan+=v; p.bank.due=p.day+30; }
    if(t=='p' && p.money>=v){ let act=Math.min(v, p.bank.loan); p.money-=act; p.bank.loan-=act; }
    closeModal(); render(); saveGame();
}

function openStockUI() {
    if(!p.stock.open) return showModal("ğŸ“ˆ å¼€é€šè‚¡å¸‚", "éœ€æ”¯ä»˜ Â¥1000 å¼€æˆ·è´¹", `<button class='btn-success' onclick='if(p.money>=1000){p.money-=1000;p.stock.open=true;closeModal();openStockUI();render();}'>ç¡®è®¤æ”¯ä»˜</button>`);
    let h = "<div style='max-height:350px; overflow:auto;'>";
    p.stock.mkt.forEach((s, i) => {
        let hold = p.stock.port[s.n] || {c:0};
        let color = s.chg >= 0 ? "var(--red)" : "var(--green)";
        h += `<div class='stock-card'><b>${s.n}</b> <span style='color:${color}; float:right;'>Â¥${s.p} (${s.chg}%)</span><br><small>æŒä»“: ${hold.c}</small>
        <div style='margin-top:10px; display:flex; gap:5px;'>
            <button class='btn-sm btn-success' onclick='st("${s.n}", 100)' style='flex:1'>ä¹°100</button>
            <button class='btn-sm btn-danger' onclick='st("${s.n}", -100)' style='flex:1'>å–100</button>
        </div></div>`;
    });
    h += "</div>";
    showModal("ğŸ“ˆ è¯åˆ¸äº¤æ˜“æ‰€", h);
}
function st(n, a){
    let s=p.stock.mkt.find(x=>x.n==n); let h=p.stock.port[n]||{c:0};
    if(a>0 && p.money >= a*s.p){ p.money-=a*s.p; h.c+=a; }
    else if(a<0 && h.c >= Math.abs(a)){ p.money+=Math.abs(a)*s.p; h.c-=Math.abs(a); }
    p.stock.port[n]=h; openStockUI(); render(); saveGame();
}

function openBlackUI() {
    if(!p.black.warn) return showModal("âš ï¸ æç«¯è­¦å‘Š", "è¿ç¦å“äº¤æ˜“å¯èƒ½å¯¼è‡´æ²¡æ”¶å…¨éƒ¨èµ„äº§ç”šè‡³å…¥ç‹±ï¼", `<button class='btn-danger' onclick='p.black.warn=true;closeModal();openBlackUI();'>æˆ‘çŸ¥æ³•çŠ¯æ³•</button>`);
    let h = ""; CONFIG.BLACK.forEach(g => {
        h += `<div class='list-item'><div>${g.n} <small class='text-down'>é™©${g.risk}%</small></div><div>Â¥${p.black.mkt[g.n].p}</div><div>
        <button class='btn-sm' onclick='tb("${g.n}", 1)'>ä¹°</button><button class='btn-sm' onclick='tb("${g.n}", -1)'>å–</button></div></div>`;
    });
    showModal("ğŸ’€ é»‘å¸‚", h);
}
function tb(n, d){
    let g = CONFIG.BLACK.find(x=>x.n==n);
    if(Math.random()*100 < g.risk) { gameOver("å€’å–è¿ç¦å“è¢«æ•ï¼èµ„äº§æ¸…é›¶ï¼"); return; }
    let mk = p.black.mkt[n]; if(!p.inv[n]) p.inv[n]={c:0};
    if(d>0){ if(p.money>=mk.p){p.money-=mk.p; p.inv[n].c++} }
    else { if(p.inv[n].c>0){p.money+=mk.p; p.inv[n].c--} }
    openBlackUI(); render(); saveGame();
}

// åŸºç¡€è¾…åŠ©
function showModal(t, c, f) { 
    document.getElementById('mTitle').innerText=t; 
    document.getElementById('mContent').innerHTML=c; 
    document.getElementById('mFooter').innerHTML=f || `<button class="btn-primary" onclick="closeModal()">å…³é—­</button>`;
    document.getElementById('gameModal').style.display='flex'; 
}
function closeModal() { document.getElementById('gameModal').style.display='none'; }
function getInvCount() { let t=0; for(let k in p.inv) if(!CONFIG.BLACK.find(b=>b.n===k)) t+=p.inv[k].c; return t; }
function saveGame() { localStorage.setItem("tycoon_v72", JSON.stringify(p)); }
function loadGame() { let d=localStorage.getItem("tycoon_v72"); if(d) p=JSON.parse(d); }
function hardReset() { if(confirm("é‡ç½®æ‰€æœ‰è¿›åº¦ï¼Ÿ")) { localStorage.removeItem("tycoon_v72"); location.reload(); } }
function gameOver(r) { alert("ğŸ’€ " + r); hardReset(); }
function promote() { let next=CONFIG.RANKS[p.rank+1]; if(p.money>=next.cost){p.money-=next.cost; p.rank++; render(); saveGame();} }
function expandCap() { let c=p.cap*100; if(p.money>=c){p.money-=c; p.cap+=10; render(); saveGame();} }
function goHome(f) { if(f){ p.city=p.home; p.sales=0; p.visa={day:0,on:false}; render(); saveGame(); return; } tryTravel(p.home); }
function tryTravel(i) {
    let t=CONFIG.CITIES[i]; let dist=Math.abs(t.dist - CONFIG.CITIES[p.city].dist);
    let cost=dist<=50?20:Math.floor(dist*1.5+100);
    showModal("å·®æ—…", `å‰å¾€ ${t.name}ï¼Œç¥¨ä»· Â¥${cost}`, `<button class='btn-dark' onclick='closeModal()'>å–æ¶ˆ</button><button class='btn-primary' onclick='commitTravel(${i},${cost})'>å‡ºå‘</button>`);
}
function commitTravel(i, c) {
    if(p.money<c) return; p.money-=c; p.city=i; if(i==p.home) p.sales=0;
    if(CONFIG.CITIES[i].foreign && i!=p.home) p.visa={day:Math.min(8, Math.floor(p.money/10000)), on:true};
    if(nextDay()){ refreshMarket(); closeModal(); render(); saveGame(); }
}
function exportSave() { showModal("å¯¼å‡ºå­˜æ¡£", `<textarea class='modal-input' style='height:100px'>${btoa(encodeURIComponent(JSON.stringify(p)))}</textarea>`); }
function importSave() { showModal("å¯¼å…¥å­˜æ¡£", `<textarea id='is' class='modal-input' placeholder='ä»£ç '></textarea>`, `<button class='btn-success' onclick='doImp()'>å¯¼å…¥</button>`); }
function doImp(){ try{p=JSON.parse(decodeURIComponent(atob(document.getElementById('is').value))); saveGame(); location.reload();}catch(e){alert("é”™è¯¯");} }
function share() { navigator.clipboard.writeText(`ã€${p.name}ã€‘èµ„äº§Â¥${p.money}`); alert("å·²å¤åˆ¶æˆ˜ç»©"); }
function log(m) { let b=document.getElementById('gameLog'); b.innerHTML=`<div>> ${m}</div>`+b.innerHTML; }
function randomEvent() { if(Math.random()<0.1) log("ä»Šå¤©å¸‚åœºé£å¹³æµªé™ã€‚"); }
</script>
</body>
</html>

