<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†ä¸šå¤§äº¨ V5.0ï¼šé‡‘èé£æš´</title>
    <style>
        /* V5.0 æ ·å¼å‡çº§ */
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', sans-serif; padding: 10px; max-width: 600px; margin: 0 auto; line-height: 1.5; }
        
        .header { background: #161b22; padding: 15px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 15px; position: relative;}
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; align-items: center; }
        .company-name { color: #58a6ff; font-weight: bold; font-size: 18px; border-bottom: 1px dashed #30363d; padding-bottom: 5px; display: block; text-align: center; margin-bottom: 10px;}
        .money { color: #e3b341; font-weight: bold; font-size: 18px; }
        .rank-badge { background: #238636; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;}
        
        .panel { background: #161b22; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #30363d; }
        h3 { margin: 0 0 12px 0; color: #58a6ff; font-size: 16px; border-bottom: 1px solid #30363d; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
        
        /* æŒ‰é’®ç»„ */
        button { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; padding: 6px 12px; margin: 2px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;}
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        .btn-buy { background: #238636; color: white; border: none; }
        .btn-sell { background: #da3633; color: white; border: none; }
        .btn-max { background: #1f6feb; color: white; border: none; font-size: 11px; padding: 6px 8px;}
        .btn-rest { background: #1f6feb; color: white; width: 100%; font-weight: bold; padding: 12px; margin: 0 0 10px 0;}
        .btn-bank { position: absolute; top: 10px; right: 10px; background: #d29922; color: #000; font-weight: bold; border:none; box-shadow: 0 0 5px #d29922;}
        
        /* é¢œè‰²é€»è¾‘ */
        .col-profit { color: #00e676; font-weight: bold; } 
        .col-loss { color: #ff5252; font-weight: bold; }   
        .col-neutral { color: #ffffff; }                   
        
        .stock-tag { font-size: 11px; background: #333; padding: 1px 4px; border-radius: 4px; color: #aaa; margin-left: 5px;}
        .visa-tag { background: #d29922; color: black; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 5px; }

        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #21262d; }
        .city-btn { width:100%; text-align:left; display:flex; justify-content:space-between; margin:5px 0; padding: 10px; align-items: center;}

        /* å¼¹çª— Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: #1c2128; padding: 20px; border-radius: 12px; border: 1px solid #444; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.8); }
        .modal-title { font-size: 18px; color: #58a6ff; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .modal-content { font-size: 14px; margin-bottom: 20px; line-height: 1.6; text-align: left;}
        .modal-input { width: 80%; padding: 8px; margin: 10px 0; background: #0d1117; border: 1px solid #30363d; color: white; border-radius: 4px; text-align: center;}
        
        .log-area { height: 100px; overflow-y: auto; background: #0d1117; border: 1px solid #30363d; padding: 10px; font-size: 12px; color: #8b949e; border-radius: 6px; font-family: monospace; }
    </style>
</head>
<body>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
        <div id="modalTitle" class="modal-title">æ ‡é¢˜</div>
        <div id="modalContent" class="modal-content">å†…å®¹</div>
        <div id="modalActions"></div>
    </div>
</div>

<div class="header">
    <button class="btn-bank" onclick="openBank()">ğŸ¦ é“¶è¡Œ</button>
    <span id="companyDisplay" class="company-name">æœªå‘½åä¼ä¸š</span>
    <div class="stat-row">
        <span>ğŸ“… ç¬¬ <span id="dayDisplay">1</span> å¤©</span>
        <span class="money" id="moneyDisplay">Â¥1,000</span>
    </div>
    <div class="stat-row">
        <span>ğŸ“ <span id="locDisplay" style="color:#58a6ff;">æ‘å£</span> <span id="visaDisplay"></span></span>
        <span id="titleDisplay" class="rank-badge">æµåŠ¨æ‘Šè´©</span>
    </div>
    <div class="stat-row" style="font-size:12px; color:#8b949e;">
        <span>ğŸ’ å®¹é‡: <span id="capDisplay">0/50</span></span>
        <button onclick="upgradeCapacity()" style="font-size:11px; padding:2px 8px; background:#333;">â• æ‰©å®¹</button>
    </div>
</div>

<div class="panel" id="upgradePanel">
    <h3>ğŸ“ˆ å•†ä¸šç‰ˆå›¾</h3>
    <div id="upgradeInfo" style="font-size:13px; margin-bottom:10px; color:#8b949e;"></div>
    <button id="btnUpgrade" style="width:100%; background:#d29922; color:black; font-weight:bold;" onclick="upgradeTitle()">å‡çº§å¤´è¡”</button>
</div>

<div class="panel">
    <h3>
        <span>ğŸŒ <span id="marketTitle">æ‰¹å‘å¸‚åœº</span></span>
    </h3>
    <button class="btn-rest" onclick="restDay()">ğŸ›Œ ä¼‘æ¯ä¸€å¤© (åˆ·æ–°å¸‚åœº)</button>
    <div id="marketList"></div>
</div>

<div class="panel">
    <h3>âœˆï¸ å·®æ—…ä¸ç§»æ°‘</h3>
    <button style="width:100%; background:#1f6feb; color:white; margin-bottom:10px;" onclick="goHome()">ğŸ  ç´§æ€¥å›å›½/å›è€å®¶</button>
    <div id="cityList"></div>
</div>

<div class="panel">
    <h3>ğŸ’¾ ç³»ç»Ÿ</h3>
    <button onclick="saveGame()">ä¿å­˜</button>
    <button onclick="resetGame()" style="background:#da3633">é‡ç½®</button>
</div>

<div class="log-area" id="gameLog"></div>

<script>
// === 1. æ•°æ®é…ç½® ===
// åŸå¸‚é…ç½®ï¼šisForeign: true ä»£è¡¨å›½å¤–
const CITIES = [
    { name: "æ‘å£(è€å®¶)", dist: 0, reqRank: 0, isForeign: false },
    { name: "å¿åŸå¸‚åœº", dist: 20, reqRank: 0, isForeign: false },
    { name: "çœä¼šåŸå¸‚", dist: 300, reqRank: 1, isForeign: false },
    { name: "å—äº¬", dist: 800, reqRank: 1, isForeign: false }, // æ–°å¢
    { name: "è¥¿å®‰", dist: 1000, reqRank: 2, isForeign: false }, // æ–°å¢
    { name: "æ·±åœ³", dist: 1200, reqRank: 2, isForeign: false },
    { name: "é¦–éƒ½", dist: 1500, reqRank: 3, isForeign: false },
    { name: "å“ˆå°”æ»¨", dist: 1800, reqRank: 3, isForeign: false }, // æ–°å¢
    { name: "é¦–å°”", dist: 2000, reqRank: 4, isForeign: true },
    { name: "é¦™æ¸¯", dist: 2500, reqRank: 5, isForeign: false }, // é¦™æ¸¯ç®—å›½å†…é•¿é€”
    { name: "ä¸œäº¬", dist: 3000, reqRank: 6, isForeign: true },
    { name: "æ–°åŠ å¡", dist: 4000, reqRank: 6, isForeign: true }, // æ–°å¢
    { name: "è¿ªæ‹œ", dist: 6000, reqRank: 8, isForeign: true },
    { name: "è«æ–¯ç§‘", dist: 7000, reqRank: 7, isForeign: true },
    { name: "æ‚‰å°¼", dist: 8000, reqRank: 7, isForeign: true },
    { name: "ä¼¦æ•¦", dist: 9500, reqRank: 9, isForeign: true },
    { name: "çº½çº¦", dist: 12000, reqRank: 10, isForeign: true },
    { name: "å—æç«™", dist: 18000, reqRank: 10, isForeign: true }
];

// å¤´è¡”ä¸å†å¢åŠ å®¹é‡
const RANKS = [
    { name: "æµåŠ¨æ‘Šè´©", cost: 0 },
    { name: "å°å–éƒ¨", cost: 3000 },
    { name: "ä¾¿åˆ©åº—", cost: 10000 },
    { name: "è¿é”å•†åº—", cost: 30000 },
    { name: "å°å‹è¶…å¸‚", cost: 80000 },
    { name: "å¤§å‹è¶…å¸‚", cost: 200000 }, // ç­‰çº§5ï¼Œè§£é”åå±è”½æ‘å£å’Œå¿åŸ
    { name: "è´¸æ˜“å…¬å¸", cost: 500000 },
    { name: "è¿›å‡ºå£å…¬å¸", cost: 1500000 },
    { name: "è·¨å›½é›†å›¢", cost: 5000000 },
    { name: "å•†ä¸šå¸å›½", cost: 20000000 },
    { name: "ä¸–ç•Œé¦–å¯Œ", cost: 100000000 }
];

const GOODS = [
    { name: "çŸ¿æ³‰æ°´", base: 2, vol: 0.1, reqRank: 0, stockBase: 1000 },
    { name: "ç«è…¿è‚ ", base: 5, vol: 0.2, reqRank: 0, stockBase: 800 },
    { name: "åœŸç‰¹äº§", base: 50, vol: 0.3, reqRank: 0, stockBase: 200 },
    { name: "é›¨èŠ±çŸ³", base: 80, vol: 0.4, reqRank: 1, stockBase: 100 }, // å—äº¬
    { name: "å…µé©¬ä¿‘ä»¿å“", base: 150, vol: 0.3, reqRank: 2, stockBase: 80 }, // è¥¿å®‰
    { name: "ç”µå­è¡¨", base: 100, vol: 0.3, reqRank: 2, stockBase: 150 },
    { name: "è¿åŠ¨é‹", base: 300, vol: 0.3, reqRank: 2, stockBase: 60 },
    { name: "å¹³æ¿ç”µè„‘", base: 3000, vol: 0.4, reqRank: 3, stockBase: 40 },
    { name: "èŒ…å°é…’", base: 2500, vol: 0.5, reqRank: 3, stockBase: 30 },
    { name: "äººå‚", base: 1000, vol: 0.4, reqRank: 3, stockBase: 50 }, // å“ˆå°”æ»¨
    { name: "åŒ–å¦†å“", base: 1500, vol: 0.4, reqRank: 4, stockBase: 50 },
    { name: "æ¸¸æˆæ˜¾å¡", base: 5000, vol: 0.6, reqRank: 5, stockBase: 15 },
    { name: "å•åç›¸æœº", base: 15000, vol: 0.4, reqRank: 6, stockBase: 10 },
    { name: "ä¼ç‰¹åŠ ", base: 800, vol: 0.5, reqRank: 7, stockBase: 120 },
    { name: "æ¾³æ´²ç¾Šæ¯›", base: 4000, vol: 0.3, reqRank: 7, stockBase: 60 },
    { name: "é»„é‡‘é¥°å“", base: 30000, vol: 0.3, reqRank: 8, stockBase: 8 },
    { name: "å®šåˆ¶è¥¿è£…", base: 20000, vol: 0.4, reqRank: 9, stockBase: 15 },
    { name: "å¥¢ä¾ˆååŒ…", base: 50000, vol: 0.5, reqRank: 10, stockBase: 5 },
    { name: "AIèŠ¯ç‰‡", base: 200000, vol: 0.7, reqRank: 10, stockBase: 3 },
    { name: "é™¨çŸ³æ ·æœ¬", base: 500000, vol: 0.8, reqRank: 10, stockBase: 1 }
];

// === 2. ç©å®¶çŠ¶æ€ ===
let player = {
    companyName: null,
    day: 1,
    money: 1000,
    cityIdx: 0,
    homeIdx: 0, // æ–°å¢ï¼šå®¶çš„ä½ç½®
    inventory: {}, 
    marketData: {},
    rankIdx: 0,
    capacity: 50, // åˆå§‹å®¹é‡å•ç‹¬è®¡ç®—
    // é“¶è¡Œæ•°æ®
    bank: {
        deposit: 0,
        loan: 0,
        loanDeadline: 0 // è¿˜æ¬¾æˆªæ­¢æ—¥ï¼ˆDayï¼‰
    },
    // ç­¾è¯æ•°æ®
    visa: {
        daysLeft: 0,
        active: false
    }
};

// === 3. åˆå§‹åŒ– ===
window.onload = function() {
    loadGame();
    if (!player.companyName) {
        render();
        setTimeout(() => {
            let name = "";
            while (!name) name = prompt("ğŸ‘‹ æ¬¢è¿è€æ¿ï¼è¯·æ³¨å†Œå…¬å¸åç§°ï¼š", "æœªå‘½åä¼ä¸š");
            player.companyName = name;
            render(); saveGame();
        }, 100);
    }
    if (!player.marketData || Object.keys(player.marketData).length === 0) updateMarket();
    // å…¼å®¹æ—§å­˜æ¡£
    if(!player.bank) player.bank = { deposit:0, loan:0, loanDeadline:0 };
    if(!player.capacity) player.capacity = 50 + (player.rankIdx * 50); // è¡¥å¿æ—§ç‰ˆæœ¬å®¹é‡
    if(!player.visa) player.visa = { daysLeft: 0, active: false };
    if(typeof player.homeIdx === 'undefined') player.homeIdx = 0;

    fixInventoryData(); 
    render();
    if(document.getElementById("gameLog").innerHTML === "") log(`> V5.0 é‡‘èé£æš´å·²åŠ è½½ã€‚å½“å‰åŸºåœ°ï¼š${CITIES[player.homeIdx].name}`);
};

// === 4. æ ¸å¿ƒé€»è¾‘ ===

// åˆ·æ–°å¸‚åœº
function updateMarket(isEvent = false) {
    let newMarket = {};
    GOODS.forEach(good => {
        if (good.reqRank <= player.rankIdx + 1) { 
            let change = (Math.random() - 0.5) * 2 * good.vol;
            let finalPrice = Math.floor(good.base * (1 + change));
            if (finalPrice < 1) finalPrice = 1;

            let stock = Math.floor(good.stockBase * (0.5 + Math.random()));
            if (good.reqRank >= 5 && Math.random() < 0.25) stock = 0; 

            newMarket[good.name] = { price: finalPrice, stock: stock };
        }
    });
    player.marketData = newMarket;
    
    // å¦‚æœä¸æ˜¯éšæœºäº‹ä»¶è§¦å‘çš„åˆ·æ–°ï¼Œåˆ™å°è¯•è§¦å‘éšæœºäº‹ä»¶
    if (!isEvent) triggerRandomEvent();
}

// æ¯æ—¥ç»“ç®—ï¼ˆåˆ©æ¯ã€ç­¾è¯ï¼‰
function processDailyLogic() {
    player.day++;
    
    // 1. é“¶è¡Œç»“ç®—
    if (player.bank.deposit > 0) {
        let interest = Math.floor(player.bank.deposit * 0.005);
        player.bank.deposit += interest;
    }
    if (player.bank.loan > 0) {
        let interest = Math.floor(player.bank.loan * 0.02);
        player.bank.loan += interest;
        
        // æ£€æŸ¥æ­»æœŸ
        if (player.day > player.bank.loanDeadline) {
            alert("ğŸš“ è­¦å¯Ÿï¼šä½ å› æ¶æ„æ‹–æ¬ å·¨é¢é“¶è¡Œè´·æ¬¾è¢«æ•å…¥ç‹±ï¼\n\nGAME OVER");
            resetGame();
            return false; // æ¸¸æˆç»“æŸ
        }
    }

    // 2. ç­¾è¯ç»“ç®— (å¦‚æœæ˜¯å›½å¤– ä¸” ä¸æ˜¯å®¶)
    let curCity = CITIES[player.cityIdx];
    if (curCity.isForeign && player.cityIdx !== player.homeIdx) {
        player.visa.daysLeft--;
        if (player.visa.daysLeft <= 0) {
            alert("ğŸ›‚ ç§»æ°‘å±€ï¼šä½ çš„ç­¾è¯å·²è¿‡æœŸï¼å¼ºåˆ¶é£è¿”ï¼");
            goHome(true); // å¼ºåˆ¶é£è¿”
            return false;
        }
    }
    return true;
}

function restDay() {
    if(!processDailyLogic()) return;
    updateMarket();
    log("ğŸ’¤ ä¼‘æ¯ä¸€å¤©ï¼Œåˆ©æ¯å·²ç»“ç®—ã€‚");
    render();
    saveGame();
}

// éšæœºäº‹ä»¶ç³»ç»Ÿ
function triggerRandomEvent() {
    if (Math.random() > 0.1) return; // 10% å‡ ç‡è§¦å‘

    const events = [
        { title: "ğŸ“‰ é‡‘èå±æœº", text: "å…¨çƒè‚¡å¸‚å´©ç›˜ï¼å•†å“ä»·æ ¼æš´æ¶¨ï¼Œåº“å­˜å‡åŠã€‚", effect: () => { 
            for(let k in player.marketData) {
                player.marketData[k].price = Math.floor(player.marketData[k].price * 1.5);
                player.marketData[k].stock = Math.floor(player.marketData[k].stock * 0.5);
            }
        }},
        { title: "ğŸ“ˆ ç»æµç¹è£", text: "å¸‚åœºéœ€æ±‚æ—ºç››ï¼Œæ‰€æœ‰å•†å“ä»·æ ¼ä¸‹è·Œï¼Œåº“å­˜ç¿»å€ï¼", effect: () => {
             for(let k in player.marketData) {
                player.marketData[k].price = Math.floor(player.marketData[k].price * 0.7);
                player.marketData[k].stock = Math.floor(player.marketData[k].stock * 2);
            }
        }},
        { title: "ğŸ¥· é­é‡å¼ºç›—", text: "ä½ åœ¨å°å··å­é‡Œè¢«æŠ¢äº†ï¼æŸå¤±ç°é‡‘ Â¥1000ã€‚", effect: () => {
            player.money = Math.max(0, player.money - 1000);
        }},
        { title: "ğŸ’¸ æ„å¤–ä¹‹è´¢", text: "ä½ åœ¨è·¯è¾¹æ¡åˆ°äº†ä¸€ä¸ªé’±åŒ…ã€‚è·å¾— Â¥2000ã€‚", effect: () => {
            player.money += 2000;
        }},
        { title: "ğŸš” ç¨åŠ¡ç¨½æŸ¥", text: "ç¨åŠ¡å±€è®¤ä¸ºä½ æœ‰å·ç¨å«Œç–‘ï¼Œç½šæ¬¾å½“å‰èµ„é‡‘çš„ 5%ã€‚", effect: () => {
            let fine = Math.floor(player.money * 0.05);
            player.money -= fine;
        }},
        { title: "ğŸ° å½©ç¥¨ä¸­å¥–", text: "å¤©å‘ï¼ä½ ä¹°çš„å½©ç¥¨ä¸­äº†äºŒç­‰å¥–ï¼è·å¾— Â¥50,000ï¼", effect: () => {
            player.money += 50000;
        }},
        { title: "ğŸŒ§ï¸ ä»“åº“å—æ½®", text: "æš´é›¨å¯¼è‡´ä»“åº“æ¼æ°´ï¼ŒæŸå¤±äº†éƒ¨åˆ†å•†å“ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚", effect: () => {
            let keys = Object.keys(player.inventory);
            if (keys.length > 0) {
                let k = keys[Math.floor(Math.random()*keys.length)];
                let lost = Math.ceil(player.inventory[k].count * 0.2);
                player.inventory[k].count -= lost;
                if(player.inventory[k].count<=0) delete player.inventory[k];
                log(`å—æ½®æŸå¤±äº† ${lost} ä¸ª ${k}`);
            }
        }},
        { title: "ğŸ æ…ˆå–„æ™šå®´", text: "ä½ è¢«é‚€è¯·å‚åŠ æ…ˆå–„æ™šå®´ï¼Œå¼ºåˆ¶ææ¬¾ Â¥500 ä»¥æå‡åèª‰ã€‚", effect: () => {
            player.money = Math.max(0, player.money - 500);
        }},
        { title: "ğŸ¦  æµè¡Œæ„Ÿå†’", text: "ä½ ç”Ÿç—…äº†ï¼Œå»åŒ»é™¢èŠ±è´¹äº† Â¥3000 åŒ»è¯è´¹ã€‚", effect: () => {
            player.money = Math.max(0, player.money - 3000);
        }},
        { title: "ğŸ“¦ ä¾›è´§å•†è·‘è·¯", text: "ä¸€å®¶ä¾›è´§å•†è·‘è·¯äº†ï¼ŒæŸä¸ªå•†å“åœ¨å¸‚åœºä¸Šå½»åº•æ–­è´§ã€‚", effect: () => {
            let keys = Object.keys(player.marketData);
            let k = keys[Math.floor(Math.random()*keys.length)];
            player.marketData[k].stock = 0;
        }}
    ];

    let evt = events[Math.floor(Math.random() * events.length)];
    evt.effect();
    showModal(evt.title, evt.text);
}

// === é“¶è¡Œç³»ç»Ÿ ===
function openBank() {
    let html = `
        <p>ç°é‡‘: <span class="money">Â¥${player.money.toLocaleString()}</span></p>
        <div style="background:#222; padding:10px; margin-bottom:10px; border-radius:6px;">
            <div style="color:#00e676">å­˜æ¬¾: Â¥${player.bank.deposit.toLocaleString()}</div>
            <div style="font-size:11px; color:#888">æ—¥åˆ©ç‡ 0.5%</div>
            <div style="margin-top:5px;">
                <button onclick="bankAction('deposit')">å­˜é’±</button>
                <button onclick="bankAction('withdraw')">å–é’±</button>
            </div>
        </div>
        <div style="background:#222; padding:10px; border-radius:6px;">
            <div style="color:#ff5252">è´·æ¬¾: Â¥${player.bank.loan.toLocaleString()}</div>
            <div style="font-size:11px; color:#888">æ—¥åˆ©ç‡ 2.0% | æˆªæ­¢: ç¬¬${player.bank.loanDeadline||'--'}å¤©</div>
            <div style="margin-top:5px;">
                ${player.bank.loan > 0 
                  ? `<button onclick="bankAction('repay')">è¿˜æ¬¾</button>`
                  : `<button onclick="bankAction('borrow')">ç”³è¯·è´·æ¬¾</button>`
                }
            </div>
        </div>
    `;
    showModal("ğŸ¦ ç‘å£«é“¶è¡Œ", html);
}

function bankAction(type) {
    let val = 0;
    if (type === 'deposit') {
        val = parseInt(prompt("è¯·è¾“å…¥å­˜æ¬¾é‡‘é¢ï¼ˆå…¨éƒ¨å­˜å…¥è¾“ -1ï¼‰ï¼š", "0"));
        if (val === -1) val = player.money;
        if (val > 0 && val <= player.money) {
            player.money -= val; player.bank.deposit += val;
            alert("å­˜æ¬¾æˆåŠŸï¼");
        }
    } else if (type === 'withdraw') {
        val = parseInt(prompt("è¯·è¾“å…¥å–æ¬¾é‡‘é¢ï¼š", "0"));
        if (val > 0 && val <= player.bank.deposit) {
            player.bank.deposit -= val; player.money += val;
            alert("å–æ¬¾æˆåŠŸï¼");
        }
    } else if (type === 'borrow') {
        let maxLoan = player.money * 5;
        val = parseInt(prompt(`è¯·è¾“å…¥è´·æ¬¾é‡‘é¢ (æœ€é«˜ Â¥${maxLoan})ï¼š`, maxLoan));
        if (val > 0 && val <= maxLoan) {
            player.money += val;
            player.bank.loan += val;
            player.bank.loanDeadline = player.day + 30; // 30å¤©æœŸé™
            alert("è´·æ¬¾æˆåŠŸï¼è¯·åœ¨30å¤©å†…è¿˜æ¸…ï¼Œå¦åˆ™åæœè‡ªè´Ÿã€‚");
        }
    } else if (type === 'repay') {
        val = parseInt(prompt(`è¯·è¾“å…¥è¿˜æ¬¾é‡‘é¢ (æ¬ æ¬¾ Â¥${player.bank.loan})ï¼š`, player.bank.loan));
        if (val > 0 && val <= player.money) {
            // ä¸èƒ½è¿˜å¤š
            val = Math.min(val, player.bank.loan);
            player.money -= val;
            player.bank.loan -= val;
            if (player.bank.loan <= 0) player.bank.loanDeadline = 0;
            alert("è¿˜æ¬¾æˆåŠŸï¼");
        }
    }
    openBank(); // åˆ·æ–°ç•Œé¢
    render();
    saveGame();
}

// === æ¸²æŸ“ä¸ç•Œé¢ ===
function render() {
    let curCity = CITIES[player.cityIdx];
    let curRank = RANKS[player.rankIdx];
    let isHome = player.cityIdx === player.homeIdx;
    
    // ç­¾è¯æ˜¾ç¤º
    let visaText = "";
    if (curCity.isForeign && !isHome) {
        visaText = `<span class="visa-tag">ç­¾è¯: ${player.visa.daysLeft}å¤©</span>`;
    } else if (isHome) {
        visaText = `<span class="stock-tag">ğŸ  Base</span>`;
    }

    document.getElementById("companyDisplay").innerText = player.companyName || "æœªå‘½å";
    document.getElementById("dayDisplay").innerText = player.day;
    document.getElementById("moneyDisplay").innerText = "Â¥" + player.money.toLocaleString();
    document.getElementById("locDisplay").innerHTML = curCity.name + visaText;
    document.getElementById("titleDisplay").innerText = curRank.name;
    
    let itemsCount = getInventoryCount();
    document.getElementById("capDisplay").innerText = `${itemsCount}/${player.capacity}`;
    document.getElementById("capDisplay").style.color = itemsCount >= player.capacity ? "#ff5252" : "#8b949e";

    // å•†å“åˆ—è¡¨
    let listHtml = "";
    let visibleGoods = GOODS.filter(g => g.reqRank <= player.rankIdx + 1);
    
    visibleGoods.forEach(good => {
        let marketItem = player.marketData[good.name];
        if (!marketItem) marketItem = { price: good.base, stock: 0 };
        
        let itemData = player.inventory[good.name]; 
        let ownCount = itemData ? itemData.count : 0;
        let avgCost = itemData ? itemData.cost : 0;
        let isLocked = good.reqRank > player.rankIdx;
        
        if (!isLocked) {
            let priceClass = "col-neutral";
            if (ownCount > 0) {
                if (marketItem.price > avgCost) priceClass = "col-profit";
                else if (marketItem.price < avgCost) priceClass = "col-loss";
            } else {
                if (marketItem.price > good.base) priceClass = "col-profit";
                else if (marketItem.price < good.base) priceClass = "col-loss";
            }

            let profitInfo = "";
            if (ownCount > 0) {
                let diff = marketItem.price - avgCost;
                let diffStr = diff > 0 ? `+${parseInt(diff)}` : `${parseInt(diff)}`;
                let pClass = diff > 0 ? "col-profit" : (diff < 0 ? "col-loss" : "");
                profitInfo = `<div style="font-size:11px; color:#888">å‡ä»· Â¥${parseInt(avgCost)} <span class="${pClass}">(${diffStr})</span></div>`;
            }

            let stockHtml = marketItem.stock > 0 ? `<span class="stock-tag">ä½™:${marketItem.stock}</span>` : `<span class="sold-out">âŒ</span>`;
            
            listHtml += `
            <div class="item-row">
                <div style="width:35%">
                    <div style="font-weight:bold">${good.name} ${stockHtml}</div>
                    <div style="font-size:12px; color:#888">æŒ: <span style="color:#e0e0e0">${ownCount}</span></div>
                    ${profitInfo}
                </div>
                <div style="width:25%; text-align:center;">
                    <div class="${priceClass}" style="font-size:16px;">Â¥${marketItem.price.toLocaleString()}</div>
                </div>
                <div style="width:40%; text-align:right;">
                    <button class="btn-sell" onclick="trade('${good.name}', -1)">å–</button>
                    <button class="btn-max" onclick="trade('${good.name}', -999)">å…¨å–</button>
                    <button class="btn-buy" onclick="trade('${good.name}', 1)" ${marketItem.stock<=0?'disabled':''}>ä¹°</button>
                    <button class="btn-max" onclick="trade('${good.name}', 999)" ${marketItem.stock<=0?'disabled':''}>å…¨ä¹°</button>
                </div>
            </div>`;
        }
    });
    document.getElementById("marketList").innerHTML = listHtml;

    renderCityList();
    renderUpgradePanel();
}

function renderCityList() {
    let cityHtml = "";
    CITIES.forEach((city, idx) => {
        if (idx === player.cityIdx) return;
        
        // 5.0åŠŸèƒ½ï¼šå¤§è¶…å¸‚ä¹‹åæ— æ³•å›æ–°æ‰‹æ‘
        if (player.rankIdx >= 5 && idx <= 1) return;

        let distDiff = Math.abs(city.dist - CITIES[player.cityIdx].dist);
        let cost = calculateTravelCost(distDiff);
        let isLocked = city.reqRank > player.rankIdx;
        let lockMsg = isLocked ? `ğŸ”’` : `Â¥${cost}`;
        
        // æ¬å®¶æŒ‰é’®
        let moveBtn = "";
        if (!isLocked && idx !== player.homeIdx) {
            let moveCost = Math.min(3000000, cost * 100); // æ¬å®¶è´¹
            moveBtn = `<button style="background:#58a6ff; color:black; font-size:10px; margin-left:5px;" onclick="moveHome(${idx}, ${moveCost})">ç§»æ°‘(Â¥${(moveCost/10000).toFixed(1)}ä¸‡)</button>`;
        }

        cityHtml += `
        <div class="city-btn" style="background:#21262d; border:1px solid #30363d;">
            <div style="flex:1">
                <div>${city.name} ${city.isForeign ? 'ğŸŒ' : ''}</div>
                <div style="font-size:11px; color:#666">${distDiff}km ${moveBtn}</div>
            </div>
            <button onclick="travel(${idx})" ${isLocked ? 'disabled' : ''}>${lockMsg} å‡ºå‘</button>
        </div>`;
    });
    document.getElementById("cityList").innerHTML = cityHtml;
}

// === åŠŸèƒ½é€»è¾‘ ===

function trade(name, amount) {
    let marketItem = player.marketData[name];
    if (!marketItem) return;
    
    // åˆå§‹åŒ–
    if (!player.inventory[name]) player.inventory[name] = { count: 0, cost: 0 };
    let item = player.inventory[name];

    // æ‰¹é‡è®¡ç®—
    if (amount === 999) { // å…¨ä¹°
        let maxCanAfford = Math.floor(player.money / marketItem.price);
        let maxSpace = player.capacity - getInventoryCount();
        let maxStock = marketItem.stock;
        amount = Math.min(maxCanAfford, maxSpace, maxStock);
        if (amount <= 0) { log("âŒ ä¹°ä¸äº† (æ²¡é’±/æ²¡ç©º/æ²¡è´§)"); return; }
    }
    if (amount === -999) { // å…¨å–
        amount = -item.count;
        if (amount === 0) return;
    }

    if (amount > 0) { // ä¹°å…¥
        if (marketItem.stock < amount) { log("âŒ åº“å­˜ä¸è¶³"); return; }
        if (getInventoryCount() + amount > player.capacity) { log("âŒ ä»“åº“å·²æ»¡"); return; }
        let cost = amount * marketItem.price;
        if (player.money < cost) { log("âŒ èµ„é‡‘ä¸è¶³"); return; }
        
        // å‡ä»·è®¡ç®—
        let totalVal = (item.count * item.cost) + cost;
        item.count += amount;
        item.cost = totalVal / item.count;
        player.money -= cost;
        player.marketData[name].stock -= amount;
        log(`ğŸ›’ ä¹°å…¥ ${amount}ä¸ª ${name}`);

    } else { // å–å‡º
        amount = Math.abs(amount); // è½¬æ­£æ•°
        if (item.count < amount) return;
        
        let profit = (marketItem.price - item.cost) * amount;
        player.money += marketItem.price * amount;
        item.count -= amount;
        if (item.count === 0) delete player.inventory[name];
        
        let sign = profit >= 0 ? "+" : "";
        log(`ğŸ’° å–å‡º ${amount}ä¸ª ${name} (èµš${sign}${parseInt(profit)})`);
    }
    render();
    saveGame();
}

function travel(targetIdx) {
    let targetCity = CITIES[targetIdx];
    let distDiff = Math.abs(targetCity.dist - CITIES[player.cityIdx].dist);
    let cost = calculateTravelCost(distDiff);
    
    if (player.money < cost) { log("âŒ è·¯è´¹ä¸å¤Ÿ"); return; }
    
    // ç­¾è¯æ£€æŸ¥ï¼šå¦‚æœæ˜¯å»å›½å¤–ï¼Œä¸”ä¸æ˜¯å›å®¶
    let visaDays = 0;
    if (targetCity.isForeign && targetIdx !== player.homeIdx) {
        // é’±è¶Šå¤šå¾…è¶Šä¹…ï¼š1ä¸‡ = 1å¤©ï¼Œæœ€å¤š8å¤©
        visaDays = Math.min(8, Math.floor(player.money / 10000));
        if (visaDays < 1) {
            alert("ğŸ›‚ ç­¾è¯å®˜ï¼šä½ çš„èµ„äº§è¯æ˜ä¸è¶³ï¼ˆä½äº1ä¸‡ï¼‰ï¼Œæ‹’ç­¾ï¼");
            return;
        }
        if(!confirm(`å»å¾€ ${targetCity.name}\nè·¯è´¹: Â¥${cost}\nä½ çš„èµ„äº§å¯è·å¾—ç­¾è¯: ${visaDays}å¤©\nç¡®å®šå‡ºå‘å—ï¼Ÿ`)) return;
    } else {
        if(!confirm(`å»å¾€ ${targetCity.name}\nè·¯è´¹: Â¥${cost}\nç¡®å®šå‡ºå‘å—ï¼Ÿ`)) return;
    }

    // æ‰§è¡Œç§»åŠ¨
    if(!processDailyLogic()) return; // ç§»åŠ¨ä¹Ÿç®—è¿‡ä¸€å¤©

    player.money -= cost;
    player.cityIdx = targetIdx;
    
    // è®¾ç½®ç­¾è¯
    if (visaDays > 0) {
        player.visa = { active: true, daysLeft: visaDays };
        log(`ğŸ›‚ è·å¾— ${targetCity.name} ç­¾è¯ ${visaDays} å¤©`);
    } else {
        player.visa = { active: false, daysLeft: 0 };
    }

    updateMarket(); // ç§»åŠ¨åˆ·æ–°å¸‚åœº
    log(`âœˆï¸ åˆ°è¾¾ ${targetCity.name}`);
    render();
    saveGame();
}

function moveHome(targetIdx, cost) {
    if (player.money < cost) { alert("èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•ç§»æ°‘/æ¬å®¶ï¼"); return; }
    if (confirm(`ç¡®å®šè¦èŠ±è´¹ Â¥${cost.toLocaleString()} å°†åŸºåœ°æ¬è¿åˆ° ${CITIES[targetIdx].name} å—ï¼Ÿ\næ¬è¿åè¯¥åœ°è§†ä¸ºè€å®¶ï¼Œä¸å†å—ç­¾è¯é™åˆ¶ã€‚`)) {
        player.money -= cost;
        player.homeIdx = targetIdx;
        player.cityIdx = targetIdx; // é¡ºä¾¿ç§»è¿‡å»
        player.visa = { active: false, daysLeft: 0 }; // æ¸…é™¤ç­¾è¯é™åˆ¶
        alert("ğŸ‰ ä¹”è¿ä¹‹å–œï¼æ–°åŸºåœ°å·²è®¾ç«‹ã€‚");
        processDailyLogic();
        updateMarket();
        render();
        saveGame();
    }
}

function upgradeCapacity() {
    let cost = player.capacity * 100; // çº¿æ€§å¢é•¿
    if (player.money >= cost) {
        player.money -= cost;
        player.capacity += 10;
        log(`ğŸ’ ä»“åº“æ‰©å®¹æˆåŠŸï¼å½“å‰ ${player.capacity}`);
        render();
        saveGame();
    } else {
        alert(`æ‰©å®¹éœ€è¦ Â¥${cost}`);
    }
}

// è¾…åŠ©å‡½æ•°
function calculateTravelCost(km) { return km <= 50 ? 20 : Math.floor(km * 1.5 + 100); }
function goHome(force = false) { 
    if(player.cityIdx === player.homeIdx) return;
    
    let target = player.homeIdx;
    // å¦‚æœè¿˜æ²¡æ¬å®¶ï¼Œä¸”ç­‰çº§é«˜äº†å›ä¸å»æ‘å£ï¼Œå°±å»æœ€è¿‘çš„åŸå¸‚
    if (player.rankIdx >= 5 && player.homeIdx <= 1) target = 2; // é»˜è®¤å›çœä¼š

    let distDiff = Math.abs(CITIES[target].dist - CITIES[player.cityIdx].dist);
    let cost = calculateTravelCost(distDiff);
    
    if (force) {
        // å¼ºåˆ¶é£è¿”ï¼Œæ²¡é’±ä¹Ÿå¾—æ‰£æˆè´Ÿæ•°
        player.money -= cost;
        player.cityIdx = target;
        player.visa = { active: false, daysLeft: 0 };
        log("âš ï¸ è¢«å¼ºåˆ¶é€å›å›½å†…ã€‚");
        render(); saveGame();
        return;
    }
    travel(target); 
}
function getInventoryCount() { let t=0; for(let k in player.inventory) t+=player.inventory[k].count; return t; }
function upgradeTitle() {
    let nextIdx = player.rankIdx + 1;
    if (player.money >= RANKS[nextIdx].cost) {
        player.money -= RANKS[nextIdx].cost;
        player.rankIdx = nextIdx;
        log(`ğŸ‰ æ™‹å‡ä¸ºã€${RANKS[nextIdx].name}ã€‘`); // ä¸å†åŠ å®¹é‡
        render(); saveGame();
    }
}
function renderUpgradePanel() {
    let nextIdx = player.rankIdx + 1;
    if (nextIdx < RANKS.length) {
        let nextRank = RANKS[nextIdx];
        document.getElementById("upgradeInfo").innerText = `ä¸‹çº§: ${nextRank.name}`;
        document.getElementById("btnUpgrade").innerText = `æ™‹å‡ (Â¥${nextRank.cost.toLocaleString()})`;
        document.getElementById("btnUpgrade").disabled = player.money < nextRank.cost;
        document.getElementById("upgradePanel").style.display = "block";
    } else {
        document.getElementById("upgradePanel").style.display = "none";
    }
}

// å¼¹çª—é€»è¾‘
function showModal(title, content) {
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalContent").innerHTML = content;
    document.getElementById("modalOverlay").style.display = "flex";
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    document.getElementById("modalOverlay").onclick = function(e){
        if(e.target === this) this.style.display = "none";
    }
}

function log(msg) {
    let box = document.getElementById("gameLog");
    box.innerHTML = `<div>${msg}</div>` + box.innerHTML;
}
function fixInventoryData() {
    for (let key in player.inventory) {
        if (typeof player.inventory[key] === 'number') {
            let good = GOODS.find(g => g.name === key);
            player.inventory[key] = { count: player.inventory[key], cost: good?good.base:0 };
        }
    }
}
function saveGame() { localStorage.setItem("tycoon_v5", JSON.stringify(player)); }
function loadGame() {
    let data = localStorage.getItem("tycoon_v5");
    if (!data) data = localStorage.getItem("tycoon_v4"); 
    if (data) player = JSON.parse(data);
}
function resetGame() {
    if(confirm("ç¡®å®šåˆ æ¡£é‡æ¥ï¼Ÿ")) {
        localStorage.removeItem("tycoon_v5");
        location.reload();
    }
}
</script>
</body>
</html>
