<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†ä¸šå¤§äº¨ V2.6ï¼šå˜²è®½ä¼˜åŒ–ç‰ˆ</title>
    <style>
        :root { 
            --bg: #0b0c10; --card: #1f2833; --text: #c5c6c7; 
            --primary: #66fcf1; --primary-dim: #45a29e; 
            --red: #ff4d4d; --gold: #ffd700; --green: #2ecc71;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background-color: var(--bg); color: var(--text); font-family: var(--font); padding: 10px; max-width: 500px; margin: 0 auto; line-height: 1.4; padding-bottom: 80px; }
        
        /* æ ¸å¿ƒå¸ƒå±€ */
        .header { background: linear-gradient(145deg, #1a1a1a, #242424); padding: 15px; border-radius: 12px; border-bottom: 2px solid var(--primary-dim); margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; }
        .stat-item { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; display:flex; flex-direction:column; align-items:center; }
        .stat-val { font-size: 14px; font-weight: bold; margin-top:2px; }
        .text-gold { color: var(--gold); } .text-red { color: var(--red); } .text-blue { color: var(--primary); } .text-green { color: var(--green); }
        
        .progress-bg { width: 100%; height: 4px; background: #333; margin-top: 4px; border-radius: 2px; overflow:hidden; }
        .progress-fill { height: 100%; background: var(--green); width: 100%; transition: width 0.3s; }

        .panel { background: var(--card); padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .panel-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:8px; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .list-item:last-child { border: none; }
        
        button { background: #2c3e50; border: none; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; transition: all 0.1s; position: relative; overflow: hidden; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        button:disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        
        .btn-main { background: var(--primary-dim); color: #fff; box-shadow: 0 2px 5px rgba(102, 252, 241, 0.2); }
        .btn-danger { background: #800000; color: #ffcccc; border: 1px solid #ff4d4d; }
        .btn-success { background: #145a32; color: #d4efdf; border: 1px solid #2ecc71; }
        .btn-gold { background: #7d6608; color: #f9e79f; border: 1px solid var(--gold); }
        .btn-ghost { background: transparent; border: 1px solid #555; color: #888; }
        .btn-block { width: 100%; padding: 10px; font-size: 14px; margin-bottom: 5px; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 15px; }
        .menu-btn { background: #1a1a1a; border: 1px solid #333; padding: 10px 0; border-radius: 8px; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 11px; color: #aaa; }
        .menu-icon { font-size: 18px; margin-bottom: 2px; }

        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-box { background: #161616; width: 90%; max-width: 400px; border-radius: 16px; border: 1px solid var(--primary-dim); box-shadow: 0 0 20px rgba(102, 252, 241, 0.15); display: flex; flex-direction: column; overflow: hidden; max-height: 85vh; animation: popIn 0.2s; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-header { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: bold; color: var(--primary); }
        .modal-content { padding: 20px; overflow-y: auto; font-size: 14px; color: #ddd; text-align: center; }
        .modal-footer { padding: 15px; background: #1a1a1a; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-input { width: 100%; background: #000; border: 1px solid var(--primary-dim); color: var(--primary); padding: 12px; font-size: 20px; text-align: center; border-radius: 8px; margin: 10px 0; outline: none; }
        
        .tag { font-size: 10px; padding: 2px 5px; border-radius: 4px; background: #333; color: #aaa; margin-left: 5px; }
        .tag-risk { background: #300; color: var(--red); border: 1px solid var(--red); }
        .log-box { height: 100px; overflow-y: auto; font-size: 11px; background: #000; border: 1px solid #333; padding: 8px; margin-top: 10px; color: #666; font-family: monospace; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .mission-bar { background: linear-gradient(90deg, #0f2027, #203a43, #2c5364); padding: 12px; border-radius: 8px; border: 1px solid var(--primary-dim); margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .rank-bar { display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); font-size:12px; color:#888; }
        
        .stock-card { background: #111; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; text-align: left; }
        .lotto-card { background: linear-gradient(145deg, #1a1a1a, #222); padding: 15px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #444; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .lotto-card:active { transform: scale(0.98); border-color: var(--gold); }
    </style>
</head>
<body>

<div id="appModal" class="modal-mask">
    <div class="modal-box">
        <div class="modal-header">
            <span id="mTitle">æç¤º</span>
            <button class="btn-ghost" onclick="closeModal()">Ã—</button>
        </div>
        <div id="mContent" class="modal-content"></div>
        <div id="mFooter" class="modal-footer"></div>
    </div>
</div>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-size:18px; font-weight:900; color:var(--primary); letter-spacing:1px;" id="uiCompany">COMPANY</div>
        <div class="tag" id="uiTrend">å¸‚åœº: å¹³ç¨³</div>
    </div>
    
    <div class="stat-grid">
        <div class="stat-item">
            <span style="color:#888">æ€»èµ„äº§</span>
            <span class="stat-val text-gold" id="uiMoney">Â¥0</span>
        </div>
        <div class="stat-item">
            <span style="color:#888">ç”Ÿå‘½çŠ¶å†µ</span>
            <div style="width:100%; display:flex; align-items:center; gap:5px;">
                <span class="text-red" id="uiHp" style="font-weight:bold; font-size:12px;">50</span>
                <div class="progress-bg"><div class="progress-fill" id="uiHpBar"></div></div>
            </div>
            <div style="font-size:10px; color:#555; margin-top:2px;">é¥±é£Ÿåº¦: <span id="uiMeal">0/3</span></div>
        </div>
        <div class="stat-item">
            <span style="color:#888">å½“å‰ä½ç½®</span>
            <span class="stat-val text-blue" id="uiLoc">--</span>
        </div>
        <div class="stat-item">
            <span style="color:#888">ä»“åº“å®¹é‡</span>
            <span class="stat-val" id="uiCap">0/0</span>
        </div>
    </div>
    
    <div class="rank-bar">
        <span>å¤´è¡”: <b class="text-gold" id="uiRank">--</b></span>
        <span class="text-red" id="uiLimit"></span>
    </div>
    
    <div id="btnPromoteContainer" style="margin-top:10px; display:none;">
        <button class="btn-block btn-gold" onclick="promote()">ğŸ‘‘ æ™‹å‡å¤´è¡”</button>
    </div>
</div>

<div id="missionBox" class="mission-bar" style="display:none">
    <div>
        <div style="color:#fff; font-weight:bold; font-size:13px;" id="msTitle">ä»»åŠ¡ç›®æ ‡</div>
        <div style="color:#aaa; font-size:11px;" id="msDesc">æè¿°</div>
    </div>
    <button class="btn-main" id="msBtn" onclick="claimMission()">é¢†å–</button>
</div>

<div class="menu-grid">
    <div class="menu-btn" onclick="openBankUI()"><span class="menu-icon">ğŸ¦</span>é“¶è¡Œ</div>
    <div class="menu-btn" onclick="openStockUI()"><span class="menu-icon">ğŸ“ˆ</span>è‚¡ç¥¨</div>
    <div class="menu-btn" onclick="openHouseUI()"><span class="menu-icon">ğŸ </span>æˆ¿äº§</div>
    <div class="menu-btn" onclick="openLottoUI()"><span class="menu-icon">ğŸ°</span>å½©ç¥¨</div>
    <div class="menu-btn" onclick="openBlackUI()" style="border-color:var(--red); color:var(--red);"><span class="menu-icon">ğŸ’€</span>é»‘å¸‚</div>
</div>

<div class="panel">
    <div class="panel-head">
        <b class="text-blue">ğŸŒ è‡ªç”±è´¸æ˜“å¸‚åœº</b>
        <div style="display:flex; gap:5px;">
            <button class="btn-ghost" onclick="expandCap()">â• æ‰©å®¹</button>
            <button class="btn-main" onclick="openRestUI()">ğŸ›Œ ä¼‘æ¯</button>
        </div>
    </div>
    <div style="padding:0 10px 10px; font-size:11px; color:#666;" id="uiStorageFee"></div>
    <div id="marketList"></div>
    <div id="casinoEntry" style="margin-top:10px; display:none">
        <button class="btn-block btn-danger" onclick="openCasinoUI()">ğŸ² çš‡å®¶èµŒåœº (VIP)</button>
    </div>
</div>

<div class="panel">
    <div class="panel-head"><b class="text-blue">âœˆï¸ å•†åŠ¡å·®æ—…</b></div>
    <div id="cityList"></div>
</div>

<div class="panel">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
        <button class="btn-ghost" onclick="openHelpUI()">ğŸ“– ç©æ³•æ‰‹å†Œ</button>
        <button class="btn-ghost" onclick="openLogUI()">ğŸ“œ æ›´æ–°æ—¥å¿—</button>
    </div>
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <button class="btn-ghost" style="flex:1" onclick="saveGame()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn-ghost" style="flex:1" onclick="exportSave()">ğŸ“¤ å¯¼å‡º</button>
        <button class="btn-ghost" style="flex:1" onclick="importSave()">ğŸ“¥ å¯¼å…¥</button>
    </div>
    <button class="btn-block btn-danger" onclick="confirmReset()">â˜ ï¸ åˆ æ¡£é‡æ¥</button>
    <div class="log-box" id="gameLog"></div>
</div>

<script>
// ==================== 0. å¼¹çª—ç³»ç»Ÿ ====================
function alertMsg(msg, callback) { showCustomModal("æç¤º", `<p>${msg}</p>`, [{text:"ç¡®å®š", cls:"btn-main", click: callback}]); }
function confirmMsg(msg, onYes, onNo) { showCustomModal("ç¡®è®¤æ“ä½œ", `<p>${msg}</p>`, [{text:"å–æ¶ˆ", cls:"btn-ghost", click: onNo}, {text:"ç¡®å®š", cls:"btn-main", click: onYes}]); }
function promptMsg(title, placeholder, onConfirm) {
    let html = `<p>${title}</p><input type="number" id="promptInput" class="modal-input" placeholder="${placeholder}">`;
    showCustomModal("è¾“å…¥", html, [{text:"å–æ¶ˆ", cls:"btn-ghost"}, {text:"ç¡®å®š", cls:"btn-main", click: () => { let val = document.getElementById('promptInput').value; if(onConfirm) onConfirm(val); }}]);
    setTimeout(() => { let inp = document.getElementById('promptInput'); if(inp) inp.focus(); }, 100);
}
function showCustomModal(title, content, buttons) {
    document.getElementById('mTitle').innerText = title;
    document.getElementById('mContent').innerHTML = content;
    let footer = document.getElementById('mFooter'); footer.innerHTML = "";
    if(!buttons || buttons.length === 0) buttons = [{text:"å…³é—­", cls:"btn-ghost"}];
    buttons.forEach(btn => {
        let b = document.createElement("button"); b.className = btn.cls || "btn-ghost"; b.innerText = btn.text;
        b.onclick = () => { closeModal(); if(btn.click) btn.click(); }; footer.appendChild(b);
    });
    document.getElementById('appModal').style.display = 'flex';
}
function closeModal() { document.getElementById('appModal').style.display = 'none'; }
window.onerror = function(msg) { logErr("ç³»ç»Ÿé”™è¯¯: " + msg); return true; };

// ==================== 1. æ•°æ®é…ç½® ====================
const CHANGELOG = [
    { ver: "V2.6", content: "- ä¼˜åŒ–ï¼šèµŒåœºæ˜¾ç¤ºå…·ä½“çš„ç›ˆäºé‡‘é¢\n- å½©è›‹ï¼šæ·»åŠ ä½œå¼Šå˜²è®½ä¿¡æ¯" },
    { ver: "V2.5", content: "- ç‰©æµæ”¹é©ï¼šæ–°æ‰‹ç‰©å“å…ä»“å‚¨è´¹" },
    { ver: "V2.4", content: "- å¢åŠ ä½œå¼Šç  (é“¶è¡Œè¾“å…¥å¯†ç )" }
];

const CONFIG = {
    RANKS: [
        { n: "æ‘Šè´©", cost: 0, limit: 100 }, { n: "å°å–éƒ¨", cost: 3000, limit: 3000 },
        { n: "ä¾¿åˆ©åº—", cost: 10000, limit: 8000 }, { n: "è¶…å¸‚", cost: 30000, limit: 25000 },
        { n: "è´¸æ˜“å…¬å¸", cost: 80000, limit: 60000 }, { n: "è·¨å›½é›†å›¢", cost: 200000, limit: 150000 },
        { n: "å•†ä¸šå¸å›½", cost: 5000000, limit: 5000000 }, { n: "ä¸–ç•Œé¦–å¯Œ", cost: 100000000, limit: 1000000000 }
    ],
    CITIES: [
        { n: "æ‘å£", dist: 0, req: 0 }, { n: "å¿åŸ", dist: 20, req: 0 },
        { n: "çœä¼š", dist: 300, req: 1 }, { n: "æ·±åœ³", dist: 1200, req: 2 },
        { n: "æ¾³é—¨", dist: 1200, req: 2, casino: true }, { n: "é¦–å°”", dist: 2000, req: 4, foreign: true },
        { n: "ä¸œäº¬", dist: 3000, req: 6, foreign: true }, { n: "è¿ªæ‹œ", dist: 6000, req: 7, foreign: true },
        { n: "æ‹‰æ–¯ç»´åŠ æ–¯", dist: 11000, req: 7, foreign: true, casino: true }, { n: "çº½çº¦", dist: 12000, req: 7, foreign: true }
    ],
    GOODS: [
        { n: "è¾£æ¡", b: 0.5, v: 0.1, r: 0, s: 5000 }, { n: "åºŸæŠ¥çº¸", b: 1, v: 0.1, r: 0, s: 2000 },
        { n: "çŸ¿æ³‰æ°´", b: 2, v: 0.1, r: 0, s: 1000 }, { n: "æ£‰è¢œ", b: 5, v: 0.2, r: 0, s: 800 },
        { n: "å……ç”µå®", b: 50, v: 0.15, r: 1, s: 300 }, { n: "æ‰‹ç¯", b: 150, v: 0.2, r: 1, s: 200 },
        { n: "æ— äººæœº", b: 2000, v: 0.25, r: 2, s: 50 }, { n: "Switch", b: 2200, v: 0.3, r: 2, s: 50 },
        { n: "æ˜¾å¡", b: 5000, v: 0.4, r: 3, s: 40 }, { n: "èŒ…å°", b: 3000, v: 0.5, r: 3, s: 30 },
        { n: "æŠ˜å å±æ‰‹æœº", b: 12000, v: 0.35, r: 4, s: 20 }, { n: "åŠ³åŠ›å£«", b: 90000, v: 0.3, r: 5, s: 5 },
        { n: "AIèŠ¯ç‰‡", b: 250000, v: 0.7, r: 6, s: 2 }, { n: "é»„é‡‘", b: 450000, v: 0.1, r: 6, s: 5 },
        { n: "å…‰åˆ»æœºéƒ¨ä»¶", b: 1000000, v: 0.5, r: 7, s: 1 }
    ],
    BLACK: [
        { n: "å‡é’", b: 10000, risk: 20 }, { n: "ç®¡åˆ¶åˆ€å…·", b: 2000, risk: 8 }, { n: "æ¯’å“", b: 60000, risk: 75 },
        { n: "é»‘å®¢èŠ¯ç‰‡", b: 15000, risk: 25 }, { n: "å¤±çªƒåç”»", b: 500000, risk: 50 }, { n: "èµ°ç§è±ªè½¦", b: 1000000, risk: 40 }
    ],
    STOCKS: [
        { n: "ä¼¯å…‹å¸Œå°”", b: 4000000, v: 0.02 }, { n: "è‹±ä¼Ÿè¾¾", b: 15000, v: 0.08 },
        { n: "èŒ…å°", b: 18000, v: 0.03 }, { n: "ç‰¹æ–¯æ‹‰", b: 6000, v: 0.10 }, { n: "å¯å£å¯ä¹", b: 3000, v: 0.01 }
    ],
    ESTATES: [
        { id: 1, n: "è€å®¶åœŸæˆ¿", cost: 5000, rent: 50 }, { id: 2, n: "å¿åŸå…¬å¯“", cost: 50000, rent: 300 },
        { id: 3, n: "çœä¼šå­¦åŒºæˆ¿", cost: 800000, rent: 2000 }, { id: 4, n: "æ·±åœ³è±ªå®…", cost: 5000000, rent: 12000 }
    ]
};

const TUTORIAL_MISSIONS = [
    { t: "åˆå…¥å•†æµ·", d: "ä¹°å…¥ä»»æ„å•†å“", check: (p)=>getInvCount()>0, reward: 100 },
    { t: "ä¸–ç•Œé‚£ä¹ˆå¤§", d: "å‰å¾€å…¶ä»–åŸå¸‚", check: (p)=>p.city!==0, reward: 200 },
    { t: "ç¬¬ä¸€æ¡¶é‡‘", d: "å–å‡ºå•†å“èµšé’±", check: (p)=>getInvCount()===0 && p.money>1000, reward: 300 },
    { t: "èº«ä½“æ˜¯æœ¬é’±", d: "åƒä¸€é¡¿ã€å®¶å¸¸èœã€‘æˆ–æ›´å¥½", check: (p)=>p.hp>=30, reward: 150 },
    { t: "é‡‘èç†è´¢", d: "é“¶è¡Œå­˜æ¬¾ >= 100", check: (p)=>p.bank.dep>=100, reward: 200 },
    { t: "åšå¤§åšå¼º", d: "æ‰©å……èƒŒåŒ…å®¹é‡", check: (p)=>p.cap>50, reward: 500 }
];

// === 2. ç©å®¶çŠ¶æ€ ===
let p = {
    name: "ATRI", money: 1000, hp: 50, day: 1,
    city: 0, home: 0, rank: 0, cap: 50,
    inv: {}, market: {}, bank: { dep: 0, loan: 0, due: 0 }, 
    stock: { open: false, port: {}, mkt: [] },
    estate: {}, mealCount: 0, hasEaten: false, sales: 0,
    black: { warn: false, mkt: {} }, visa: { day: 0, on: false },
    buffCurrent: 0, buffNext: 0, trend: 1.0, trendName: "å¹³ç¨³",
    missionStep: 0, dynMission: null, cheat: false
};

// === 3. åˆå§‹åŒ– ===
window.onload = function() {
    let saved = localStorage.getItem("tycoon_v2_6"); // V2.6 æ–°æ§½ä½
    if (saved) {
        try {
            let data = JSON.parse(saved);
            p = { ...p, ...data };
            if (!CONFIG.CITIES[p.city]) p.city = 0;
            if (!CONFIG.RANKS[p.rank]) p.rank = 0;
            if (!p.stock.mkt || p.stock.mkt.length !== CONFIG.STOCKS.length) initStocks();
            if (!p.black.mkt || Object.keys(p.black.mkt).length < CONFIG.BLACK.length) refreshMarket();
            if (!p.estate) p.estate = {};
        } catch(e) { hardReset(); }
    } else {
        initStocks();
        refreshMarket(true);
        promptMsg("æ¬¢è¿æ¥åˆ° V2.6", "ç»™å…¬å¸èµ·ä¸ªåå§", (val)=>{ 
            if(val) p.name = val; render(); saveGame(); 
        });
    }
    if (p.missionStep >= TUTORIAL_MISSIONS.length && !p.dynMission) generateDynamicMission();
    render();
};

function initStocks() { p.stock.mkt = CONFIG.STOCKS.map(s => ({ n: s.n, p: s.b, chg: 0 })); }
function saveGame() { localStorage.setItem("tycoon_v2_6", JSON.stringify(p)); showToast("å­˜æ¡£æˆåŠŸ"); }
function hardReset() { localStorage.removeItem("tycoon_v2_6"); location.reload(); }
function confirmReset() { confirmMsg("ç¡®å®šè¦åˆ é™¤å­˜æ¡£ä»å¤´å¼€å§‹å—ï¼Ÿ", hardReset); }
function showToast(msg) { document.getElementById('gameLog').innerHTML = `<div class='log-entry'>${msg}</div>` + document.getElementById('gameLog').innerHTML; }
function logErr(msg) { document.getElementById('gameLog').innerHTML = `<div class='log-entry text-red'>âŒ ${msg}</div>` + document.getElementById('gameLog').innerHTML; }
function getInvCount() { let c=0; for(let k in p.inv) if(p.inv[k]) c+=p.inv[k].c; return c; }

// === 4. æ ¸å¿ƒå¾ªç¯ ===
function refreshMarket(init) {
    let roll = Math.random();
    if(roll < 0.1) { p.trend = 0.6; p.trendName = "ğŸ“‰ å´©ç›˜"; }
    else if(roll < 0.3) { p.trend = 0.8; p.trendName = "ğŸ“‰ ç†Šå¸‚"; }
    else if(roll < 0.7) { p.trend = 1.0; p.trendName = "ğŸ“Š å¹³ç¨³"; }
    else if(roll < 0.9) { p.trend = 1.2; p.trendName = "ğŸ“ˆ ç‰›å¸‚"; }
    else { p.trend = 1.5; p.trendName = "ğŸ”¥ ç‹‚çƒ­"; }

    let nm = {};
    CONFIG.GOODS.forEach(g => {
        let pr = Math.floor(g.b * (1 + (Math.random()-0.5)*2*g.v));
        pr = Math.floor(pr * p.trend); 
        nm[g.n] = { p: Math.max(1, pr), s: Math.floor(g.s * (0.5+Math.random())) };
    });
    p.market = nm;
    
    let bm = {};
    CONFIG.BLACK.forEach(g => {
        bm[g.n] = { p: Math.floor(g.b*(0.5+Math.random()*1.5)), s: Math.floor(Math.random()*5)+1, r: g.risk };
    });
    p.black.mkt = bm;

    p.stock.mkt.forEach(s => {
        let conf = CONFIG.STOCKS.find(x=>x.n===s.n);
        if(conf) {
            let old = s.p;
            let np = Math.floor(old * (1 + (Math.random()-0.5)*2*conf.v));
            np = Math.floor(np * p.trend);
            s.p = Math.min(conf.b*200, Math.max(conf.b*0.1, np));
            s.chg = ((s.p-old)/old*100).toFixed(2);
        }
    });
}

function nextDay() {
    if (p.money < 0 && !p.cheat) return alertMsg("ğŸ‘® èµ„ä¸æŠµå€ºï¼Œè¢«æ•å…¥ç‹±ï¼\næ¸¸æˆç»“æŸï¼", hardReset);
    if (!p.hasEaten) {
        p.hp -= 10; showToast("âš ï¸ ç»é£Ÿ -10HP");
        if (p.hp <= 0 && !p.cheat) {
            let cost = Math.floor(Math.max(0, p.money) * 0.75); p.money -= cost; p.hp = 20;
            alertMsg(`ğŸ¥ é¥¿æ™•æŠ¢æ•‘ï¼\næ‰£é™¤75%èµ„äº§(Â¥${cost})ä½œä¸ºåŒ»è¯è´¹ã€‚`); return;
        }
    }
    p.day++; p.mealCount = 0; p.hasEaten = false; p.buffCurrent = p.buffNext; p.buffNext = 0;
    
    let totalFee = 0;
    for(let k in p.inv) {
        if(p.inv[k].c > 0) {
            let item = CONFIG.GOODS.find(g => g.n === k);
            let fee = (!item) ? 5 : (item.r===0?0:(item.r<=2?1:5));
            totalFee += p.inv[k].c * fee;
        }
    }
    if (totalFee > 0) { p.money -= totalFee; showToast(`ğŸ“¦ ä»“å‚¨è´¹ -Â¥${totalFee}`); }
    
    let rent = 0;
    CONFIG.ESTATES.forEach(e => { if(p.estate[e.id]) rent += e.rent; });
    if(rent > 0) { p.money += rent; showToast(`ğŸ  æ”¶ç§Ÿ +Â¥${rent}`); }

    if (p.bank.dep > 0) p.bank.dep += Math.floor(p.bank.dep * 0.005);
    if (p.bank.loan > 0) {
        p.bank.loan += Math.floor(p.bank.loan * 0.02);
        if (p.day > p.bank.due && !p.cheat) return alertMsg("ğŸš“ è´·æ¬¾é€¾æœŸï¼Œèµ„äº§æ²¡æ”¶ï¼", hardReset);
    }
    refreshMarket();
    if (p.city === p.home) p.sales = 0;
    showToast(`ğŸ“… ç¬¬ ${p.day} å¤©å¼€å§‹`); render(); saveGame();
}

// ==================== 5. æ¸²æŸ“ç³»ç»Ÿ ====================
function render() {
    let city = CONFIG.CITIES[p.city] || CONFIG.CITIES[0];
    let rank = CONFIG.RANKS[p.rank] || CONFIG.RANKS[0];

    document.getElementById("uiCompany").innerText = p.name + (p.cheat ? " (ä½œå¼Šè€…)" : "");
    document.getElementById("uiTrend").innerText = p.trendName;
    document.getElementById("uiMoney").innerText = "Â¥" + p.money.toLocaleString();
    document.getElementById('uiMoney').className = p.money < 0 ? 'stat-val text-red' : 'stat-val text-gold';
    document.getElementById("uiHp").innerText = p.hp;
    document.getElementById("uiHpBar").style.width = (Math.min(p.hp,50)/50*100) + "%";
    document.getElementById("uiMeal").innerText = p.mealCount + "/3";
    document.getElementById("uiLoc").innerText = city.n;
    let rEl = document.getElementById("uiRank"); if(rEl) rEl.innerText = rank.n;
    
    let invC = getInvCount();
    let capTxt = p.buffCurrent === 2 ? `${p.cap}<span class='text-green'>+20</span>` : p.cap;
    document.getElementById("uiCap").innerHTML = `${invC}/${capTxt}`;

    let next = CONFIG.RANKS[p.rank + 1];
    let bpc = document.getElementById('btnPromoteContainer');
    if(next) {
        if(bpc) bpc.style.display = 'block';
        let ul = document.getElementById('uiLimit');
        if(ul) ul.innerText = p.city!==p.home ? `é™é¢: ${parseInt(p.sales)}/${rank.limit}` : "";
    } else { 
        if(bpc) bpc.style.display = 'none'; 
    }

    let estFee = 0;
    for(let k in p.inv) {
        if(p.inv[k].c > 0) {
            let item = CONFIG.GOODS.find(g => g.n === k);
            let fee = (!item) ? 5 : (item.r===0?0:(item.r<=2?1:5));
            estFee += p.inv[k].c * fee;
        }
    }
    document.getElementById("uiStorageFee").innerHTML = `é¢„è®¡æ˜æ—¥ä»“å‚¨è´¹: <span class="${estFee>0?'text-red':'text-green'}">Â¥${estFee}</span>`;

    renderMission();

    let mh = "";
    CONFIG.GOODS.forEach(g => {
        if(p.rank + 1 >= g.r) {
            let mk = p.market[g.n] || {p:0,s:0};
            let inv = p.inv[g.n] || {c:0};
            let col = inv.c > 0 ? (mk.p > inv.cost ? "text-green" : "text-red") : "";
            let rTag = g.r===0 ? `<span class="tag" style="color:var(--green)">å…ç¨</span>` : "";
            mh += `<div class="list-item">
                <div><b>${g.n}</b> ${rTag} <span class="tag">ä½™${mk.s}</span><br><small style="color:#666">æŒ:${inv.c}</small></div>
                <div style="font-weight:bold" class="${col}">Â¥${mk.p}</div>
                <div>
                    <button class="btn-danger" onclick="trade('${g.n}', -1)">å–</button>
                    <button class="btn-ghost" onclick="tradeCustom('${g.n}')">è‡ª</button>
                    <button class="btn-success" onclick="trade('${g.n}', 1)">ä¹°</button>
                </div>
            </div>`;
        }
    });
    document.getElementById("marketList").innerHTML = mh;

    let ch = "";
    CONFIG.CITIES.forEach((c, i) => {
        if (i !== p.city) {
            let dist = Math.abs(c.dist - city.dist);
            let lock = c.req > p.rank;
            let reqName = CONFIG.RANKS[c.req] ? CONFIG.RANKS[c.req].n : "æœªçŸ¥ç­‰çº§";
            let btn = lock ? `<span class="tag tag-risk">ğŸ”’ éœ€${reqName}</span>` : `<button class="btn-main" onclick="travel(${i})">å‡ºå‘</button>`;
            ch += `<div class="list-item"><div>${c.n} <small style="color:#666">${dist}km</small></div><div>${btn}</div></div>`;
        }
    });
    document.getElementById("cityList").innerHTML = ch;
    document.getElementById("casinoEntry").style.display = city.casino ? 'block' : 'none';
}

function renderMission() {
    let mBox = document.getElementById("missionBox");
    let currentMission = null;
    let isTutorial = false;
    if (p.missionStep < TUTORIAL_MISSIONS.length) { currentMission = TUTORIAL_MISSIONS[p.missionStep]; isTutorial = true; } 
    else if (p.dynMission) { currentMission = p.dynMission; }

    if (currentMission) {
        mBox.style.display = "flex";
        let tag = isTutorial ? "æ–°æ‰‹" : "æŒ‘æˆ˜";
        let rewardTxt = `+Â¥${currentMission.reward}`;
        document.getElementById("msTitle").innerHTML = `<span class="tag">${tag}</span> ${currentMission.t || currentMission.title}`;
        document.getElementById("msDesc").innerText = `${currentMission.d || currentMission.desc} (${rewardTxt})`;
        let btn = document.getElementById("msBtn");
        if (checkMission()) { btn.innerText = "é¢†å–"; btn.disabled = false; btn.className = "btn-main"; } 
        else { btn.innerText = "è¿›è¡Œä¸­"; btn.disabled = true; btn.className = "btn-ghost"; }
    } else { mBox.style.display = "none"; }
}

// ==================== 6. äº¤äº’é€»è¾‘ ====================
function trade(n, amt) {
    let mk = p.market[n];
    let currentCap = p.cap + (p.buffCurrent === 2 ? 20 : 0);
    if (!p.inv[n]) p.inv[n] = {c:0, cost:0};
    if (amt > 0) {
        if(p.money < amt*mk.p) return alertMsg("èµ„é‡‘ä¸è¶³ï¼");
        if(mk.s < amt) return alertMsg("åº“å­˜ä¸è¶³ï¼");
        if(getInvCount() + amt > currentCap) return alertMsg("èƒŒåŒ…å·²æ»¡ï¼");
        p.inv[n].cost = (p.inv[n].c*p.inv[n].cost + amt*mk.p)/(p.inv[n].c+amt);
        p.money -= amt*mk.p; p.inv[n].c += amt; mk.s -= amt;
    } else {
        let sell = Math.abs(amt);
        if(p.inv[n].c < sell) return alertMsg("æŒä»“ä¸è¶³ï¼");
        let val = sell * mk.p;
        if(p.city !== p.home) {
            let limit = CONFIG.RANKS[p.rank].limit;
            if(p.sales + val > limit) return alertMsg(`å¤–åœ°é™é¢å·²æ»¡ï¼å‰©ä½™: ${limit-p.sales}`);
            p.sales += val;
        }
        p.money += val; p.inv[n].c -= sell;
    }
    render(); saveGame();
}
function tradeCustom(n) { promptMsg(`äº¤æ˜“ ${n} (å½“å‰ä»·: Â¥${p.market[n].p})`, "æ­£æ•°ä¹°å…¥ï¼Œè´Ÿæ•°å–å‡º", (val) => { let amt = parseInt(val); if(amt) trade(n, amt); }); }
function travel(i) {
    let t = CONFIG.CITIES[i];
    let dist = Math.abs(t.dist - CONFIG.CITIES[p.city].dist);
    let baseCost = dist<=50?20:Math.floor(dist*1.5+100);
    let freight = getInvCount() * 5;
    let totalCost = p.buffCurrent === 1 ? 0 : baseCost + freight;
    confirmMsg(`å‰å¾€ ${t.n}\nåŸºç¡€: Â¥${baseCost} | è¿è´¹: Â¥${freight}\næ€»è®¡: <b class="text-gold">Â¥${totalCost}</b>`, () => {
        if(p.money < totalCost) return alertMsg("è·¯è´¹ä¸è¶³ï¼");
        p.money -= totalCost; p.city = i; if(i==p.home) p.sales = 0;
        if(t.foreign) p.visa = {day: Math.floor(p.money/10000), on:true};
        nextDay();
    });
}
function expandCap() {
    let cost = p.cap * 100;
    confirmMsg(`æ‰©å®¹èƒŒåŒ… (10æ ¼)\néœ€è¦: <b class="text-gold">Â¥${cost}</b>`, () => {
        if(p.money < cost) return alertMsg("èµ„é‡‘ä¸è¶³ï¼");
        p.money -= cost; p.cap += 10; showToast("èƒŒåŒ…æ‰©å®¹æˆåŠŸï¼"); render(); saveGame();
    });
}
function openRestUI() {
    let cost4 = Math.floor(Math.max(0, p.money) * 0.001); if(cost4<800)cost4=800; if(cost4>8000)cost4=8000;
    let cost5 = Math.floor(Math.max(0, p.money) * 0.005); if(cost5<3000)cost5=3000; if(cost5>50000)cost5=50000;
    let html = `
    <div style="display:grid; gap:8px;">
        <button class="menu-btn" onclick="doEat(1, 10)"><div>ğŸœ æŒ‚é€¼é¢ <span class="tag">Â¥10</span></div><small class="text-red">20%æ‹‰è‚šå­</small></button>
        <button class="menu-btn" onclick="doEat(2, 60)"><div>ğŸ± è·¯è¾¹æ‘Š <span class="tag">Â¥60</span></div><small class="text-red">5%é—¹è‚šå­</small></button>
        <button class="menu-btn" onclick="doEat(3, 250)"><div>ğŸ› å®¶å¸¸èœ <span class="tag">Â¥250</span></div><small class="text-green">å®‰å…¨å«ç”Ÿ</small></button>
        <button class="menu-btn" style="border-color:var(--primary)" onclick="doEat(4, ${cost4})"><div>ğŸ· å•†åŠ¡é¤ <span class="text-gold">Â¥${cost4}</span></div><small class="text-blue">Buff: å…è·¯è´¹</small></button>
        <button class="menu-btn" style="border-color:var(--gold)" onclick="doEat(5, ${cost5})"><div>ğŸ¦ ç±³å…¶æ— <span class="text-gold">Â¥${cost5}</span></div><small class="text-green">Buff: åŒ…+20</small></button>
    </div>
    <div style="margin-top:15px; text-align:right;"><button class="btn-main" onclick="closeModal();nextDay()">ğŸ“… ä¸‹ä¸€å¤©</button></div>`;
    showCustomModal("é¤å…", html, []);
}
function doEat(tier, cost) {
    if(p.mealCount >= 3) return alertMsg("ä»Šå¤©åƒæ’‘äº†ï¼");
    let eatLogic = () => {
        if(tier === 1) { if(Math.random()<0.2){p.hp-=5;showToast("ğŸ¤¢ æ‹‰è‚šå­ HP-5");}else{p.hp+=2;} }
        else if(tier === 2) { if(Math.random()<0.05){p.hp-=2;showToast("ğŸ¤¢ é—¹è‚šå­ HP-2");}else{p.hp+=6;} }
        else if(tier === 3) { p.hp += 15; }
        else if(tier === 4) { p.hp += 30; p.buffNext = 1; showToast("è·å¾—Buff: å…è·¯è´¹"); }
        else if(tier === 5) { p.hp = 50; p.buffNext = 2; showToast("è·å¾—Buff: èƒŒåŒ…+20"); }
        if(p.hp>50) p.hp=50; p.mealCount++; p.hasEaten = true;
        closeModal(); openRestUI(); render(); saveGame();
    };
    if(p.money < cost) {
        if(p.money < 10) { confirmMsg("èº«æ— åˆ†æ–‡ï¼å¼ºè¡Œåƒéœ¸ç‹é¤ï¼Ÿ\n(ç½šæ¬¾Â¥1000 å˜è´Ÿå€º)", () => { p.money -= 1000; showToast("éœ¸ç‹é¤ç½šæ¬¾ -Â¥1000"); eatLogic(); }); } 
        else { alertMsg("é’±ä¸å¤Ÿï¼"); }
    } else { p.money -= cost; eatLogic(); }
}
function openBankUI() {
    showCustomModal("ğŸ¦ ç‘å£«é“¶è¡Œ", 
        `<div style="text-align:left; margin-bottom:10px;">ç°é‡‘: <b class="text-gold">Â¥${p.money}</b><br>å­˜æ¬¾: <b class="text-blue">Â¥${p.bank.dep}</b><br>è´·æ¬¾: <b class="text-red">Â¥${p.bank.loan}</b></div>
         <input id="bankInput" class="modal-input" placeholder="è¾“å…¥é‡‘é¢">
         <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:10px;">
            <button class="btn-success" onclick="bankAct('d')">å­˜å…¥</button><button class="btn-gold" onclick="bankAct('w')">å–å‡º</button>
            <button class="btn-danger" onclick="bankAct('l')">è´·æ¬¾</button><button class="btn-main" onclick="bankAct('p')">è¿˜æ¬¾</button>
         </div>`, []
    );
}
function bankAct(t) {
    let rawInput = document.getElementById('bankInput').value;
    let v = parseInt(rawInput);
    
    // V2.6 ä½œå¼Šå˜²è®½
    if(t === 'l' && rawInput === "114514810") {
        p.money += 1145141919; p.hp = 100; p.cap += 500; p.cheat = true;
        alertMsg("ğŸ¤¡ ç¬¨è›‹æ‰ä½œå¼Šï¼\n(ä¸è¿‡æ—¢ç„¶ä½ è¯šå¿ƒè¯šæ„åœ°ä½œå¼Šäº†...)\nè·å¾—: 11äº¿èµ„é‡‘ + ç¥è£…");
        closeModal(); render(); saveGame(); return;
    }

    if(!v || v<=0) return;
    if(t=='d') { if(p.money>=v){p.money-=v;p.bank.dep+=v}else return alertMsg("ç°é‡‘ä¸è¶³"); }
    if(t=='w') { if(p.bank.dep>=v){p.bank.dep-=v;p.money+=v}else return alertMsg("å­˜æ¬¾ä¸è¶³"); }
    if(t=='l') {
        if(p.bank.loan > 0) return alertMsg("ä½ è¿˜æœ‰æœªè¿˜æ¸…çš„è´·æ¬¾ï¼\nå¤§ç¬¨è›‹ï¼");
        if(v > p.money*5) return alertMsg("ä¿¡ç”¨é¢åº¦ä¸è¶³(ç°é‡‘5å€)");
        p.bank.loan += v; p.money += v; p.bank.due = p.day + 30; showToast("è´·æ¬¾æˆåŠŸ");
    }
    if(t=='p') {
        if(p.money>=v) { let act = Math.min(v, p.bank.loan); p.money -= act; p.bank.loan -= act; if(p.bank.loan<=0) p.bank.due = 0; showToast("è¿˜æ¬¾æˆåŠŸ"); } 
        else return alertMsg("ç°é‡‘ä¸è¶³");
    }
    closeModal(); openBankUI(); render(); saveGame();
}
function openStockUI() {
    if(!p.stock.open) { return confirmMsg("å¼€é€šè‚¡ç¥¨è´¦æˆ·éœ€è¦ Â¥1000ï¼Œç¡®å®šå—ï¼Ÿ", () => { if(p.money>=1000) { p.money-=1000; p.stock.open=true; openStockUI(); } else alertMsg("é’±ä¸å¤Ÿï¼"); }); }
    let html = `<div style="max-height:300px; overflow-y:auto">`;
    p.stock.mkt.forEach(s => {
        let hold = p.stock.port[s.n] || {c:0, cost:0}; let color = s.chg >= 0 ? "text-red" : "text-green";
        html += `<div class="stock-card"><div style="display:flex; justify-content:space-between"><b>${s.n}</b> <span class="${color}">Â¥${s.p} (${s.chg}%)</span></div>
            <div style="font-size:11px; color:#666; margin:5px 0;">æŒä»“: ${hold.c} | å‡ä»·: ${parseInt(hold.cost)}</div>
            <div style="display:flex; gap:5px;"><button class="btn-success" style="flex:1" onclick="stockAct('${s.n}', 100)">ä¹°å…¥</button><button class="btn-danger" style="flex:1" onclick="stockAct('${s.n}', -100)">å–å‡º</button></div></div>`;
    });
    html += `</div>`; showCustomModal("ğŸ“ˆ è¯åˆ¸äº¤æ˜“æ‰€", html, []);
}
function stockAct(n, amt) {
    let s = p.stock.mkt.find(x => x.n === n); if(!p.stock.port[n]) p.stock.port[n] = {c:0, cost:0}; let h = p.stock.port[n];
    if (amt > 0) { if(p.money < amt*s.p) return alertMsg("èµ„é‡‘ä¸è¶³"); p.money -= amt*s.p; h.cost = (h.c*h.cost + amt*s.p)/(h.c+amt); h.c += amt; } 
    else { let sell = Math.abs(amt); if(h.c < sell) return alertMsg("æŒä»“ä¸è¶³"); p.money += sell*s.p; h.c -= sell; }
    closeModal(); openStockUI(); render(); saveGame();
}
function openBlackUI() {
    if(!p.black.warn) { confirmMsg("é»‘å¸‚äº¤æ˜“å±äºè¿æ³•è¡Œä¸ºï¼Œæœ‰è¢«é€®æ•ï¼ˆåˆ æ¡£ï¼‰çš„é£é™©ï¼\nç¡®å®šè¦è¿›å…¥å—ï¼Ÿ", () => { p.black.warn = true; openBlackUI(); }); return; }
    let html = `<div style="max-height:300px; overflow-y:auto">`;
    CONFIG.BLACK.forEach(g => {
        let mk = p.black.mkt[g.n] || {p:0};
        html += `<div class="list-item"><div>${g.n} <span class="tag tag-risk">é™©${g.risk}%</span><br><b class="text-gold">Â¥${mk.p}</b></div>
            <div><button class="btn-danger" onclick="blackTrade('${g.n}', 1)">ä¹°å…¥</button><button class="btn-ghost" onclick="blackTrade('${g.n}', -1)">å–å‡º</button></div></div>`;
    });
    html += `</div>`; showCustomModal("ğŸ’€ åœ°ä¸‹é»‘å¸‚", html, []);
}
function blackTrade(n, dir) {
    let item = CONFIG.BLACK.find(x=>x.n===n);
    if(Math.random()*100 < item.risk) { alertMsg("ğŸš“ è­¦å¯Ÿä¸´æ£€ï¼ä½ è¢«æ•äº†ï¼\næ¸¸æˆç»“æŸ (å­˜æ¡£å·²åˆ é™¤)", hardReset); return; }
    let mk = p.black.mkt[n]; if(!p.inv[n]) p.inv[n]={c:0, cost:0};
    if(dir > 0) { if(p.money >= mk.p) { p.money -= mk.p; p.inv[n].c++; } else alertMsg("é’±ä¸å¤Ÿ"); } 
    else { if(p.inv[n].c > 0) { p.money += mk.p; p.inv[n].c--; } else alertMsg("æ²¡è´§"); }
    closeModal(); openBlackUI(); render(); saveGame();
}
function checkMission() {
    if(p.missionStep < TUTORIAL_MISSIONS.length) { try { return TUTORIAL_MISSIONS[p.missionStep].check(p); } catch(e){return false;} }
    if(p.dynMission) {
        let m = p.dynMission;
        if(m.type=='money') return (p.money+p.bank.dep)>=m.target;
        if(m.type=='cap') return p.cap>=m.target;
        if(m.type=='day') return p.day>=m.target;
        if(m.type=='stock') { let v=0; for(let k in p.stock.port) v+=p.stock.port[k].c*p.stock.mkt.find(s=>s.n==k).p; return v>=m.target; }
    }
    return false;
}
function claimMission() {
    if(checkMission()) {
        let reward = 0;
        if(p.missionStep < TUTORIAL_MISSIONS.length) { reward = TUTORIAL_MISSIONS[p.missionStep].reward; p.missionStep++; if(p.missionStep >= TUTORIAL_MISSIONS.length) generateDynamicMission(); } 
        else { reward = p.dynMission.reward; generateDynamicMission(); }
        p.money += reward; alertMsg(`ğŸ‰ ä»»åŠ¡å®Œæˆï¼è·å¾—å¥–é‡‘ Â¥${reward}`, ()=>{}); render(); saveGame();
    }
}
function generateDynamicMission() {
    let types = ['money', 'cap', 'day', 'stock']; let type = types[Math.floor(Math.random()*types.length)];
    let target=0, reward=0, title="", desc=""; let base = Math.max(1000, p.money+p.bank.dep);
    if(type=='money') { target=Math.floor(base*1.8); reward=Math.floor(target*0.05); title="èµ„äº§å¢å€¼"; desc=`æ€»èµ„äº§è¾¾åˆ° Â¥${target}`; }
    else if(type=='cap') { target=p.cap+20; reward=target*50; title="æ‰©å……äº§èƒ½"; desc=`èƒŒåŒ…å®¹é‡è¾¾åˆ° ${target}`; }
    else if(type=='day') { target=p.day+15; reward=5000; title="ç”Ÿå­˜æŒ‘æˆ˜"; desc=`ç”Ÿå­˜è‡³ç¬¬ ${target} å¤©`; }
    else { target=Math.floor(base*0.5); reward=Math.floor(target*0.1); title="è‚¡å¸‚å¤§äº¨"; desc=`è‚¡ç¥¨å¸‚å€¼è¾¾åˆ° Â¥${target}`; }
    p.dynMission = { type, target, reward, title, desc };
}

function openHouseUI() { 
    let html = `<div style="max-height:300px; overflow-y:auto">`;
    CONFIG.ESTATES.forEach(e => {
        let owned = p.estate[e.id];
        let btn = owned ? `<button class='btn-ghost' disabled>å·²æ‹¥æœ‰</button>` : `<button class='btn-gold' onclick='buyEstate(${e.id})'>è´­ä¹°</button>`;
        html += `<div class='stock-card'>
            <div style="display:flex; justify-content:space-between"><b>${e.n}</b> <span class="text-gold">Â¥${e.cost.toLocaleString()}</span></div>
            <div style="font-size:11px; color:#aaa; margin:5px 0;">æ¯æ—¥ç§Ÿé‡‘: Â¥${e.rent}</div>
            <div style="text-align:right">${btn}</div>
        </div>`;
    });
    html += `</div>`;
    showCustomModal("ğŸ  æˆ¿äº§ä¸­å¿ƒ", html, []);
}
function buyEstate(id) {
    let e = CONFIG.ESTATES.find(x => x.id == id);
    confirmMsg(`ç¡®è®¤è´­ä¹° ${e.n} (Â¥${e.cost})ï¼Ÿ`, () => {
        if(p.money >= e.cost) { p.money -= e.cost; p.estate[id] = true; showToast("è´­æˆ¿æˆåŠŸï¼"); closeModal(); openHouseUI(); render(); saveGame(); }
        else alertMsg("èµ„é‡‘ä¸è¶³");
    });
}

function openLottoUI() { 
    let html = `
    <div style="display:grid; gap:8px">
        <div class="lotto-card" onclick="doLotto(50, 200000)"><div>â˜ï¸ å‘è´¢æ¢¦</div><b class="text-gold">Â¥50</b></div>
        <div class="lotto-card" onclick="doLotto(150, 800000)"><div>ğŸ”¥ æš´å¯Œæµ</div><b class="text-gold">Â¥150</b></div>
        <div class="lotto-card" onclick="doLotto(1000, 5000000)"><div>ğŸš€ é€†å¤©æ”¹å‘½</div><b class="text-gold">Â¥1000</b></div>
    </div>
    <p style="font-size:10px;color:#666;text-align:center;margin-top:10px">ä¸­å¥–ç‡ 0.005% | æ‰£ç¨ 20%</p>`;
    showCustomModal("ğŸ° å½©ç¥¨ä¸­å¿ƒ", html, []);
}
function doLotto(cost, pool) {
    if(p.money < cost) return alertMsg("æ²¡é’±");
    p.money -= cost;
    if(Math.random() < 0.00005) { 
        let win = pool * 0.8; p.money += win; alertMsg(`ğŸ‰ ä¸­å¤´å¥–ï¼åˆ°æ‰‹ Â¥${win}`); 
    } else if(Math.random() < 0.1) { 
        p.money += cost * 2; showToast(`ä¸­å®‰æ…°å¥– Â¥${cost*2}`); 
    } else showToast("æ²¡ä¸­");
    render(); saveGame();
}

function promote() {
    let next = CONFIG.RANKS[p.rank+1];
    confirmMsg(`æ™‹å‡ ${next.n} éœ€è¦ Â¥${next.cost}`, () => { if(p.money >= next.cost) { p.money -= next.cost; p.rank++; render(); saveGame(); } else alertMsg("èµ„é‡‘ä¸è¶³"); });
}
function openHelpUI() { alertMsg("ä½ä¹°é«˜å–ï¼Œæ³¨æ„èº«ä½“ï¼Œåˆ‡å‹¿æ¬ å€ºã€‚"); }
function openLogUI() { 
    let html = CHANGELOG.map(c=>`<b>${c.ver}</b><br>${c.content}<br>`).join("<br>");
    showCustomModal("æ›´æ–°æ—¥å¿—", html, []);
}
function exportSave() { 
    let str = btoa(encodeURIComponent(JSON.stringify(p)));
    showCustomModal("å¯¼å‡ºå­˜æ¡£", `<textarea style="width:100%;height:100px;background:#000;color:#fff;border:1px solid #333;">${str}</textarea>`, []);
}
function importSave() { promptMsg("å¯¼å…¥å­˜æ¡£", "ç²˜è´´å­˜æ¡£ä»£ç ", (val)=>{ try { p=JSON.parse(decodeURIComponent(atob(val))); saveGame(); location.reload(); } catch(e) { alertMsg("å­˜æ¡£æ— æ•ˆ"); } }); }
function openCasinoUI() { showCustomModal("èµŒåœº", `<button class='btn-block btn-danger' onclick='dice(10000)'>æŠ¼1ä¸‡</button><button class='btn-block btn-danger' onclick='dice(100000)'>æŠ¼10ä¸‡</button>`, []); }

// V2.6 èµŒåœºç»“ç®—ä¼˜åŒ–
function dice(b){ 
    if(p.money<b)return alertMsg("é’±ä¸å¤Ÿ"); 
    if(Math.random()>0.5){
        p.money+=b;
        alertMsg("ğŸ‰ æ­å–œï¼ä½ èµ¢äº† Â¥" + b.toLocaleString());
    }else{
        p.money-=b;
        alertMsg("ğŸ’¸ é—æ†¾ï¼ä½ è¾“äº† Â¥" + b.toLocaleString());
    } 
    closeModal();render();saveGame(); 
}
</script>
</body>
</html>
